<html>
<head>
<title>Bringing Prometheus Metrics and Grafana Dashboard for Cost Allocation on Kubernetes Clusters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes集群上引入Prometheus Metrics和Grafana Dashboard进行成本分配</h1>
<blockquote>原文：<a href="https://medium.com/swlh/bringing-prometheus-metrics-and-grafana-dashboard-for-cost-allocation-on-kubernetes-clusters-1ee7f68cd677?source=collection_archive---------4-----------------------#2019-06-30">https://medium.com/swlh/bringing-prometheus-metrics-and-grafana-dashboard-for-cost-allocation-on-kubernetes-clusters-1ee7f68cd677?source=collection_archive---------4-----------------------#2019-06-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="a69e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个故事介绍了一个Prometheus Exporter和一个Grafana仪表板，旨在为Kubernetes集群提供面向成本的整合资源使用分析。这些分析实际上旨在强调事实指标，以帮助组织轻松做出短期、中期和长期的成本分配和容量规划决策。</p><blockquote class="jd je jf"><p id="3faa" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated"><strong class="ih jk">旁注:</strong>读者可能也会对另一个<a class="ae jl" rel="noopener" href="/@rodrigue.chakode/kubernetes-resource-usage-analytics-for-cost-allocation-and-capacity-planning-416800e85d16">的故事</a>感兴趣，它与当前的故事相关，但又独立。</p></blockquote><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es jm"><img src="../Images/c03e3a7a7511ed95d961b7c86ea6d1c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7rbOREwIUTJVnvpLImruUA.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">A Grafana Screenshot of the Hereafter-described Analytics Dashboard for Kubernetes Cost Allocation and Capacity Planning</figcaption></figure><h1 id="c084" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">介绍</h1><p id="599b" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">几个月前<a class="ae jl" href="https://github.com/rchakode/kube-opex-analytics" rel="noopener ugc nofollow" target="_blank"> Kubernetes Opex Analytics </a>作为一款原创的开源资源使用分析工具推出，使Kubernetes集群的成本分摊和容量规划决策变得更加容易。根据Apache 2.0许可条款发布，该工具带有内置的分析图表，涵盖各种用例。它收到了很多用户反馈，有些人要求能够将其指标暴露给现有的Prometheus环境。</p><p id="9707" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在0.3.0版本中已经引入了一个普罗米修斯出口器，所以在这个故事中，我很乐意介绍和描述它。这伴随着一个集成的Grafana仪表板，让用户很容易开始。所有这些都是对原生Kubernetes Opex分析功能和仪表板的补充。</p><h2 id="b004" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">接下来将涵盖哪些内容</h2><p id="6646" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">该故事将详细介绍暴露的指标，并提供步骤来设置出口商和所提供的Grafana仪表板。在此之前，我们将为不熟悉Kubernetes Opex Analytics的读者回顾其核心功能。</p><blockquote class="jd je jf"><p id="43f7" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">如果您已经熟悉Kubernetes Opex Analytics的概念，您可以跳过下一部分继续。</p></blockquote><h1 id="f4f5" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">Kubernetes运营支出分析概述</h1><p id="6a7f" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">Kubernetes Opex Analytics基于以下核心概念设计:</p><ul class=""><li id="0d50" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated"><strong class="ih jk">以名称空间为中心的</strong>:意味着整合的资源使用指标将单个名称空间视为资源共享的基本单元。还特别注意考虑和突出显示<code class="du mc md me mf b">non-allocatable resources</code>。</li><li id="bd56" class="lt lu hi ih b ii mg im mh iq mi iu mj iy mk jc ly lz ma mb bi translated"><strong class="ih jk">每小时使用量&amp;趋势</strong>:像在公共云上一样，每个名称空间的资源使用以每小时为基础进行整合。这实际上对应于每小时每个名称空间使用的资源比率(<code class="du mc md me mf b">%</code>)。它是成本计算的基础，还允许获得每个名称空间和Kubernetes集群规模的资源消耗的时间趋势。</li><li id="c5e6" class="lt lu hi ih b ii mg im mh iq mi iu mj iy mk jc ly lz ma mb bi translated"><strong class="ih jk">每日和每月使用成本:</strong>提供每个周期(每日/每月)、名称空间和资源类型(CPU/内存)，<em class="jg">综合成本</em>以下列方式之一计算:<em class="jg"> (i) </em>该周期内累计的每小时使用量；<em class="jg"> (ii) </em>基于资源使用和给定的每小时计费率计算的实际成本；<em class="jg"> (iii) </em>每个名称空间的使用情况与全局集群使用情况的标准化比率。</li><li id="dc8b" class="lt lu hi ih b ii mg im mh iq mi iu mj iy mk jc ly lz ma mb bi translated"><strong class="ih jk">高效可视化:</strong>对于其生成的指标，Kubernetes Opex Analytics提供了仪表板，其中包含相关图表，以及过去12个月(即一年)的最后几个小时，如下所示。</li></ul><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es ml"><img src="../Images/7568e47c42922644fe1c6c524da4b567.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cGfFeGTUezdDmo7_zGBEtg.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Kubernetes Opex Analytics — Screenshot of the Built-in Dashboard</figcaption></figure><h1 id="7dd0" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">安装Kubernetes运营支出分析</h1><p id="8525" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">接下来，我们假设安装将在Kubernetes集群上完成，因为您也可以在Docker上安装它，如这里的<a class="ae jl" href="https://github.com/rchakode/kube-opex-analytics#start-koa-on-docker" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><p id="9a8e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">有一个<a class="ae jl" href="https://github.com/rchakode/kube-opex-analytics/tree/master/helm/kube-opex-analytics" rel="noopener ugc nofollow" target="_blank">头盔图</a>可以通过使用头盔<code class="du mc md me mf b">Tiller</code>或<code class="du mc md me mf b">kubectl</code>来简化Kubernetes上的部署。</p><p id="abf4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这两种情况下，检查<code class="du mc md me mf b">values.yaml</code>文件，根据您的需要修改配置选项(例如，为数据存储提供永久卷)。</p><p id="a63e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du mc md me mf b">Helm Tiller</code>:</p><pre class="jn jo jp jq fd mm mf mn mo aw mp bi"><span id="4e25" class="lf kd hi mf b fi mq mr l ms mt">helm upgrade \<br/>  --install kube-opex-analytics \<br/>  helm/kube-opex-analytics/</span></pre><p id="91a6" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用<code class="du mc md me mf b">kubectl</code>:</p><pre class="jn jo jp jq fd mm mf mn mo aw mp bi"><span id="8bfd" class="lf kd hi mf b fi mq mr l ms mt">helm template \<br/>  --name kube-opex-analytics \<br/>  helm/kube-opex-analytics/ | kubectl apply -f -</span></pre><blockquote class="jd je jf"><p id="b1f3" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">这将通过端口<code class="du mc md me mf b">80</code>上名为<code class="du mc md me mf b">kube-opex-analytics</code>的HTTP服务启用内置的仪表板。</p></blockquote><h1 id="f15b" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">普罗米修斯出口商</h1><p id="ddf1" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">通过<code class="du mc md me mf b">/metrics</code>端点公开Prometheus的指标。</p><h2 id="f57b" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">公开的指标</h2><p id="d038" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">如下图示例所示，公开的指标如下:</p><ul class=""><li id="c25a" class="lt lu hi ih b ii ij im in iq lv iu lw iy lx jc ly lz ma mb bi translated"><code class="du mc md me mf b">koa_namespace_hourly_usage</code>:显示每个名称空间当前每小时的CPU和内存资源使用情况。</li><li id="baab" class="lt lu hi ih b ii mg im mh iq mi iu mj iy mk jc ly lz ma mb bi translated"><code class="du mc md me mf b">koa_namespace_daily_usage</code>:显示每个名称空间在当天的CPU和内存的当前资源使用情况。</li><li id="9b0e" class="lt lu hi ih b ii mg im mh iq mi iu mj iy mk jc ly lz ma mb bi translated"><code class="du mc md me mf b">koa_namespace_monthly_usage</code>:显示每个名称空间和当月的当前CPU和内存资源使用情况。</li></ul><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mu"><img src="../Images/4a3fbc3d6b8f0540da8e66726667c4f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*obCxbKRH3j_i4Wf4zvgD8Q.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Kubernetes Opex Analytics — Sample of Metrics Exposed for Prometheus</figcaption></figure><h2 id="d80b" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">普罗米修斯<strong class="ak">刮掉</strong>的工作</h2><p id="459d" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">该作业可以配置如下。小于5分钟的时间间隔(即<code class="du mc md me mf b">300s</code>)是无用的，因为在此期间不会生成新的指标。</p><pre class="jn jo jp jq fd mm mf mn mo aw mp bi"><span id="f5fb" class="lf kd hi mf b fi mq mr l ms mt">scrape_configs:<br/>  - job_name: 'kube-opex-analytics'<br/>    scrape_interval: 300s<br/>    static_configs:<br/>      - targets: ['kube-opex-analytics:80']</span></pre><blockquote class="jd je jf"><p id="637a" class="if ig jg ih b ii ij ik il im in io ip jh ir is it ji iv iw ix jj iz ja jb jc hb bi translated">回想一下，Kubernetes Opex Analytics使用每小时整合的指标，因此您可能需要至少等待一个小时才能获得所有指标。</p></blockquote><h1 id="511a" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">Grafana仪表板</h1><p id="c881" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">一旦Prometheus中的指标可用，获取<a class="ae jl" href="https://grafana.com/dashboards/10282" rel="noopener ugc nofollow" target="_blank">这个Grafana仪表板</a>，并将其导入Grafana。仪表板依赖于一个变量<code class="du mc md me mf b">KOA_DS_PROMETHEUS</code>，该变量将指向您的普罗米修斯数据源。</p><p id="1f55" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">正确配置后，仪表板将立即显示图表，如下所述。</p><h2 id="fb59" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">每小时使用量</h2><p id="b380" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">有两个面板分别显示所选时间间隔(默认为7天)内CPU(左)和内存(右)的使用情况图表。不同命名空间的系列是堆叠的。这使得比较使用情况变得容易，也有助于显示集群的负载情况。在下面的示例中，我们可以看到在过去5天中，全局CPU和内存使用率达到了90%以上。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mv"><img src="../Images/ec92b8202e318daacef84ae1023214f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5bKOYCGVnlizBFeFEZMWRg.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Kubernetes Opex Analytics — Hourly Resource Usage</figcaption></figure><h2 id="4ab8" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">当天的使用情况</h2><p id="2e45" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">这两个面板分别显示当天CPU(左)和内存(右)的成本图表。使用本故事前面描述的成本算法来计算价值。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mw"><img src="../Images/31888931af4e97e7c60426c973c14a03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PSEQP-oQ5MoqGt97RDIQag.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Kubernetes Opex Analytics — Current’s Day Resource Usage</figcaption></figure><h2 id="5a75" class="lf kd hi bd ke lg lh li ki lj lk ll km iq lm ln kq iu lo lp ku iy lq lr ky ls bi translated">本月的使用情况</h2><p id="3c2e" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated"><strong class="ih jk"> </strong>下方的两个面板分别显示当月CPU(左)和内存(右)的成本图表。使用本故事前面描述的成本算法计算的值。</p><figure class="jn jo jp jq fd jr er es paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="er es mx"><img src="../Images/abef0581209ef335a0c769007775c788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mU0qKLMq8iIQ1gnl_6jPgg.png"/></div></div><figcaption class="jy jz et er es ka kb bd b be z dx">Kubernetes Opex Analytics — Current’s Month Resource Usage</figcaption></figure><h1 id="3be9" class="kc kd hi bd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz bi translated">前进</h1><p id="cd4a" class="pw-post-body-paragraph if ig hi ih b ii la ik il im lb io ip iq lc is it iu ld iw ix iy le ja jb jc hb bi translated">简而言之，我们在这个故事中介绍了一个Prometheus出口商以及一个用于Kubernetes Opex Analytics的Grafana仪表盘。</p><p id="2ffb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可能已经注意到，所描述的Grafana仪表盘的图表不如Kubernetes Opex Analytics的内置仪表盘丰富。例如，每日和每月的使用分别限于当天和当月。这使得很难将当前的使用情况与以前的进行比较。<a class="ae jl" href="https://community.grafana.com/t/display-stacked-series/3402/15" rel="noopener ugc nofollow" target="_blank">这些是Grafana处理基于系列名称的条形图的固有限制</a>。因此，当前的实现还有进一步改进的空间，非常感谢大家的贡献。</p><p id="7997" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我想提醒一下，Kubernetes Opex Analytics是开源的，它是一个开放贡献的项目。我们总是很高兴在<a class="ae jl" href="https://github.com/rchakode/kube-opex-analytics" rel="noopener ugc nofollow" target="_blank"> Github </a>上收到反馈和贡献:如果您遇到问题或有一些改进的想法，请提交问题；提出拉取请求；或者给个星。</p><p id="a3bc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">尽情享受吧！</p></div></div>    
</body>
</html>