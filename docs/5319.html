<html>
<head>
<title>Adding and Updating data in csv file via Flask API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过Flask API在csv文件中添加和更新数据</h1>
<blockquote>原文：<a href="https://medium.com/swlh/adding-and-updating-data-in-csv-file-via-flask-api-252babbc6381#2019-06-10">https://medium.com/swlh/adding-and-updating-data-in-csv-file-via-flask-api-252babbc6381#2019-06-10</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/09a6d71be0239a9b77bea7794347f812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k3d1ELPAUNsnAqon2mnWzQ.png"/></div></div></figure><p id="834e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文将带您了解如何通过flask API在csv文件中添加和更新数据。我在做构建推荐系统的小组项目时经历过这种情况，我必须在csv文件中添加和更新用户对特定事件的评级。这样做是为了确保使用用户的最新评级来推荐事件。(系统每24小时训练一次)。</p><p id="4a8a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我采取了以下步骤来创建上面提到的API</p><ol class=""><li id="ad13" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用anaconda navigator创建一个anaconda虚拟环境，并安装flask(没有anaconda也可以，我在我的项目中使用了Anaconda)。</li></ol><p id="c576" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在开始之前，应该安装anaconda。访问anaconda网站并按照给出的指南进行安装。之后，打开anaconda navigator并从边栏中选择environments。然后点击底部的create创建一个新的环境并命名。(我把它命名为RecSys)。选择python的最新版本，然后单击确定。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es jy"><img src="../Images/79d9768c41058f3d08532df8b60682b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GdT7BgJ5Rhh2oUTBEOPx3g.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx">anaconda navigator</figcaption></figure><p id="9fa7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">选择新环境(刚刚创建)。绿色的play徽标将出现在RecSys环境中，表示这是当前激活的虚拟环境。</p><p id="54a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，单击绿色的播放按钮，并在单击按钮时出现的下拉列表中选择打开终端。将出现conda终端。(在终端中，RecSys将出现在括号中，这表示终端在当前虚拟环境中是打开的，后跟一个路径)。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div class="er es kh"><img src="../Images/34618b1aa70af0b9d0e33e7a5eefe3b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1278/format:webp/1*XCmgu6ERKvr_BhxgiiBSqA.png"/></div><figcaption class="kd ke et er es kf kg bd b be z dx">conda terminal</figcaption></figure><p id="0255" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后键入以下命令分别安装flask和pandas(用于添加和更新的模块)。</p><pre class="jz ka kb kc fd ki kj kk kl aw km bi"><span id="2a4c" class="kn ko hi kj b fi kp kq l kr ks">pip install flask<br/>pip install pandas</span></pre><p id="77c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后关闭终端。</p><p id="88e7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is jx"> 2。用于添加和更新csv文件</strong>中数据的写函数</p><p id="17ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我的项目中，我有一个名为rating.csv的csv文件。它有3列，即用户id，事件id和评级，如下图所示</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kt"><img src="../Images/c0656fb212bae21d31f3e82a855026da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DlJ6IXSdE9KZrGPo95rr2A.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx">An extract of the rating.csv file</figcaption></figure><p id="594e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，在anaconda navigator中移动到home，检查当前环境是否被激活，安装spyder，然后启动它(下图显示了启动原因，我已经安装了它)。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ku"><img src="../Images/1ca2558aa26dcbb9cd9f18cd3aa59034.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5cVsFHxJv9wZB3RWsTDWrw.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx">Home screen in Anaconda navigator</figcaption></figure><p id="e1ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在创建一个python文件并命名(我已经将其命名为Rating.py)。</p><p id="59b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is jx">注意:将csv文件放入Rating.py所在的目录中。</strong></p><p id="46c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将下面的代码复制粘贴到刚刚创建的python文件中并保存。</p><pre class="jz ka kb kc fd ki kj kk kl aw km bi"><span id="83f0" class="kn ko hi kj b fi kp kq l kr ks">import pandas as pd <br/> <br/>def addRate(userId,eventId,rating):</span><span id="0fe4" class="kn ko hi kj b fi kv kq l kr ks"># Creating the first Dataframe using dictionary <br/> isThere = False<br/> <br/># Creating the first Dataframe using dictionary <br/> df1 = pd.read_csv(‘./rating.csv’)<br/> <br/> try:<br/> userInt = int(userId)<br/> eventInt = int(eventId)<br/> ratingInt = int(rating)<br/> print(userInt,eventInt,ratingInt)<br/> <br/> if( 0 &gt; ratingInt or ratingInt &gt; 5):<br/> invalid = “invalid”<br/> return invalid<br/> <br/> except ValueError:<br/> error = “error”<br/> return error<br/> <br/> for index, row in df1.iterrows(): <br/> print(row[‘event-id’], row[‘user-id’]) <br/> if str(row[‘event-id’]) == str(eventId) and str(row[‘user-id’]) == str(userId):<br/> row[‘rating’] = rating<br/> isThere = True</span><span id="622b" class="kn ko hi kj b fi kv kq l kr ks"># Creating the Second Dataframe using dictionary <br/> <br/> if isThere != True: <br/> <br/> df2 = pd.DataFrame({“user-id”:[userId], <br/> “event-id”:[eventId], <br/> “rating”:[rating]}) <br/> <br/> dff = df1.append(df2, ignore_index = True)<br/> dff.to_csv(r’./rating.csv’, index = False)<br/> <br/> add = “added”<br/> return add<br/> <br/> else:<br/> df1.to_csv(r’./rating.csv’, index = False) <br/> update = “updated”<br/> return update</span></pre><p id="9eea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面的代码中，路径指的是来自app.py的数据集文件(rating.csv)的相对路径，我们稍后将创建该文件。(我在相同的目录下创建了app.py，因为路径被称为。/rating . CSV’)。</p><p id="0ce1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is jx">注意:user-id、event-id和rating是rating.csv文件中的列名。</strong></p><p id="db17" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上述代码已经验证了</p><ol class=""><li id="0a51" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">等级在1到5之间。</li><li id="e378" class="jo jp hi is b it kw ix kx jb ky jf kz jj la jn jt ju jv jw bi translated">如果已经有特定用户对特定事件的评级，那么它将更新评级(简单地说，一个用户只能对一个事件评级一次)。</li><li id="260e" class="jo jp hi is b it kw ix kx jb ky jf kz jj la jn jt ju jv jw bi translated">如果发送到API的数据中有任何错误，将显示一条错误消息。</li></ol><p id="14e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3.<strong class="is jx">创建flask API路由并在本地主机中运行Flask API。</strong></p><p id="1caa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，在csv文件和Rating.py文件所在的目录中创建一个名为app.py的文件，复制并粘贴代码</p><pre class="jz ka kb kc fd ki kj kk kl aw km bi"><span id="9030" class="kn ko hi kj b fi kp kq l kr ks">from flask import Flask, request, jsonify<br/>from Rating import addRate</span><span id="11a3" class="kn ko hi kj b fi kv kq l kr ks">app = Flask(__name__)</span><span id="79de" class="kn ko hi kj b fi kv kq l kr ks"><a class="ae lb" href="http://twitter.com/app" rel="noopener ugc nofollow" target="_blank">@app</a>.route(“/rating/add”,methods=[‘POST’])<br/>def addRating():<br/> eventId = request.form[‘eventId’] <br/> userId = request.form[‘userId’]<br/> rating = request.form[‘rating’]<br/> print(userId,” “,eventId,” “,rating)<br/> status = addRate(userId, eventId, rating)<br/> <br/> return status</span><span id="fbf0" class="kn ko hi kj b fi kv kq l kr ks"># Running the server in localhost:5000 <br/>if __name__ == ‘__main__’:<br/> app.run(debug=True, host=’0.0.0.0', port=5000)</span></pre><p id="815e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这段代码接收post方法中的userId、eventId和rating，并调用Rating.py中的addRate方法。</p><p id="966c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们必须运行创建的应用程序。在根据第一条准则打开的终端中键入以下命令(<strong class="is jx">使用anaconda navigator创建一个Anaconda虚拟环境并安装flask </strong>)。</p><pre class="jz ka kb kc fd ki kj kk kl aw km bi"><span id="f467" class="kn ko hi kj b fi kp kq l kr ks">set FLASK_APP=app.py<br/>set FLASK_ENV=development<br/>flask run</span></pre><p id="27e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is jx"> 4。测试一切是否正常</strong></p><p id="fe71" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了测试应用程序，您必须安装Postman(您可以尝试任何HTTP API测试工具，这只是我的偏好)。安装后，启动它并输入我们刚刚创建的flask route的URL，并将请求类型更改为POST。然后点击body，选择x-www-form-urlencoded，输入如下图所示的密钥，然后点击send。您将得到诸如“已添加”、“已更新”、“错误”、“无效”等响应。</p><figure class="jz ka kb kc fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lc"><img src="../Images/3b957e590d3e582a90cab9958bb39afa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Juh-hczP6tQLmlMDjSQpOw.png"/></div></div><figcaption class="kd ke et er es kf kg bd b be z dx">postman GUI for post request</figcaption></figure><p id="8224" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">更改这些值，并测试是否收到预期的输出。</p><p id="f05f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就这样<br/>干杯！！！</p></div></div>    
</body>
</html>