<html>
<head>
<title>I don’t know how CPUs work so I simulated one in code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我不知道CPU是如何工作的，所以我用代码模拟了一个</h1>
<blockquote>原文：<a href="https://medium.com/swlh/i-dont-know-how-cpus-work-so-i-simulated-one-in-code-bd85f216b49?source=collection_archive---------32-----------------------#2019-05-21">https://medium.com/swlh/i-dont-know-how-cpus-work-so-i-simulated-one-in-code-bd85f216b49?source=collection_archive---------32-----------------------#2019-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div class="er es if"><img src="../Images/07bef965808ffc75231027cbbb2fdac3.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/0*bxyTpfY2ORuoKDvu.gif"/></div></figure><p id="f253" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">几个月前，我意识到我并不真正理解计算机是如何工作的。我仍然不明白现代计算机是如何工作的。</p><p id="3eee" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而，在打通<a class="ae jl" href="http://buthowdoitknow.com/" rel="noopener ugc nofollow" target="_blank">之后，<em class="jk">却是怎么知道的呢？J. Clark Scott的《T4》一书描述了一个简单的8位计算机的位，从与非门到寄存器、RAM、CPU位、ALU和I/O，我渴望用代码实现它。</em></a></p><p id="4a22" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然我对电路的物理学并不感兴趣，但这本书只是略述了这些领域的表面，并且在没有必要的电气工程知识的情况下，给出了布线和比特如何在系统中移动的简洁概述。对我来说，虽然我不能适应书本上的描述，但我必须看到实际发生的事情，并从我不可避免的错误中吸取教训，这使我在用代码编写电路的汹涌大海中开辟了一条道路，并对此感到有点伤感。</p><p id="40e1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我这次航行的成果可以在<a class="ae jl" href="https://github.com/djhworld/simple-computer" rel="noopener ugc nofollow" target="_blank">简单电脑</a>中看到；一台简单的计算机，它很简单，可以计算东西。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div class="er es jm"><img src="../Images/b1875653ea37ddd7e0690aacdc8eaa10.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/format:webp/0*6rOklfcqt50-Flpo.png"/></div></figure><figure class="jn jo jp jq fd ij er es paragraph-image"><div class="er es jm"><img src="../Images/ca0bd142e9f6eefccbab622eab456ab2.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/format:webp/0*9jdQlNh6RQzP8897.png"/></div></figure><figure class="jn jo jp jq fd ij er es paragraph-image"><div class="er es jm"><img src="../Images/4a81a462977fdbf245a9b595bc166ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:452/format:webp/0*V_XXUlz8r3KFI6LD.png"/></div></figure><p id="85d4" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这是一个非常巧妙的小东西，CPU代码被实现为<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/cpu/cpu.go#L763" rel="noopener ugc nofollow" target="_blank">打开和关闭</a>的一个可怕的挥霍，但是它工作了，我已经<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/cpu/cpu_test.go" rel="noopener ugc nofollow" target="_blank">单元测试了它</a>，我们都知道单元测试无可辩驳地证明了某些东西工作了。</p><p id="219c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">它处理<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/io/keyboard.go#L20" rel="noopener ugc nofollow" target="_blank">键盘输入</a>，并使用我命名为“Daniel Code Pro”的专业字体的一组精心制作的字形将文本<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/io/display.go#L13" rel="noopener ugc nofollow" target="_blank">呈现给显示器</a>。唯一的欺骗之处是让键盘输入和显示输出工作起来，我必须连接go频道，通过<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/cmd/simulator/glfw_io.go" rel="noopener ugc nofollow" target="_blank"> GLFW </a>与外界通话，但其余的都是模拟电路。</p><p id="f61f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我甚至写了一个<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/asm/assembler.go" rel="noopener ugc nofollow" target="_blank">粗汇编器</a>，至少可以说是令人大开眼界的。它并不完美。实际上这有点废话，但它向我强调了很多很多年前其他人已经解决的问题，我认为我是一个更好的人。或者更糟，取决于你问谁。</p><h2 id="ccbf" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">但是你为什么这么做？</h2><blockquote class="km kn ko"><p id="299e" class="im in jk io b ip iq ir is it iu iv iw kp iy iz ja kq jc jd je kr jg jh ji jj hb bi translated">“我在《我的世界》见过13岁的孩子这样做，等你用电报继电器造出真正的CPU后再来找我”</p></blockquote><p id="989c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我的计算心理模型停留在初级计算机科学教科书中，我在2013年写的游戏模拟器的CPU与今天运行的CPU完全不同。尽管如此，仿真器只是一个状态机，它并不描述逻辑门级别的东西。您可以只使用一个<code class="du ks kt ku kv b">switch</code>语句并存储寄存器的状态来实现它的大部分。</p><p id="c672" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">所以我试图更好地理解这种东西，因为我不知道L1/L2缓存是什么，我不知道流水线是什么意思，我不完全确定我理解Meltdown和Spectre漏洞论文。有人告诉我，他们正在优化他们的代码，以利用CPU缓存，我不知道如何证实这一点，除了相信他们的话。我不太清楚所有x86指令的含义。我不明白人们是如何将工作卸载到GPU或TPU的。我不知道什么是TPU。我不知道如何使用SIMD指令。</p><p id="e442" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">但所有这些都是建立在你需要获得军衔的知识基础上的，所以我不先看地图是到不了那里的。这意味着回到基础，用简单的东西弄脏我的手。书中描述的“斯科特计算机”很简单。就是这个原因。</p><h2 id="2517" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">天哪！它还活着！</h2><p id="d6f3" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">斯科特计算机是一个附在256字节RAM上的8位处理器，所有这些都通过8位系统总线连接。它有4个通用寄存器，可以执行<a class="ae jl" href="https://github.com/djhworld/simple-computer#instructions" rel="noopener ugc nofollow" target="_blank"> 17条机器指令</a>。有人在这里为网络建立了一个视觉模拟器<a class="ae jl" href="http://www.buthowdoitknow.com/but_how_do_it_know_cpu_model.html" rel="noopener ugc nofollow" target="_blank"/>，这真的很酷，我不敢想象跟踪所有的连接状态要花多长时间！</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lb"><img src="../Images/8a1380fa1e561866febed779fc0a49dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*COZz7WKlNJMm9Ny7.png"/></div></div></figure><p id="2a84" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这本书将带你开始一段旅程，从不起眼的与非门，到一点内存，到一个寄存器，然后继续在组件上分层，直到你最终得到类似上面的东西。我真的推荐阅读它，即使你已经熟悉这些概念，因为它是一个很好的概述。不过我不推荐Kindle版本，因为图表有时很难在屏幕上放大和解读。以我的经验来看，这是Kindle的一个老问题。</p><p id="17a0" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我的电脑唯一不同的地方是我将它升级到了16位，以便有更多的内存可供使用，因为即使只存储<a class="ae jl" href="https://github.com/djhworld/simple-computer/blob/master/_programs/ascii.asm#L27" rel="noopener ugc nofollow" target="_blank"> ASCII表</a>的字形也会让书中描述的大多数8位机器相形见绌，没有多少空间留给有用的代码。</p><h2 id="a525" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">我的发展历程</h2><p id="a197" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">在开发过程中，实际上只是阅读文本，浏览图表，然后尝试使用通用编程语言代码进行翻译，当然<em class="jk">不是</em>使用为集成电路开发设计的东西。我之所以用围棋来写，是因为我懂一点围棋。反对者可能会插话说，你这个喋喋不休的白痴！我不敢相信你没有把所有的时间都花在学习<a class="ae jl" href="https://en.wikipedia.org/wiki/VHDL" rel="noopener ugc nofollow" target="_blank"> VHDL </a>或<a class="ae jl" href="https://en.wikipedia.org/wiki/Verilog" rel="noopener ugc nofollow" target="_blank"> Verilog </a>或<a class="ae jl" href="http://www.cburch.com/logisim/" rel="noopener ugc nofollow" target="_blank"> LogSim </a>或其他什么东西上，但是我已经写了我的比特和字节，那时我已经陷得太深了。也许我下一步会学它们，为我浪费的时间哭泣，但那是我要承受的苦难。</p><p id="cb7f" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">总的来说，计算机的大部分工作只是传递一堆布尔，所以任何布尔友好语言都可以完成这项工作。</p><p id="6834" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">将一个模式应用到这些布尔值上有助于你(程序员)理解它的含义，任何人都需要做出的最大决定是决定你的系统将使用什么样的字节顺序，并确保所有组件以正确的顺序在总线上来回传输。</p><p id="ddb7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这绝对是一个难以实现的过程。从偏移量开始，我选择了小尾序，但在测试ALU时，我的头发受到了打击，试图找出为什么数字出来是错误的。许多，许多打印语句都发生在这个上面。</p><p id="705e" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">开发确实花了一段时间，在我的空闲时间里可能需要一两个月，但是一旦CPU完成并成功执行2 + 2 = 5，我就很高兴了。</p><p id="c7a1" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">嗯，直到这本书讨论了I/O功能，设计了一个简单的键盘和显示界面，这样你就可以把东西放进和拿出机器。<em class="jk">我已经走了这么远</em>，没有必要让它处于半成品状态。我给自己设定了一个目标，那就是能够在键盘上打字，并在显示器上显示字母。</p><h2 id="7cd7" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">外围设备</h2><p id="d0b2" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">外围设备使用<a class="ae jl" href="https://en.wikipedia.org/wiki/Adapter_pattern" rel="noopener ugc nofollow" target="_blank">适配器模式</a>作为CPU和外界之间的硬件接口。猜测这是软件设计模式的灵感来源可能不是一个巨大的飞跃。</p><figure class="jn jo jp jq fd ij er es paragraph-image"><div role="button" tabindex="0" class="lc ld di le bf lf"><div class="er es lg"><img src="../Images/f66ed4cf32863d93318394edce49980f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4PWp0ue8aBos3rUy.png"/></div></div></figure><p id="87a5" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">有了这种关注点的分离，将键盘的另一端挂起来并显示到由GLFW管理的窗口实际上是非常简单的。事实上，我只是从我的<a class="ae jl" href="https://github.com/djhworld/gomeboycolor-glfw" rel="noopener ugc nofollow" target="_blank">模拟器</a>中取出了大部分代码，并对其进行了一点改造，使用go通道作为进出机器的信号。</p><h2 id="3ef9" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">赋予它生命</h2><figure class="jn jo jp jq fd ij er es paragraph-image"><div class="er es if"><img src="../Images/e3310db8cbfcb3a2ccde63fb93e7036a.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/0*wJnk1_oXXMBcZNzA.gif"/></div></figure><p id="4832" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">这可能是最棘手的部分，或者至少是最麻烦的部分。用这么有限的指令集写汇编太烂了。用我写的粗糙的汇编器写汇编更糟糕，因为除了你自己，你不能对别人挥舞拳头。</p><p id="cacb" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">最大的问题是处理4个寄存器并保持对它们的跟踪，将数据放入内存作为临时存储。在这样做的时候，我记得Gameboy的CPU有一个堆栈指针寄存器，这样你就可以推入和弹出状态。不幸的是，这台电脑没有这样的奢侈品，所以我主要是在定制的基础上把东西移入和移出内存。</p><p id="48de" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我花时间实现的唯一伪指令是<code class="du ks kt ku kv b">CALL</code>来帮助调用函数，这允许你运行一个函数，然后返回到函数被调用后的点。如果没有堆栈，你只能调用一层。</p><p id="53e7" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">另外，由于机器不支持中断，你必须为获取键盘状态等功能实现糟糕的轮询代码。这本书确实讨论了实现中断所需的步骤，但它会涉及更多的布线。</p><p id="61da" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">但是不管怎样，抱怨已经够多了，我最终写了四个程序，其中大部分使用了一些共享代码来绘制字体，获取键盘输入等等。不完全是操作系统的材料，但它确实让我欣赏一些简单的操作系统可能提供的服务。</p><p id="3c4c" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">然而这并不容易，文本编写程序最棘手的部分是计算出何时换行，或者当你按下回车键时会发生什么。</p><pre class="jn jo jp jq fd lh kv li lj aw lk bi"><span id="4aa0" class="jr js hi kv b fi ll lm l ln lo"><strong class="kv lp">main-getInput:</strong><br/>	CALL ROUTINE-io-pollKeyboard<br/>	CALL ROUTINE-io-drawFontCharacter<br/>	JMP main-getInput</span></pre><p id="b8c2" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jk">(文本编写程序的主循环)</em></p><p id="7506" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我也没有实现退格键，或者任何修饰键。让我意识到制作文本编辑器需要做多少工作，以及这可能有多乏味。</p><h2 id="efc5" class="jr js hi bd jt ju jv jw jx jy jz ka kb ix kc kd ke jb kf kg kh jf ki kj kk kl bi translated">对..进行反思</h2><p id="3f4e" class="pw-post-body-paragraph im in hi io b ip kw ir is it kx iv iw ix ky iz ja jb kz jd je jf la jh ji jj hb bi translated">对我来说，这是一个有趣且非常有益的项目。在用汇编语言编程的过程中，我很大程度上忘记了NAND、AND和OR门在下面工作。我已经上升到上面的抽象层。</p><p id="b13d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">虽然中的CPU非常简单，距离我的笔记本电脑还有很长的路要走，但我认为这个项目教会了我很多，即:</p><ul class=""><li id="26be" class="lq lr hi io b ip iq it iu ix ls jb lt jf lu jj lv lw lx ly bi translated">位如何使用总线在所有组件之间移动</li><li id="a3b0" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">简单的算术逻辑单元是如何工作的</li><li id="9bd5" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">一个简单的<em class="jk">获取-解码-执行循环看起来像什么</em></li><li id="d867" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">没有堆栈指针寄存器+堆栈概念的机器很糟糕</li><li id="94a3" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">一台没有中断的机器很糟糕</li><li id="2526" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">汇编程序是什么和做什么</li><li id="f06f" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">外设如何与简单的CPU通信</li><li id="c6f5" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">简单的T5字体是如何工作的，以及在显示器上显示它们的方法</li><li id="9427" class="lq lr hi io b ip lz it ma ix mb jb mc jf md jj lv lw lx ly bi translated">一个简单的操作系统看起来会是什么样子</li></ul><p id="9b81" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">那么下一步是什么？这本书上说，自1952年以来，没有人制造过这样的计算机，这意味着我有67年的时间来温习资料，所以这应该会让我忙上一阵子。我看到<a class="ae jl" href="https://software.intel.com/sites/default/files/managed/39/c5/325462-sdm-vol-1-2abcd-3abcd.pdf" rel="noopener ugc nofollow" target="_blank"> x86手册有4800页长</a>，足够一些乐趣，睡前轻松阅读。</p><p id="3b15" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">也许我会短暂地玩玩操作系统，玩玩C语言，度过一个令人遗憾的夜晚，尝试<a class="ae jl" href="https://obsolescence.wixsite.com/obsolescence/pidp-11" rel="noopener ugc nofollow" target="_blank">焊接一个PiDP-11工具包</a>，然后可能会放弃。我不知道，我们走着瞧。</p><p id="9809" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">严肃地说，虽然我认为我接下来将开始研究基于RISC的东西，也许是RISC-V，但可能会从早期的RISC处理器开始，以了解其谱系。现代的CPU有更多的特性，比如缓存之类的，所以我也想了解它们。有很多东西要学。</p><p id="ef59" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated">我在日常工作中需要知道这些东西吗？可能有帮助，但不是真的，但我很喜欢它，所以无论如何，感谢阅读xxxx</p></div><div class="ab cl me mf gp mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="hb hc hd he hf"><p id="b38d" class="pw-post-body-paragraph im in hi io b ip iq ir is it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj hb bi translated"><em class="jk">原载于2019年5月21日</em><a class="ae jl" href="https://djhworld.github.io/post/2019/05/21/i-dont-know-how-cpus-work-so-i-simulated-one-in-code/" rel="noopener ugc nofollow" target="_blank"><em class="jk">https://djh world . github . io</em></a><em class="jk">。</em></p></div></div>    
</body>
</html>