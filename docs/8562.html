<html>
<head>
<title>The Ultimate Guide to On-Perm Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">On-Perm Kubernetes的终极指南</h1>
<blockquote>原文：<a href="https://medium.com/swlh/the-ultimate-guide-to-on-perm-kubernetes-84b564f0acc?source=collection_archive---------3-----------------------#2019-07-18">https://medium.com/swlh/the-ultimate-guide-to-on-perm-kubernetes-84b564f0acc?source=collection_archive---------3-----------------------#2019-07-18</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/d7b635fdfa00beebb03727850812e790.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCsqMt85nMP0DvYv0JnkOA.png"/></div></div></figure><p id="b874" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当我在2018年初第一次进入Kubernetes时，我想知道为什么有人会使用如此复杂(和昂贵)的服务，而有许多其他方式来托管应用程序，如Vmware产品和Hyper-V。不久前，我被要求开发一个跨多个云和本地环境的高度可用的设置，这时候我突然想到:如果你想在本地数据中心环境中享受Kubernetes的好处， 有多种方法可以做到这一点，同时拥有高度可用的环境、类似云的自动化，最棒的是:从管理基础架构和硬件，一直到应用程序以及如何将流量路由到应用程序，对整个堆栈进行完全和绝对的控制。</p><p id="efd2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">有很多关于如何设置Kubernetes的指南，有些是针对AWS的，有些是针对Azure的，还有一些是针对本地部署的。然而，我看到的大多数内部指南要么已经过时，要么不准确，要么不适合生产环境。在本指南中，我将详细描述如何建立一个生产就绪的本地Kubernetes环境，该环境具有自动化和Kubernetes必须提供的所有功能。像往常一样，我接受关于如何使这个设置更好的评论和建议。这个指南的灵感来自于我在inkubate上看到的一个帖子。它涵盖了许多相同的步骤，但以更清晰的方式，针对2019年7月进行了更新，并修复了许多错误(由于重大更改，最初的版本没有设置2019年集群的正确步骤)。</p><p id="b926" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在我们进入之前，让我们回答以下问题:</p><ul class=""><li id="295f" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">为什么要在本地数据中心或托管系统中设置Kubernetes HA集群？</li><li id="31e9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">我们希望通过这种设置实现什么目标？</li></ul><p id="f13f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们看看为什么您会想要一个本地Kubernetes集群:</p><ul class=""><li id="4b42" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">如果您的设施中已经有内部虚拟化系统，或者拥有一个数据中心，但不想(或还不想)迁移到云。</li><li id="b50f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果您想利用docker、CI/CD、微服务或托管Kubernetes本地解决方案。</li><li id="6bd9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">云贵。如果您希望拥有一个完全可管理的完整Kubernetes解决方案，但又不想花费大部分云所需的大量资金。</li><li id="93c9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果您正在为高可用性或灵活性部署混合解决方案</li><li id="e432" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果您想拥有一个全功能的Kubernetes沙盒或测试环境，而不必为云资源付费。</li><li id="8cb2" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果你正在学习Kubernetes，并且想知道它在“引擎盖下”是如何工作的。</li></ul><p id="058e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，让我们定义我们希望通过此次部署实现的目标:</p><ul class=""><li id="b0bb" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">从基础架构和虚拟机到控制平面的一切都必须至少有N+2冗余。</li><li id="e545" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">部署必须在水平和垂直方向上可轻松、自动地扩展。</li><li id="bac2" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">向群集中添加新节点的过程必须是无缝的，并且是一键自动化的。</li><li id="aa5b" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">应该利用现有的虚拟化环境，而不必进行复杂或破坏性的更改。</li><li id="c466" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">该解决方案应该考虑到业务连续性，并且必须能够在发生灾难时恢复。</li><li id="2370" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">部署必须符合当前的Kubernetes和VMware标准。</li><li id="0c77" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">部署必须在云环境和本地环境中工作。</li><li id="48b8" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">部署必须是联邦就绪的。</li></ul></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="6071" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们进入实际部署。这是部署概述。我们将分五步执行部署:</p><ol class=""><li id="6694" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn kj ju jv jw bi translated">配置和设置Vmware环境和自动化。</li><li id="41d5" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kj ju jv jw bi translated">使用自动化来构建Kubernetes集群。</li><li id="baf8" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kj ju jv jw bi translated">配置群集。</li><li id="e03f" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kj ju jv jw bi translated">发布配置任务。</li><li id="b50d" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn kj ju jv jw bi translated">保护集群。</li></ol><p id="1461" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此次部署您将需要:</p><p id="e4df" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">部署由8台服务器组成:</p><ul class=""><li id="ab62" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">3个Kubernetes主节点</li><li id="17e1" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">3个Kubernetes工作节点</li><li id="9e0d" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">一个代理负载均衡器节点</li><li id="903d" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">运行自动化和管理集群的客户机</li></ul><p id="8b74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最好创建一个密钥，将本指南中的IP与您自己的IP相匹配:</p><p id="6ce8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">负载平衡器-192.168.2.51 /</p><p id="b73f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">主控1- 192.168.2.52 /</p><p id="d536" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">主控2- 192.168.2.53 /</p><p id="0fb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">主控3–192 . 168 . 2 . 54/</p><p id="798d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">工人1 -192.168.2.55 /</p><p id="d015" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">工人2–192 . 168 . 2 . 56/</p><p id="2592" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">工人3–192 . 168 . 2 . 57/</p><p id="afc6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这些机器都将运行Ubuntu 18.04，不过我已经让它在16.04上也能运行(步骤相同)。虚拟硬件要求会有所不同，具体取决于您想要分配给群集的资源数量以及群集的工作负载。对于我的环境(将成为生产环境)，我给每个worker和load balacner节点分配了3 GB的RAM、4个vCPUs和大约80GB的HDD。对于每个工作人员，我使用了4–6 GB的RAM、4个4vCPUs和一个120–200 GB的HDD。请记住，对于大多数虚拟化平台，您可以根据需要调整磁盘大小，并增加/减少资源。</p><p id="f9e2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在我们来看看虚拟机管理程序。我的部署在Vmware Vsphere管理的ESX企业集群上运行，该集群由9个节点、20 TB存储、700 GB RAM、SSD加速、图形协处理器和大约120个CPU组成。对于这个部署来说，这是不是有点过了？是的。显然，您不需要所有这些来运行这个部署。如果你刚刚起步，我建议你使用高端电脑、游戏电脑或者小型ESX集群。基本上，在任何可以运行Vmware Vpshere server的地方，您都可以运行此部署。</p><p id="6023" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:自动化部分需要VSphere server。如果您只运行ESX或其他虚拟机管理程序，部署仍然可以工作，但您需要手动设置每个节点或使用手动虚拟机克隆过程。最后，我想让自动化部署流程跨平台运行，但现在，我们将使用VSphere server。</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><p id="e39e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，好戏开始了。让我们登录VSphere UI，开始部署群集。本指南假定您已经有一个正确配置的VMware VSphere群集，可以进行虚拟机部署。如果没有，可以看看我即将发布的关于如何设置的帖子。</p><h2 id="0af3" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated"><strong class="ak">客户端机器—安装和配置</strong></h2><p id="6714" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">首先，你需要创建一个标准的Ubuntu 18.04服务器。我们将使用这台机器来设置自动化和kubectl。这台机器可以有最低规格，但我建议至少1 GB的内存，2个CPU和80 GB的磁盘。</p><p id="426c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在设置机器时，唯一的先决条件是它需要访问Kubernetes节点所在的网络。否则，可以使用默认安装选项(主机名、用户名等)。对于软件包，此时只需要标准的系统实用程序和sshd。</p><p id="4bb0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您知道如何部署Ubuntu机器。如果没有，请看这里的。</p><h2 id="ed26" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">安装Kubeadm工具</h2><p id="db20" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">接下来，我们需要安装证书生成器、管理Kubernetes的kubectl和设置其他虚拟机的Terraform。</p><p id="fc6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">首先，让我们安装云Flare SSL:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="474d" class="kk kl hi lq b fi lu lv l lw lx">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</span><span id="75d0" class="kk kl hi lq b fi ly lv l lw lx">wget <a class="ae lk" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" rel="noopener ugc nofollow" target="_blank">https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</a></span><span id="9e03" class="kk kl hi lq b fi ly lv l lw lx"># Add the executable permission to the package<br/>  <strong class="lq lz">chmod</strong> +<strong class="lq lz">x</strong> cfssl*</span><span id="a5e2" class="kk kl hi lq b fi ly lv l lw lx"># Move everything to /usr/local/bin</span><span id="3b16" class="kk kl hi lq b fi ly lv l lw lx">sudo mv cfssl_linux-amd64 /usr/local/bin/cfssl</span><span id="065d" class="kk kl hi lq b fi ly lv l lw lx">sudo mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></pre><p id="bebf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦一切都完成了，让我们验证一下cfssl版本:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="60d4" class="kk kl hi lq b fi lu lv l lw lx">cfssl version</span></pre><p id="83fd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切都正确完成，那么在cfssl返回的字符串中应该有一个版本输出。</p><p id="ff11" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，让我们安装kubectl:</p><p id="548e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-下载二进制文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="ce2b" class="kk kl hi lq b fi lu lv l lw lx">wget <a class="ae lk" href="https://storage.googleapis.com/kubernetes-" rel="noopener ugc nofollow" target="_blank">https://storage.googleapis.com/kubernetes-</a><strong class="lq lz">release</strong>/<strong class="lq lz">release</strong>/v1.12.1/<strong class="lq lz">bin</strong>/linux/amd64/kubectl</span></pre><p id="c191" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-使其可执行:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="dcb7" class="kk kl hi lq b fi lu lv l lw lx"><strong class="lq lz">chmod</strong> +<strong class="lq lz">x</strong> kubectl</span></pre><p id="f830" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-将二进制文件移动到/usr/local/bin:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="46df" class="kk kl hi lq b fi lu lv l lw lx">sudo mv kubectl /usr/local/bin</span></pre><p id="da29" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-验证kubectl的版本:(注意:这将在此时抛出一个错误)</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="602c" class="kk kl hi lq b fi lu lv l lw lx">kubectl version</span></pre><h2 id="e9e8" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">安装自动化工具和设置模板</h2><p id="3208" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">接下来，我们将在客户机上安装自动化工具，并构建Terraform将使用的模板虚拟机。我们将使用HashiCorp Terraform来克隆现有的虚拟机模板，以创建Kubernetes集群。</p><h2 id="0e75" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">模板虚拟机设置</h2><p id="444f" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">首先，您需要设置一个新的Ubuntu 18.04 VM，它有4 GB内存、120 GB硬盘和4个vCPUs。如果您愿意，可以稍后在部署配置中更改这些规范。此时，虚拟机上应该只有标准的系统实用程序和sshd。</p><p id="f2ef" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">模板的名称应该是Ubuntu-18.04-terraform-template</p><p id="63bc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:从头开始创建虚拟机并运行全新安装是一个好主意。不要重用客户端虚拟机。</p><p id="5d3c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">此时，您还可以在模板虚拟机上安装您需要的任何管理工具(snmpd、监控代理等)。<strong class="is lz">确保这些不会干扰Kubelet或etcd服务。</strong></p><p id="80d2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重要提示:您将需要在所有虚拟机上安装VMware工具，因此让我们将软件包部署到模板:</p><p id="d751" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-将<a class="ae lk" href="https://my.vmware.com/web/vmware/details?productId=742&amp;downloadGroup=VMTOOLS1035" rel="noopener ugc nofollow" target="_blank"> VMware tools </a>下载到您的模板虚拟机上(如果您还没有VMware帐户，则必须创建一个)。为了更容易，您可以从您的机器上将包SCP到模板VM。</p><p id="f355" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-解压存档文件。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="aa83" class="kk kl hi lq b fi lu lv l lw lx">tar xvzf VMware-Tools-core-whatever version.tar.gz</span></pre><p id="1ef3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-挂载VMware tools ISO。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="792e" class="kk kl hi lq b fi lu lv l lw lx">sudo mount -o loop /tmp/linux.iso /mnt</span></pre><p id="8f42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6-提取VMware tools安装程序。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="493e" class="kk kl hi lq b fi lu lv l lw lx">tar xvzf /mnt/VMwareTools-whatever version.tar.gz -C /tmp</span></pre><p id="c9c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7-卸载VMware tools ISO。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8e3e" class="kk kl hi lq b fi lu lv l lw lx">sudo umount /mnt</span></pre><p id="f2f7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8-删除open-vm-tools包。我们将用Vmware tools的完整安装来替换它。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="bc8a" class="kk kl hi lq b fi lu lv l lw lx">sudo apt-get remove --purge open-vm-tools</span></pre><p id="25e9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9-安装VMware工具(保留所有选项的默认设置)。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b9b4" class="kk kl hi lq b fi lu lv l lw lx">cd /tmp/vmware-tools-distrib<br/>sudo ./vmware-install.pl</span></pre><p id="87e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">10-重新启动机器。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="f1da" class="kk kl hi lq b fi lu lv l lw lx">sudo reboot</span></pre><p id="0715" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重新启动后，我们可以清理虚拟机:</p><p id="f458" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-删除临时网络配置。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e23a" class="kk kl hi lq b fi lu lv l lw lx">sudo rm /etc/netplan/50-cloud-init.yaml</span><span id="cb14" class="kk kl hi lq b fi ly lv l lw lx"># Note: the config file name may sometimes be different. </span></pre><p id="9e93" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-防止云配置保留主机名。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8ba7" class="kk kl hi lq b fi lu lv l lw lx">sudo nano /etc/cloud/cloud.cfg<br/>...<br/>preserve_hostname: true<br/>...</span></pre><p id="79b1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-关闭虚拟机。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="5ebf" class="kk kl hi lq b fi lu lv l lw lx">sudo shutdown now</span></pre><p id="ef92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，您应该有一个完全配置好VM，可以转换成模板了。</p><p id="18e5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">注意:确保将VM适配器的网络配置设置为可以访问其余Kubernetes节点的网络。</strong></p><h2 id="e133" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">安装自动化工具</h2><p id="e30c" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">接下来，让我们回到客户机并设置Terraform:</p><p id="facf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-从HashiCorp repo下载Terraform。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="51f4" class="kk kl hi lq b fi lu lv l lw lx">wget https://<a class="ae lk" href="http://releases.hashicorp.com/terraform" rel="noopener ugc nofollow" target="_blank">releases.hashicorp.com/terraform</a>/0.11.14/terraform_0.11.14_linux_amd64.zip</span></pre><p id="46fa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-解压存档文件。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="f043" class="kk kl hi lq b fi lu lv l lw lx">unzip -e terraform_0.11.14_linux_amd64.zip</span></pre><p id="98ad" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-将二进制文件复制到您的路径中。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b402" class="kk kl hi lq b fi lu lv l lw lx">sudo cp terraform /usr/bin</span></pre><p id="784d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:Terraform是多平台的。理论上，你应该也能从Mac或Windows机器上做到这一点。</p><p id="7d65" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用由sguyennet开发的脚本来克隆虚拟机。</p><p id="8fdb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:我绝对讨厌vim。本教程中的编辑由via nano完成。</p><h2 id="af11" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">让我们来设置脚本:</h2><p id="cbbf" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">1-克隆脚本存储库:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="1678" class="kk kl hi lq b fi lu lv l lw lx">git <strong class="lq lz">clone</strong> https:<em class="ma">//</em><a class="ae lk" href="http://github.com/sguyennet/terraform-vsphere-standalone.git" rel="noopener ugc nofollow" target="_blank"><em class="ma">github.com/sguyennet/terraform-vsphere-standalone.git</em></a></span></pre><p id="46bb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-地形初始化:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8969" class="kk kl hi lq b fi lu lv l lw lx">cd terraform-vsphere-standalone</span><span id="a241" class="kk kl hi lq b fi ly lv l lw lx">terraform init</span></pre><p id="a9d3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-配置HAProxy机器的部署:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="dd7b" class="kk kl hi lq b fi lu lv l lw lx">nano terraform.tfvars</span></pre><p id="2bd1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这里，您需要设置以下内容:</p><ul class=""><li id="a9fd" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">Vsphere服务器URL、用户详细信息、数据中心等(第1块)</li><li id="703e" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">如果您有自签名的Vsphere证书，请将未验证的SSL设置为true。</li><li id="68aa" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在第2块(虚拟机参数)，您需要填写虚拟机的详细信息。此时，您也可以自定义虚拟硬件。(关于规格建议，请参见上文)。</li><li id="61b2" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">您将需要7个不同的虚拟机名称和IP。选择您希望您的HAProxy机器现在拥有的IP和名称。</li><li id="b2f9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">除非您有一个群集中所有虚拟机都可以看到的内部域名，否则将域留空。</li><li id="ac62" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">输入您在上一步中为模板虚拟机指定的名称(默认为Ubuntu-18.04-terraform-template)</li><li id="f1f4" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">除非您知道自己在做什么，否则请将链接克隆留空。</li><li id="304a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">我建议对集群节点使用顺序IP来简化工作。整个集群总共需要8个。请记住，IPs应该位于您的客户机可以到达的网络上(如果您希望从外部访问您的Kubernetes服务，您的LAN也可以到达)。</li><li id="4825" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">完成编辑后保存文件。</li></ul><p id="1df4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5.在文件夹中执行ls操作，确保没有看到terraform.tfstate或tfstate.backup文件。如果有，删除它。</p><p id="fbc2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-部署虚拟机。这将是你的HAProxy节点。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="a0bb" class="kk kl hi lq b fi lu lv l lw lx">terraform apply</span></pre><p id="153f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将启动您的HAProxy机器的部署。注意:如果你搞砸了，你可以随时做<strong class="is lz">地形摧毁。</strong></p><h2 id="d617" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">创建更多虚拟机</h2><p id="19df" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">我们现在可以创建所有其他虚拟机。请记住，对于本指南，我们将需要一个负载平衡器、三名管理员和三名工作人员。</p><p id="c073" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">回到您的tfvars文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="5663" class="kk kl hi lq b fi lu lv l lw lx">nano terraform.tfvars</span></pre><p id="44a8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为每次运行更改机器虚拟硬件规格、主机名和IP。您需要为需要创建的每个虚拟机重复此步骤。</p><p id="be68" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于每个步骤，编辑tfvars文件，并</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="0112" class="kk kl hi lq b fi lu lv l lw lx">terraform apply</span></pre><p id="7e5a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">重要提示:每次运行后删除terraform.tfstate和terraform.tfstate.backup文件。否则，每个应用操作都将替换前一个操作。</strong></p><p id="5d42" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(我打算以后纠正这一点)。</p><p id="b622" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">记住，你只能在每次运行后使用地形摧毁。当您删除tfstate文件时，您将擦除Terraform的内存，并且将无法自动恢复。</p><p id="d5b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">一旦您完成了所有的运行操作，您现在应该有一个空白的节点系列，可以安装Kubernetes组件了。</p><p id="87b5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">(您也可以保留该模板，并使用Terraform或其他工具将其用于其他部署。)</p><p id="1d40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最好测试对每个节点的访问，以确保它们正常运行并且可以访问。</p><h2 id="d8c7" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">安装HAProxy</h2><p id="45fe" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">现在，让我们在LB节点上设置HAProxy。</p><p id="8f6c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1- SSH到您的HAProxy节点。</p><p id="b686" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-更新虚拟机:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="22fc" class="kk kl hi lq b fi lu lv l lw lx">sudo apt-get update</span><span id="25a2" class="kk kl hi lq b fi ly lv l lw lx">sudo apt-get upgrade</span></pre><p id="c697" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-安装HAProxy:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="b584" class="kk kl hi lq b fi lu lv l lw lx">sudo apt-get install haproxy</span></pre><p id="0b02" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-配置HAProxy在三个Kubernetes主节点之间负载平衡流量:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="0e88" class="kk kl hi lq b fi lu lv l lw lx">nano /etc/haproxy/haproxy.cfg<br/>global<br/>        log /dev/log    local0<br/>        log /dev/log    local1 notice<br/>        chroot /var/lib/haproxy<br/>        stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners<br/>        stats timeout 30s<br/>        user haproxy<br/>        group haproxy<br/>        daemon</span><span id="a02c" class="kk kl hi lq b fi ly lv l lw lx"># Default SSL material locations<br/>        ca-base /etc/ssl/certs<br/>        crt-base /etc/ssl/private</span><span id="9805" class="kk kl hi lq b fi ly lv l lw lx"># Default ciphers to use on SSL-enabled listening sockets.<br/>        # For more information, see ciphers(1SSL). This list is from:<br/>        #  <a class="ae lk" href="https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/" rel="noopener ugc nofollow" target="_blank">https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/</a><br/>        # An alternative list with additional directives can be obtained from<br/>        #  <a class="ae lk" href="https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy" rel="noopener ugc nofollow" target="_blank">https://mozilla.github.io/server-side-tls/ssl-config-generator/?server=haproxy</a><br/>        ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS<br/>        ssl-default-bind-options no-sslv3</span><span id="8bca" class="kk kl hi lq b fi ly lv l lw lx">defaults<br/>        log     global<br/>        mode    http<br/>        option  httplog<br/>        option  dontlognull<br/>        timeout connect 5000<br/>        timeout client  50000<br/>        timeout server  50000<br/>        errorfile 400 /etc/haproxy/errors/400.http<br/>        errorfile 403 /etc/haproxy/errors/403.http<br/>        errorfile 408 /etc/haproxy/errors/408.http<br/>        errorfile 500 /etc/haproxy/errors/500.http<br/>        errorfile 502 /etc/haproxy/errors/502.http<br/>        errorfile 503 /etc/haproxy/errors/503.http<br/>        errorfile 504 /etc/haproxy/errors/504.http</span><span id="5c9e" class="kk kl hi lq b fi ly lv l lw lx">frontend kubernetes<br/>bind 192.168.2.51:6443<br/>option tcplog<br/>mode tcp<br/>default_backend kubernetes-master-nodes</span><span id="fff9" class="kk kl hi lq b fi ly lv l lw lx">backend kubernetes-master-nodes<br/>mode tcp<br/>balance roundrobin<br/>option tcp-check<br/>server k8s-master-0 192.168.2.52:6443 check fall 3 rise 2<br/>server k8s-master-1 192.168.2.53:6443 check fall 3 rise 2<br/>server k8s-master-2 192.168.2.54:6443 check fall 3 rise 2</span></pre><p id="cbae" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">根据HAProxy版本的不同，您的配置可能会有所不同。这里唯一需要改变的是IP。将绑定IP更改为HAProxy节点的本地IP。更改其本地IP的主IP 0–2。</p><p id="b3e1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于本指南，我对HAProxy机器使用192.168.2.51，对主节点使用52–54。</p><p id="2c90" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-重新启动HAProxy:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="454a" class="kk kl hi lq b fi lu lv l lw lx">sudo service haproxy restart</span></pre><p id="d95e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">检查HAProxy是否已成功启动:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="c823" class="kk kl hi lq b fi lu lv l lw lx">sudo service haproxy status</span></pre><h2 id="0225" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">为Kubeadm生成主节点证书</h2><p id="272c" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">接下来，我们需要返回客户端虚拟机，通过CloudFlare SSL工具生成TLS证书。</p><p id="6610" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-创建证书颁发机构配置文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e4f2" class="kk kl hi lq b fi lu lv l lw lx">nano ca-config.json<br/>{<br/>  "signing": {<br/>    "default": {<br/>      "expiry": "8760h"<br/>    },<br/>    "profiles": {<br/>      "kubernetes": {<br/>        "usages": ["signing", "key encipherment", "server auth", "client auth"],<br/>        "expiry": "8760h"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="ece8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-创建证书颁发机构签名请求配置文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="2959" class="kk kl hi lq b fi lu lv l lw lx">nano ca-csr.json<br/>{<br/>  "CN": "Kubernetes",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>  {<br/>    "C": "IE",<br/>    "L": "Acme",<br/>    "O": "Kubernetes",<br/>    "OU": "Anvil",<br/>    "ST": "Acme Co."<br/>  }<br/> ]<br/>}</span></pre><p id="fcb4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将配置文件中的详细信息更改为您自己的信息。</p><p id="2243" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-生成认证机构证书和私钥:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="2942" class="kk kl hi lq b fi lu lv l lw lx">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></pre><p id="7e1b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-验证是否生成了ca-key.pem和ca.pem:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="4922" class="kk kl hi lq b fi lu lv l lw lx">ls -la</span></pre><p id="7830" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们生成证书和私钥。</p><p id="2916" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-创建证书签名请求配置文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="dfa0" class="kk kl hi lq b fi lu lv l lw lx">nano kubernetes-csr.json<br/>{<br/>  "CN": "kubernetes",<br/>  "key": {<br/>    "algo": "rsa",<br/>    "size": 2048<br/>  },<br/>  "names": [<br/>  {<br/>    "C": "IE",<br/>    "L": "Cork",<br/>    "O": "Kubernetes",<br/>    "OU": "Kubernetes",<br/>    "ST": "Cork Co."<br/>  }<br/> ]<br/>}</span></pre><p id="a39b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-生成证书和私钥:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="f979" class="kk kl hi lq b fi lu lv l lw lx">cfssl gencert \<br/>-ca=ca.pem \<br/>-ca-key=ca-key.pem \<br/>-config=ca-config.json \<br/>-hostname=192.168.2.51,192.168.2.52,192.168.2.53,192.168.2.54,127.0.0.1,kubernetes.default \<br/>-profile=kubernetes kubernetes-csr.json | \<br/>cfssljson -bare kubernetes</span></pre><p id="5c56" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">注意:您需要将hostname= IPs改为您自己的名称。</strong></p><p id="6657" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-验证是否生成了kubernetes-key.pem和kubernetes.pem文件。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="d2e0" class="kk kl hi lq b fi lu lv l lw lx">ls -la</span></pre><p id="7ba8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-将证书复制到集群中的每个节点:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="d34f" class="kk kl hi lq b fi lu lv l lw lx">scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.51:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.52:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.53:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.54:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.55:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.56:~<br/>scp ca.pem kubernetes.pem kubernetes-key.pem pavel@192.168.2.57:~</span></pre><p id="82b3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:将用户名和IP地址改为您自己的。</p><h1 id="7a95" class="mb kl hi bd km mc md me kq mf mg mh ku mi mj mk kx ml mm mn la mo mp mq ld mr bi translated">安装Docker</h1><p id="6fdc" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">1-第一台机器的SSH:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="0a4e" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.51</span></pre><p id="5fdb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-提升到根目录:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="9444" class="kk kl hi lq b fi lu lv l lw lx">sudo su</span></pre><p id="8c15" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-添加Docker存储库密钥:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="0fa6" class="kk kl hi lq b fi lu lv l lw lx">curl -fsSL https:<em class="ma">//</em><a class="ae lk" href="http://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank"><em class="ma">download.docker.com/linux/ubuntu/gpg</em></a><em class="ma"> | apt-key add -</em></span></pre><p id="d98b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-添加Docker存储库:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="3045" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">add-apt-repository \</em><br/>"deb <a class="ae lk" href="https://download.docker.com/linux/" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/</a>$(. /etc/os-release; echo "$ID") \<br/>$(lsb_release -cs) \<br/>stable"</span></pre><p id="0f5f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-更新包列表:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="1228" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">apt update</em></span></pre><p id="edea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6-安装对接器:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="242d" class="kk kl hi lq b fi lu lv l lw lx">apt <strong class="lq lz">install</strong> -y docker-ce</span></pre><h1 id="6526" class="mb kl hi bd km mc md me kq mf mg mh ku mi mj mk kx ml mm mn la mo mp mq ld mr bi translated">安装Kubernetes组件:</h1><p id="51f9" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">1-添加Google存储库密钥:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="bb13" class="kk kl hi lq b fi lu lv l lw lx">curl -s https:<em class="ma">//</em><a class="ae lk" href="http://packages.cloud.google.com/apt/doc/apt-key.gpg" rel="noopener ugc nofollow" target="_blank"><em class="ma">packages.cloud.google.com/apt/doc/apt-key.gpg</em></a><em class="ma"> | apt-key add -</em></span></pre><p id="87bf" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-添加Google存储库:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="1b33" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">nano /etc/apt/sources.list.d/kubernetes.list</em><br/><strong class="lq lz">deb</strong> <a class="ae lk" href="http://apt.kubernetes.io/" rel="noopener ugc nofollow" target="_blank">http://apt.kubernetes.io</a> kubernetes-xenial main</span></pre><p id="4846" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-更新包列表:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8921" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">apt update</em></span></pre><p id="24e3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-安装kubelet、kubeadm和kubectl:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="0696" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">apt install kubelet kubeadm kubectl</em></span></pre><p id="ef69" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-禁用交换。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="8eec" class="kk kl hi lq b fi lu lv l lw lx"><em class="ma">swapoff -a</em></span><span id="fc86" class="kk kl hi lq b fi ly lv l lw lx"><em class="ma">sed -i '/ swap / s/^/#/' /etc/fstab</em></span></pre><p id="6c77" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">重要提示:启动时必须禁用交换。否则，群集将在重新启动时中断。</p><p id="4f87" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6.禁止在启动时交换:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="601f" class="kk kl hi lq b fi lu lv l lw lx">nano /etc/fstab</span><span id="8dd9" class="kk kl hi lq b fi ly lv l lw lx"># Comment out the second line mentioning swap<br/># Save the file</span></pre><p id="3f4f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">重要提示:需要对集群中的每个Kubernetes节点重复这个过程(仅限所有主节点和工作节点)。</strong></p><p id="0a30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">在主节点上安装和配置Etcd服务</strong></p><p id="083d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">接下来，我们将在每个主节点上安装和配置Etcd键值存储服务。</p><p id="1cb1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-第一个主节点的SSH:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="148a" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.52</span></pre><p id="8979" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-为Etcd配置创建一个目录:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="9230" class="kk kl hi lq b fi lu lv l lw lx">sudo mkdir /etc/etcd /var/lib/etcd</span></pre><p id="a76c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-将证书移动到配置目录:(您需要以用于将证书复制到机器的用户身份执行此操作，而不是以root用户身份，因为它们位于用户的主目录中)。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="012e" class="kk kl hi lq b fi lu lv l lw lx">sudo mv ~/ca.pem ~/kubernetes.pem ~/kubernetes-key.pem /etc/etcd</span></pre><p id="fd53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-下载etcd软件包:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="1709" class="kk kl hi lq b fi lu lv l lw lx">wget https://<a class="ae lk" href="http://github.com/coreos" rel="noopener ugc nofollow" target="_blank">github.com/coreos</a>/etcd/releases/download/v3.3.9/etcd-v3.3.9-linux-amd64.tar.gz</span></pre><p id="e962" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-提取etcd档案:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="bd8a" class="kk kl hi lq b fi lu lv l lw lx">tar xvzf etcd-v3.3.9-linux-amd64.tar.gz</span></pre><p id="ff74" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6-将etcd二进制文件移动到/usr/local/bin:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="3901" class="kk kl hi lq b fi lu lv l lw lx">sudo mv etcd-v3.3.9-linux-amd64/etcd* /usr/local/bin/</span></pre><p id="5104" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7-创建一个etcd系统单元文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="25d8" class="kk kl hi lq b fi lu lv l lw lx">sudo nano /etc/systemd/system/etcd.service<br/>[Unit]<br/>Description=etcd<br/>Documentation=https://<a class="ae lk" href="http://github.com/coreos" rel="noopener ugc nofollow" target="_blank">github.com/coreos</a></span><span id="204a" class="kk kl hi lq b fi ly lv l lw lx">[Service]<br/>ExecStart=/usr/local/bin/etcd \<br/>  --name 192.168.2.52 \<br/>  --cert-file=/etc/etcd/kubernetes.pem \<br/>  --key-file=/etc/etcd/kubernetes-key.pem \<br/>  --peer-cert-file=/etc/etcd/kubernetes.pem \<br/>  --peer-key-file=/etc/etcd/kubernetes-key.pem \<br/>  --trusted-ca-file=/etc/etcd/ca.pem \<br/>  --peer-trusted-ca-file=/etc/etcd/ca.pem \<br/>  --peer-client-cert-auth \<br/>  --client-cert-auth \<br/>  --initial-advertise-peer-urls https://192.168.2.52:2380 \<br/>  --listen-peer-urls https://192.168.2.52:2380 \<br/>  --listen-client-urls https://192.168.2.52:2379,http://127.0.0.1:2379 \<br/>  --advertise-client-urls https://192.168.2.52:2379 \<br/>  --initial-cluster-token etcd-cluster-0 \<br/>  --initial-cluster 192.168.2.52=https://192.168.2.52:2380,192.168.2.53=https://192.168.2.53:2380,192.168.2.45=https://192.168.2.54:2380 \<br/>  --initial-cluster-state new \<br/>  --data-dir=/var/lib/etcd<br/>Restart=on-failure<br/>RestartSec=5</span><span id="bd4f" class="kk kl hi lq b fi ly lv l lw lx">[Install]<br/>WantedBy=multi-user.target</span></pre><p id="087b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">把IP换成自己的。—名称将是第一个主节点的本地IP。广告和广播URL也是如此。初始群集IP是主节点的IP。</p><p id="257b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">8-重新启动服务:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="bc79" class="kk kl hi lq b fi lu lv l lw lx">sudo etcd restart</span></pre><p id="ba9e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">9-使etcd在引导时启动:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="ef2d" class="kk kl hi lq b fi lu lv l lw lx">sudo systemctl enable etcd</span></pre><p id="f84d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">10-检查etcd是否已成功启动:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="1acb" class="kk kl hi lq b fi lu lv l lw lx">sudo service etcd status</span></pre><p id="78f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:如果您在启动etcd时遇到问题，请查看机器系统日志。一个常见的问题是配置文件中的打字错误或错误的IP或错误的语法。</p><p id="ebf7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">仅对另外两个主节点重复此过程。</strong></p><p id="17c7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">记得在配置文件中更新每个节点的IP。</strong></p><h2 id="0046" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">初始化主集群</h2><p id="28d4" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">现在是初始化三个主节点的时候了。</p><p id="89c2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-第一个主节点的SSH:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="78e1" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.52</span></pre><p id="1182" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-为kubeadm创建配置文件:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="848d" class="kk kl hi lq b fi lu lv l lw lx">nano config.yaml<br/>apiVersion: kubeadm.k8s.io/v1beta2<br/>kind: ClusterConfiguration<br/>kubernetesVersion: stable<br/>apiServerCertSANs:<br/>- 192.168.2.51<br/>controlPlaneEndpoint: "192.168.2.51:6443"<br/>etcd:<br/>  external:<br/>    endpoints:<br/>    - <a class="ae lk" href="https://10.85.77.52:2379" rel="noopener ugc nofollow" target="_blank">https://192.168.2.52:2379</a><br/>    - <a class="ae lk" href="https://10.85.77.53:2379" rel="noopener ugc nofollow" target="_blank">https://192.168.2.53:2379</a><br/>    - <a class="ae lk" href="https://10.85.77.54:2379" rel="noopener ugc nofollow" target="_blank">https://192.168.2.54:2379</a><br/>    caFile: /etc/etcd/ca.pem<br/>    certFile: /etc/etcd/kubernetes.pem<br/>    keyFile: /etc/etcd/kubernetes-key.pem<br/>networking:<br/>  podSubnet: 10.30.0.0/24<br/>apiServerExtraArgs:<br/>  apiserver-count: "3"</span></pre><p id="e7ea" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:在撰写本文时，API version:kubeadm.k8s.io/v1beta2是一个有效的API版本。</p><p id="3cc0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:用自己的IP替换。控制平面端点和证书都是HAProxy机器IP。端点是主节点IP。我使用10.30.0.0/24的pod网络。你愿意的话可以把这个IP换成你自己的。</p><p id="c848" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-将机器初始化为主节点:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="195b" class="kk kl hi lq b fi lu lv l lw lx">sudo kubeadm init --config=config.yaml</span></pre><p id="91e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-将证书复制到另外两个主节点:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="52e8" class="kk kl hi lq b fi lu lv l lw lx">sudo scp -r /etc/kubernetes/pki pavel@192.168.2.52:~<br/>sudo scp -r /etc/kubernetes/pki pavel@192.168.2.53:~</span></pre><p id="7227" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-在另外两个主节点上，创建config.yaml文件(不要做任何更改，使其与第一个主节点相同)。</p><p id="74f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后运行:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e492" class="kk kl hi lq b fi lu lv l lw lx">sudo kubeadm init --config=config.yaml</span></pre><p id="ee53" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在另外两个主节点上。</p><p id="480e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">保存初始化后显示的join命令。</p><h2 id="d01e" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">正在初始化工作节点</h2><p id="a5fc" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">1- SSH到第一个工作节点:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="4cbf" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.55</span></pre><p id="a869" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-执行您在上一步中保存的join命令:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="f635" class="kk kl hi lq b fi lu lv l lw lx">sudo kubeadm join 192.168.2.51:6443 --token [your_token] --discovery-token-ca-cert-hash sha256:[your_token_ca_cert_hash]</span></pre><p id="c4ba" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将IP更改为您自己的HAProxy节点。</p><p id="0ee7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">对所有剩余的工作节点重复此步骤。</strong></p><h2 id="e423" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">验证集群节点</h2><p id="1ede" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">验证所有节点都已成功加入群集:</p><p id="fe9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-第一个主节点的SSH:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="317a" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.52</span></pre><p id="8993" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-获取节点列表:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="78da" class="kk kl hi lq b fi lu lv l lw lx">sudo kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes<br/>NAME STATUS ROLES AGE VERSION<br/>k8s-kubeadm-master-0 NotReady master 1h v1.12.1<br/>k8s-kubeadm-master-1 NotReady master 1h v1.12.1<br/>k8s-kubeadm-master-2 NotReady master 1h v1.12.1<br/>k8s-kubeadm-worker-0 NotReady  2m v1.12.1<br/>k8s-kubeadm-worker-1 NotReady  1m v1.12.1<br/>k8s-kubeadm-worker-2 NotReady  1m v1.12.1</span></pre><p id="f9c9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:节点显示为未就绪，因为尚未配置网络。</p><h2 id="f168" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">在客户机上配置Kubectl</h2><p id="7603" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">现在我们需要在. 50客户机上配置kubectl，这样我们就可以管理Kubernetes集群。注意:这可以在任何能够运行kubectl的机器上完成。</p><p id="bb9d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1- SSH到其中一个主节点</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="decc" class="kk kl hi lq b fi lu lv l lw lx">ssh pavel@192.168.2.52</span></pre><p id="19b9" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-向admin.conf文件添加权限。</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="022e" class="kk kl hi lq b fi lu lv l lw lx">sudo chmod +r /etc/kubernetes/admin.conf</span></pre><p id="beb2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-将配置文件复制到客户端计算机，并改回权限:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="a8c6" class="kk kl hi lq b fi lu lv l lw lx">cd /etc/kubernetes<br/>scp admin.conf pavel@192.168.2.50:/ .<br/>sudo chmod 600 /etc/kubernetes/admin.conf</span></pre><p id="d124" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4-返回客户机并创建kubectl配置目录:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="227f" class="kk kl hi lq b fi lu lv l lw lx">mkdir ~/.kube</span></pre><p id="1bcb" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-将配置文件移动到配置目录:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e38d" class="kk kl hi lq b fi lu lv l lw lx">mv admin.conf ~/.kube/config</span></pre><p id="21f6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6-修改配置文件的权限:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="45df" class="kk kl hi lq b fi lu lv l lw lx">chmod 600 ~/.kube/config</span></pre><p id="40fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">7-检查从客户端机器到Kubernetes集群API的连接:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="f4e5" class="kk kl hi lq b fi lu lv l lw lx">kubectl <strong class="lq lz">get</strong> nodes</span></pre><p id="81c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您应该会得到集群中状态为not ready的节点列表。</p><h2 id="c5d1" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">设置网络</h2><p id="9abe" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">Weavenet将用作本指南的覆盖网络。如果您计划使用F5设备作为入口，建议使用法兰绒。</p><p id="3c79" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-从客户端机器，部署覆盖网络盒:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="13af" class="kk kl hi lq b fi lu lv l lw lx">kubectl apply -f https://<a class="ae lk" href="http://git.io/weave" rel="noopener ugc nofollow" target="_blank">git.io/weave</a>-kube-1.6</span></pre><p id="2611" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-检查吊舱是否正确展开:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="d8be" class="kk kl hi lq b fi lu lv l lw lx">kubectl get pods -n kube-system</span></pre><p id="d59d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-检查节点是否处于就绪状态:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e6e2" class="kk kl hi lq b fi lu lv l lw lx">kubectl get nodes<br/>NAME STATUS ROLES AGE VERSION<br/>k8s-kubeadm-master-0 Ready master 18h v1.12.1<br/>k8s-kubeadm-master-1 Ready master 18h v1.12.1<br/>k8s-kubeadm-master-2 Ready master 18h v1.12.1<br/>k8s-kubeadm-worker-0 Ready  16h v1.12.1<br/>k8s-kubeadm-worker-1 Ready  16h v1.12.1<br/>k8s-kubeadm-worker-2 Ready  16h v1.12.1</span></pre><p id="3c82" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意:所有节点变为就绪状态可能需要几分钟时间。</p><p id="3c21" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您现在应该拥有一个功能完整的Kubernetes集群。</p><p id="e422" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz">安装附件</strong></p><p id="924e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Kubernetes有几个有用的插件。其中之一是仪表板。</p><p id="c6ca" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is lz"> Kubernetes仪表盘</strong></p><p id="e4e6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">1-创建仪表板:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="d057" class="kk kl hi lq b fi lu lv l lw lx">kubectl create -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/alternative/kubernetes-dashboard.yaml</span></pre><p id="3193" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">2-删除仪表板服务。我们将使用另一种设置:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="7948" class="kk kl hi lq b fi lu lv l lw lx">kubectl delete service kubernetes-dashboard -n=kube-system</span></pre><p id="317e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">3-暴露仪表板:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="4a95" class="kk kl hi lq b fi lu lv l lw lx">kubectl expose deployment kubernetes-dashboard -n=kube-system -type=LoadBalancer -name=kubernetes-dashboard -external-ip=192.168.2.52 -port=8443</span></pre><p id="e7e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这将在<a class="ae lk" href="http://192.168.2.52:8443" rel="noopener ugc nofollow" target="_blank"> http://192.168.2.52:8443 </a>上显示Kubernetes仪表盘</p><p id="7da2" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">把IP换成自己的。</p><p id="df98" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您还可以使用其他方法来运行仪表板:<a class="ae lk" href="https://github.com/kubernetes/dashboard/wiki/Installation" rel="noopener ugc nofollow" target="_blank">https://github.com/kubernetes/dashboard/wiki/Installation</a></p><p id="45c3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你现在应该有一个工作的Kubernetes仪表板。</p><p id="0804" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，让我们登录。在登录页面上，选择令牌。</p><p id="1466" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在客户端机器上:</p><p id="6139" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">4 -获取仪表板机密列表:</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="e1eb" class="kk kl hi lq b fi lu lv l lw lx">kubectl get secrets -n=kube-system | grep dashboard</span></pre><p id="5b22" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">5-描述名为kubernetes-dashboard-token-xxxxx的秘密</p><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="2a11" class="kk kl hi lq b fi lu lv l lw lx">kubectl describe secret kubernetes-dashboard-token-xxxxx -n=kube-system</span></pre><p id="a115" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">6-将密码复制并粘贴到Kubernetes dasboard登录屏幕上，然后单击登录。现在，您应该能够访问仪表板了。</p><p id="4e96" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">仅此而已。现在，您应该拥有一个完整且功能齐全的本地Kubernetes集群。</p></div><div class="ab cl kc kd gp ke" role="separator"><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh ki"/><span class="kf bw bk kg kh"/></div><div class="hb hc hd he hf"><h2 id="06e0" class="kk kl hi bd km kn ko kp kq kr ks kt ku jb kv kw kx jf ky kz la jj lb lc ld le bi translated">什么叫没用？</h2><p id="01f3" class="pw-post-body-paragraph iq ir hi is b it lf iv iw ix lg iz ja jb lh jd je jf li jh ji jj lj jl jm jn hb bi translated">有时，您可能会在集群设置过程中遇到一些问题。别担心，我已经把最常见问题的解决方案贴在下面了。</p><ul class=""><li id="fd31" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">原木是你的朋友。如果服务没有启动或者发生了奇怪的事情，请检查日志。</li></ul><pre class="ll lm ln lo fd lp lq lr ls aw lt bi"><span id="df4a" class="kk kl hi lq b fi lu lv l lw lx">cat /var/log/syslog</span></pre><p id="8629" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">是一个好的开始。</p><ul class=""><li id="b12f" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">有一个IP密钥。本指南中的许多示例文件仅仅是示例。检查两遍，并按照第一部分所述，制作一个表格，将我的IP与你的IP进行比较。</li><li id="26b6" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">交换是否被禁用？etc不喜欢swap。确保按照步骤禁用它，并在重新启动时保持禁用状态。</li><li id="d79d" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">从这个问题开始向后看。哪个组件受到影响？为什么会受影响？有服务需要的配置文件吗？等等。</li><li id="3307" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">提问。我重视评论和问题，我喜欢团队发言和不和谐。问我一些问题(但是先试着自己解决)。</li><li id="2bb5" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">大概是vim吧。不要用vim。用纳米。</li><li id="0cc3" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">请查看我关于排除Kubernetes故障的帖子:</li></ul><div class="ms mt ez fb mu mv"><a rel="noopener follow" target="_blank" href="/@lyokowarrior14/troubleshooting-kubernetes-the-beginners-guide-2440ec400155"><div class="mw ab dw"><div class="mx ab my cl cj mz"><h2 class="hj b fi z dy na ea eb nb ed ef hh bi translated">Kubernetes故障排除:初学者指南</h2><div class="nc l"><h3 class="bd b fi z dy na ea eb nb ed ef dx translated">如果您过去曾与Kubernetes合作过，那么您可能会遇到一些问题…</h3></div><div class="nd l"><p class="bd b fp z dy na ea eb nb ed ef dx translated">medium.com</p></div></div><div class="ne l"><div class="nf l ng nh ni ne nj io mv"/></div></div></a></div><p id="ab3a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读。如果您有疑问或发现问题，请发表评论。</p><p id="b1c5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">~帕维尔</p></div></div>    
</body>
</html>