<html>
<head>
<title>How To Install A Private Pypi Server On AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS上安装私有Pypi服务器</h1>
<blockquote>原文：<a href="https://medium.com/swlh/how-to-install-a-private-pypi-server-on-aws-76993e45c610?source=collection_archive---------4-----------------------#2019-07-08">https://medium.com/swlh/how-to-install-a-private-pypi-server-on-aws-76993e45c610?source=collection_archive---------4-----------------------#2019-07-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/74837386c79e0d5615e3fbfd05c497d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2GQjliWjgBzjd1sF"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">Photo by <a class="ae iu" href="https://unsplash.com/@markusspiske?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Markus Spiske</a> on <a class="ae iu" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="2c9e" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">动机/背景:</strong></h1><p id="de32" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">什么是pypi服务器？那些经常使用python的人会知道，pypi基本上是托管所有我们都使用和喜爱的公共python包的服务器——例如，像pandas和requests这样的包。然后可以使用pip安装这些软件包。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="b7ee" class="la iw hi kw b fi lb lc l ld le">pip install pandas</span></pre><p id="d9a7" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">对于那些不熟悉python的人来说，可以在这里看一下公共的pypi服务器:</p><div class="lk ll ez fb lm ln"><a href="https://pypi.org/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab dw"><div class="lp ab lq cl cj lr"><h2 class="hj b fi z dy ls ea eb lt ed ef hh bi translated">PyPI——Python包索引</h2><div class="lu l"><h3 class="bd b fi z dy ls ea eb lt ed ef dx translated">Python包索引(PyPI)是Python编程语言的软件仓库。</h3></div><div class="lv l"><p class="bd b fp z dy ls ea eb lt ed ef dx translated">pypi.org</p></div></div><div class="lw l"><div class="lx l ly lz ma lw mb io ln"/></div></div></a></div><h2 id="4775" class="la iw hi bd ix mc md me jb mf mg mh jf ke mi mj jj ki mk ml jn km mm mn jr mo bi translated"><strong class="ak">那么，建立自己的私人pypi服务器有什么意义呢？</strong></h2><p id="5cbd" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">当你从公共pypi服务器安装软件包时，你正在安装其他天才写的软件包。然而，你可能在你的公司写了一些专有的东西。您希望与公司的每个人共享它，但不希望其他任何人通过公共服务器安装它。在这种情况下，建立您自己的轻量级pypi服务器可能是一种好方法。</p><p id="c7fc" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">在我的例子中，我们公司经常使用一个内部包来抽象从pandas数据框到mysql实例的数据上传和下载。然而，这个包只是简单地保存在一个文件夹中，并复制到每个新的项目repo中。我们意识到，如果我们必须从文件夹中更改任何源代码，我们将不得不为所有不同的reposs这样做——每个repo都有自己的文件夹副本。很明显，将源代码转化为自己的github项目，并作为一个包上传到我们自己的pypi服务器将是一个更好的选择。然而，从建立一个端到端的文档非常少。我们不得不到处寻找不同的片段来拼凑所有的东西。</p><p id="0a7e" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">因此，在本文的剩余部分，我将向您介绍我们使用现有的Docker映像和docker-compose在AWS上的EC2实例上设置我们自己的pypi-server的步骤。本指南希望您对docker图像和Docker合成有一个初步的了解。如果没有，请先阅读此处的文档:</p><p id="5e69" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">码头工人:</p><div class="lk ll ez fb lm ln"><a href="https://docs.docker.com/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab dw"><div class="lp ab lq cl cj lr"><h2 class="hj b fi z dy ls ea eb lt ed ef hh bi translated">码头文件</h2><div class="lu l"><h3 class="bd b fi z dy ls ea eb lt ed ef dx translated">开始使用Docker尝试我们新的多部分演练，包括编写您的第一个应用程序，数据存储…</h3></div><div class="lv l"><p class="bd b fp z dy ls ea eb lt ed ef dx translated">docs.docker.com</p></div></div><div class="lw l"><div class="mp l ly lz ma lw mb io ln"/></div></div></a></div><p id="0619" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">docker-撰写:</p><div class="lk ll ez fb lm ln"><a href="https://docs.docker.com/compose/" rel="noopener  ugc nofollow" target="_blank"><div class="lo ab dw"><div class="lp ab lq cl cj lr"><h2 class="hj b fi z dy ls ea eb lt ed ef hh bi translated">Docker撰写</h2><div class="lu l"><h3 class="bd b fi z dy ls ea eb lt ed ef dx translated">Compose是一个定义和运行多容器Docker应用程序的工具。要了解有关撰写的更多信息，请参考…</h3></div><div class="lv l"><p class="bd b fp z dy ls ea eb lt ed ef dx translated">docs.docker.com</p></div></div><div class="lw l"><div class="mq l ly lz ma lw mb io ln"/></div></div></a></div><p id="a2fb" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">在本指南的下一部分，我将假设您已经对以下内容有所了解:</p><ol class=""><li id="e5ef" class="mr ms hi jv b jw lf ka lg ke mt ki mu km mv kq mw mx my mz bi translated">在AWS上启动EC2实例</li><li id="40c0" class="mr ms hi jv b jw na ka nb ke nc ki nd km ne kq mw mx my mz bi translated">使用SSH连接到您的EC2实例</li><li id="5d82" class="mr ms hi jv b jw na ka nb ke nc ki nd km ne kq mw mx my mz bi translated">对bash命令的基本理解</li></ol><h1 id="8a4d" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">设置EC2实例:</strong></h1><p id="8544" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我假设您已经有了本教程的AWS帐户。如果没有，去https://aws.amazon.com<a class="ae iu" href="https://aws.amazon.com" rel="noopener ugc nofollow" target="_blank">设置一个。</a></p><p id="f529" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">一旦你有了一个帐户，就进入AWS主网站，点击屏幕右上角显示“登录控制台”的橙色按钮，登录到管理控制台。</p><p id="f4bc" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">登录后，您应该会在页面顶部的“查找服务”下看到一个搜索栏。在栏中键入EC2，然后单击自动建议选项。</p><p id="7213" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">接下来，您应该会看到<em class="nf"> EC2仪表板。</em>点击“创建实例”下的“启动实例”蓝色按钮。您将通过一系列步骤来启动EC2实例。第一步是为您的新实例选择一个图像。我们选择了第二种选择——Amazon Linux AMI 2018 . 03 . 0(HVM ), SSD卷类型，因为存储库应该已经包含Docker，并且python应该默认安装。</p><p id="8307" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">(每个步骤我就不赘述了。如果您是第一次设置EC2实例，请阅读AWS的设置指南。)</p><p id="d390" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">完成实例设置后，返回到<em class="nf"> EC2仪表板</em>，您应该能够看到新实例正在启动。等待几分钟，然后使用SSH进入您使用以下示例创建的新实例:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="a840" class="la iw hi kw b fi lb lc l ld le">ssh -i~/.ssh/YourPrivateKey.pem ec2-user@YourInstanceIPv4Address</span></pre><p id="d7fa" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">(注意这里ssh命令中的用户名是ec2-user，如果您选择ubuntu AMI，它将改为ubuntu@IPv4Address)</p><h1 id="7bfa" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">安装服务器软件包和依赖项:</strong></h1><p id="d6cd" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">假设您已经使用SSH成功连接到您的实例，您应该会看到类似下图的内容:</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ng"><img src="../Images/439cf6de2bf69b9b6743e7c40184fc4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QVCu8J3G-MU5Av8_9qGF6w.png"/></div></div></figure><p id="61b7" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">按照服务器提示进行软件包更新。(如果您为AMI使用了另一个linux发行版，那么您将需要使用它的本地包管理器)</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="8f32" class="la iw hi kw b fi lb lc l ld le">sudo yum update</span></pre><p id="0722" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">查看python3是否已经预装:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="936d" class="la iw hi kw b fi lb lc l ld le">sudo yum list | grep python3</span></pre><p id="768a" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如果没有，请安装您想要使用的版本:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="91a9" class="la iw hi kw b fi lb lc l ld le">sudo yum install python36</span></pre><p id="4150" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">接下来，安装docker:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="8fc7" class="la iw hi kw b fi lb lc l ld le">sudo yum install docker<br/># start the service<br/>sudo service docker start</span><span id="790e" class="la iw hi kw b fi nh lc l ld le"># give docker permission to run without using sudo every time<br/>sudo usermod -a -G docker ec2-user </span><span id="6227" class="la iw hi kw b fi nh lc l ld le"># different username if you are not using the amazon linux AMI</span><span id="3162" class="la iw hi kw b fi nh lc l ld le"># exit the instance to make sure the changes take effect<br/>exit</span></pre><p id="5b71" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">SSH回到实例并测试更改是否生效:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="e529" class="la iw hi kw b fi lb lc l ld le"># check if you can run docker without the sudo command<br/>docker info</span><span id="2cd7" class="la iw hi kw b fi nh lc l ld le"># if not, debug the previous steps. If so, run a test image<br/>docker run hello-world</span><span id="2306" class="la iw hi kw b fi nh lc l ld le"># you should see a hello message from docker after running the last command</span></pre><p id="3fac" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">现在，我们需要安装docker-compose:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="6062" class="la iw hi kw b fi lb lc l ld le"># run each of the following commands 1 at a time</span><span id="184f" class="la iw hi kw b fi nh lc l ld le">sudo curl -L <a class="ae iu" href="https://github.com/docker/compose/releases/download/1.21.0/docker-compose-`uname" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/compose/releases/download/1.21.0/docker-compose-`uname</a> -s`-`uname -m` | sudo tee /usr/local/bin/docker-compose &gt; /dev/null</span><span id="38ed" class="la iw hi kw b fi nh lc l ld le"># above version might be an older version, so if you want to download the most recent version, check their releases first</span><span id="8db3" class="la iw hi kw b fi nh lc l ld le"># give the proper permission for docker-compose<br/>sudo chmod +x /usr/local/bin/docker-compose</span><span id="3c68" class="la iw hi kw b fi nh lc l ld le"># create a symbolic link so you can run docker-compose by just typing docker-compose<br/>sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><span id="1d0f" class="la iw hi kw b fi nh lc l ld le"># check if the install worked<br/>docker-compose --version</span><span id="53d1" class="la iw hi kw b fi nh lc l ld le"># you should see docker-compose version x.xx.x, build xxxxxxx</span></pre><p id="19c8" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">恭喜你。服务器已经基本设置好了。现在，您只需要在EC2实例上设置实际的pypi服务器。</p><h1 id="2b9f" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">Pypi-服务器安装:</strong></h1><p id="82af" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">对于实际的pypi服务器本身，我们将使用官方支持的pypi服务器docker映像—<a class="ae iu" href="https://hub.docker.com/r/pypiserver/pypiserver" rel="noopener ugc nofollow" target="_blank">pypi server/pypi server:latest</a></p><p id="3468" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">但是在我们下载图像之前，我们需要设置一些东西。</p><p id="7daa" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">首先，我们需要建立一个目录来存储用户名和密码，pypi服务器将使用它们来验证上传或下载请求。我们为此使用了“htapasswd”包。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="d40d" class="la iw hi kw b fi lb lc l ld le"># install httpd-tools with yum<br/>sudo yum install httpd-tools</span><span id="6bea" class="la iw hi kw b fi nh lc l ld le"># switch to the user's home directory<br/>cd</span><span id="f345" class="la iw hi kw b fi nh lc l ld le"># make a new directory called auth<br/>mkdir auth</span><span id="1f7d" class="la iw hi kw b fi nh lc l ld le"># cd into the auth directory<br/>cd auth</span><span id="5a13" class="la iw hi kw b fi nh lc l ld le"># create a new .htpasswd file<br/>htpasswd -sc .htpasswd &lt;some_username&gt;</span><span id="75db" class="la iw hi kw b fi nh lc l ld le"># it will prompt you to enter a new password. Follow the prompts</span></pre><p id="b317" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">不错！您刚刚添加了第一个可以使用您的私有pypi服务器的用户。您可以添加任意数量的新用户。但是，您需要稍微修改命令，否则您将删除旧的。htpasswd文件。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="1bb5" class="la iw hi kw b fi lb lc l ld le"># -s instead of -sc from before<br/>htpasswd -s .htpasswd &lt;SomeNewUsername&gt;</span><span id="da7d" class="la iw hi kw b fi nh lc l ld le"># follow the prompts</span></pre><p id="67a6" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">现在，我们终于可以提取pypi-server映像并启动容器了！</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="d6b7" class="la iw hi kw b fi lb lc l ld le"># go to the user's home directory<br/>cd</span><span id="0bd8" class="la iw hi kw b fi nh lc l ld le"># create a new docker-compose.yml file<br/>touch docker-compose.yml</span><span id="b7d1" class="la iw hi kw b fi nh lc l ld le"># edit the file using vim (vim has a bit of a learning curve)<br/># but for now you just need to know a few things:</span><span id="6812" class="la iw hi kw b fi nh lc l ld le"># i means insert, you cannot type text until you press i first<br/># pressing esc will take you to visual mode, you cannot edit text<br/># in visual mode, but you can move your cursor around and use<br/># vim commands</span><span id="a455" class="la iw hi kw b fi nh lc l ld le"># vim commands start with :<br/># :w + [enter] will save the file<br/># :q + [enter] after saving will exit the file</span><span id="966f" class="la iw hi kw b fi nh lc l ld le"># you can combine them like this<br/># :wq + [enter]</span><span id="712d" class="la iw hi kw b fi nh lc l ld le"># let's write our docker-compose file<br/>vim docker-compose.yml</span><span id="8bcb" class="la iw hi kw b fi nh lc l ld le"># inside vim editor...</span><span id="9555" class="la iw hi kw b fi nh lc l ld le"># press i to go into insert mode</span><span id="760d" class="la iw hi kw b fi nh lc l ld le">version: '3.3'</span><span id="5fee" class="la iw hi kw b fi nh lc l ld le">services:<br/>  pypi-server:<br/>    image: pypiserver/pypiserver:latest<br/>    ports:<br/>      - "8081:8080"<br/>    container_name: pypi-server<br/>    volumes:<br/>      - type: bind<br/>        source: /home/ec2-user/auth<br/>        target: /data/auth<br/>      - type: volume<br/>        source: pypi-server<br/>        target: /data/packages<br/>    command: -P /data/auth/.htpasswd -a update,download,list /data/packages<br/>    restart: always<br/>volumes:<br/>  pypi-server:</span><span id="b4a0" class="la iw hi kw b fi nh lc l ld le"># press [esc] then :wq + [enter] to save and exit the file</span><span id="d47b" class="la iw hi kw b fi nh lc l ld le"># now print out the file you just edited to make sure it was saved<br/>cat docker-compose.yml</span><span id="9d35" class="la iw hi kw b fi nh lc l ld le"># you should see everything you wrote in the file</span></pre><p id="3aa4" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">我们在这里做了什么？我不会详细介绍我们写的每一行，但有几个要点。</p><p id="e108" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">首先，端口映射是import，因为我们不能直接向docker容器发出请求。相反，我们将向现有的主机EC2实例发出请求，因此我们将主机8081端口映射到docker容器8080端口。</p><p id="ed24" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">接下来，我们通过“container_name”给容器取了一个容易记住的名字。这样，通过使用<em class="nf"> pypi-server </em>而不是docker分配容器的长id，我们将来可以很容易地找到并使用这个容器。</p><p id="dfe8" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">我们还映射了我们创建的主机目录，它包含我们的。htpasswd文件复制到位于/data/auth的容器卷。这允许docker容器中的pypi服务器使用我们创建的主机文件来处理身份验证，以验证传入的凭证。</p><p id="9dec" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">然后，我们创建了一个命名卷“pypi-server ”,以映射到docker容器中的/data/packages卷。这允许我们在docker容器中上传到pypi服务器的包持久保存在我们在主机上创建的命名docker卷中。您可以通过键入以下命令来检查该卷:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="0ae9" class="la iw hi kw b fi lb lc l ld le">docker volume ls</span></pre><p id="de12" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">否则，如果容器由于某种原因关闭，已经上传的包将会丢失。</p><p id="1980" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">最后，我们将<em class="nf">重启</em>字段指定为“总是”。这确保了如果容器意外关闭，它将总是重新启动。</p><p id="7109" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">现在，您可以使用以下命令启动容器:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="f6f6" class="la iw hi kw b fi lb lc l ld le"># use docker-compose to run the container<br/>docker-compose up -d</span><span id="939d" class="la iw hi kw b fi nh lc l ld le"># the -d option runs the container in the background</span><span id="b86b" class="la iw hi kw b fi nh lc l ld le"># wait a few seconds then run<br/>docker container ps</span><span id="c15f" class="la iw hi kw b fi nh lc l ld le"># you should see a container running called pypi-server</span><span id="4eeb" class="la iw hi kw b fi nh lc l ld le"># exit the ec2 isntance<br/>exit</span></pre><p id="bb84" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">恭喜你。虽然有很多步骤，但是您的私有pypi服务器现在已经启动并运行在云上了！<strong class="jv ni">如果你已经知道如何从一个定制的pypi服务器上传和安装包，你可以就此打住。如果没有，继续读下去。</strong></p><h1 id="162f" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">上传软件包到您的Pypi服务器:</strong></h1><p id="3aa0" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">我不会详细介绍如何将包上传到pypi服务器，因为已经有很多精彩的指南了，所以我将链接到一个。即使您对建立自己的pypi服务器不感兴趣，您也应该学习如何做到这一点，因为上传到公共服务器的过程几乎是一样的。以下是我们用来准备上传包的指南:</p><div class="lk ll ez fb lm ln"><a rel="noopener follow" target="_blank" href="/@joel.barmettler/how-to-upload-your-python-package-to-pypi-65edc5fe9c56"><div class="lo ab dw"><div class="lp ab lq cl cj lr"><h2 class="hj b fi z dy ls ea eb lt ed ef hh bi translated">如何将python包上传到PyPi</h2><div class="lu l"><h3 class="bd b fi z dy ls ea eb lt ed ef dx translated">PyPi包索引是使python如此强大的属性之一:只需一个简单的命令，您就可以…</h3></div><div class="lv l"><p class="bd b fp z dy ls ea eb lt ed ef dx translated">medium.com</p></div></div><div class="lw l"><div class="nj l ly lz ma lw mb io ln"/></div></div></a></div><p id="72d0" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">现在假设您已经阅读了上面链接的文章，您可以使用下面的命令将您的包上传到本指南前面创建的pypi服务器。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="99e4" class="la iw hi kw b fi lb lc l ld le">twine upload --repository-url <a class="ae iu" href="http://(aws" rel="noopener ugc nofollow" target="_blank">http://(</a>ec2 IPv4 IP address):8081 dist/*</span></pre><p id="0332" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如果您已经正确设置了pypi服务器，并为EC2实例输入了正确的IP地址，您应该会看到上传成功。请记住，如果您停止并重新启动EC2服务器，您的IPv4 IP地址将会改变，除非您从AWS购买静态IP地址。</p><p id="4c1c" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">为了验证您的包是否已经上传，您可以使用您的浏览器在<a class="ae iu" href="http://(your" rel="noopener ugc nofollow" target="_blank"> http://( </a> ec2 IPv4 IP地址):8081访问pypi服务器，您应该会看到类似如下的内容:</p><figure class="kr ks kt ku fd ij er es paragraph-image"><div class="er es nk"><img src="../Images/d4c73e8aa5aec1a9dd099b9cde267975.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*odqa9N1uR3ux_d8KQomEaQ.png"/></div></figure><p id="284a" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">该页面将提供一个链接，供您查看pypi服务器上所有可用的包。如果您刚刚上传的包出现了，那么上传肯定是成功的。</p><h1 id="6eb2" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">从您的Pypi服务器下载:</strong></h1><p id="641e" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">现在，您可以通过运行以下命令，使用pip从您的pypi服务器安装软件包:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="d7af" class="la iw hi kw b fi lb lc l ld le">pip install --extra-index-url <a class="ae iu" href="http://(EC2" rel="noopener ugc nofollow" target="_blank">http://(EC2</a> IPv4 IP Address):8081 YourPackageName --trusted-host (EC2 IPv4 IP Address)</span></pre><p id="a49b" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如果您不想在pip命令中添加额外的url和可信主机，您可以在HOME目录中设置一个. pip目录，文件名为pip.conf，如下所示:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="606f" class="la iw hi kw b fi lb lc l ld le">[global]<br/>extra-index-url = <a class="ae iu" href="http://(EC2" rel="noopener ugc nofollow" target="_blank">http://(EC2</a> IPv4 IP Address):8081/<br/>trusted-host = (EC2 IPv4 IP Address)</span></pre><p id="1b31" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">确保您的pip是最新版本，尤其是在虚拟环境中。当我们的pip低于19.0.0版本时，使用上面的方法安装我们自己的包时，我们遇到了一些问题。</p><p id="49b1" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><strong class="jv ni">你也应该考虑为你的服务器设置使用SSL证书的https。</strong>否则，http将以明文形式通过网络流量发送您的用户名和密码。如果你现在只是想测试和学习，这很好，但是如果你真的有一些专有的东西，那么确保你尽快设置它。</p><p id="83d9" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">对大多数人来说，读到这里就足够了。然而，我们公司还有一个用例需要花一些时间来解决。<strong class="jv ni">如果你想混合使用私有包和公共包对图片进行分类，请继续阅读。</strong></p><h1 id="f049" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">如何使用自己的Pypi服务器构建Docker映像:</strong></h1><p id="65f8" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">当您将从pypi服务器下载的<em class="nf">命令复制到docker文件中时，问题就出现了。这是因为download命令会触发来自服务器的身份验证，这将要求您输入用户名和密码。当您从bash控制台使用pip下载包时，这是没问题的。但是，当使用docker-compose build构建映像时，该过程会失败，因为您无法在构建过程中手动输入凭据。不幸的是，docker-compose构建没有交互模式。可能有其他方法绕过这一点，但这里是我们如何做到这一点。</em></p><p id="3d5f" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">您需要以ARGs的形式在Dockerfile文件中添加两个变量。下面是我们使用的docker文件，但是去掉了敏感信息。</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="f5a6" class="la iw hi kw b fi lb lc l ld le">FROM python:3.7-slim-stretch<br/>MAINTAINER pmdbt "jerry@lofty.ai" </span><span id="380d" class="la iw hi kw b fi nh lc l ld le"># install dependencies</span><span id="b01a" class="la iw hi kw b fi nh lc l ld le">RUN apt-get update &amp;&amp; \<br/>apt-get install -yq gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 \<br/>libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 \<br/>libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 \<br/>libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 \<br/>ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget </span><span id="0484" class="la iw hi kw b fi nh lc l ld le"># start building from the home path of the image<br/>RUN cd<br/>COPY . /app<br/>WORKDIR /app </span><span id="0cfc" class="la iw hi kw b fi nh lc l ld le">ARG USERNAME<br/>ARG PASSWORD </span><span id="4762" class="la iw hi kw b fi nh lc l ld le">RUN pip install --upgrade setuptools</span><span id="949e" class="la iw hi kw b fi nh lc l ld le"><strong class="kw ni"># Append the username and password ARGS in front of server URL</strong><br/>RUN pip install --extra-index-url <a class="ae iu" href="http://$USERNAME:$PASSWORD@18.207.243.15:8081" rel="noopener ugc nofollow" target="_blank">http://$USERNAME:$PASSWORD@(EC2 IPv4 IP Address):8081</a> LoftyDataFetcher==0.1.3 --trusted-host (EC2 IPv4 IP Address)</span><span id="35e5" class="la iw hi kw b fi nh lc l ld le">RUN pip install -r requirements.txt <br/>ENV AWS_CONFIG_FILE=/root/.aws/config <br/>CMD ["python3", "-u","main.py"]</span></pre><p id="cf1c" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">请注意，我们对最初的下载命令所做的更改只是在服务器URL前面添加了$USERNAME:$PASSWORD@。这允许将用户名和密码的值传递给bash控制台中的映像构建过程，而不是将您的实际用户名和密码暴露给公司的其他人或互联网上的其他人。</p><p id="a3e6" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">然后编写您的标准docker-compose.yml文件，并使用以下命令运行“build ”:</p><pre class="kr ks kt ku fd kv kw kx ky aw kz bi"><span id="812a" class="la iw hi kw b fi lb lc l ld le"># pass in the username and password for your pypi server below<br/>docker build --build-arg USERNAME=&lt;YourUserName&gt; --build-arg PASSWORD=&lt;YourPassword&gt;</span><span id="9734" class="la iw hi kw b fi nh lc l ld le"># press enter and you should see your image starting to build and now docker will know how to handle the authentication portion of installing a package from your private pypi server</span></pre><h1 id="4efc" class="iv iw hi bd ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js bi translated"><strong class="ak">结论:</strong></h1><p id="bc18" class="pw-post-body-paragraph jt ju hi jv b jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq hb bi translated">搞定了。如果您一直遵循本指南，那么您现在应该知道如何在AWS EC2实例上部署您自己的带身份验证的私有pypi服务器，构建您自己的python包并上传到您的pypi服务器，从您的pypi服务器安装包，以及如何在docker映像构建过程中安装您自己的包。</p><p id="c1c9" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如果您使用另一个云提供商，如GCP或Azure，您应该能够忽略AWS设置部分，但仍然遵循指南的其余部分。</p><p id="7dd4" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">这个指南最终比我想要的要长，但是希望它能帮你省去很多我们在几个工作日里遇到的麻烦。如果任何人知道我所谈论的任何事情的更有效的过程，请随时在下面留下评论来帮助其他人。</p><p id="35ae" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated">如果您有任何问题，请随时联系我。</p><p id="0e82" class="pw-post-body-paragraph jt ju hi jv b jw lf jy jz ka lg kc kd ke lh kg kh ki li kk kl km lj ko kp kq hb bi translated"><a class="ae iu" href="https://www.linkedin.com/in/jerry-chu/" rel="noopener ugc nofollow" target="_blank"><strong class="jv ni"><em class="nf">Linkedin</em></strong></a><strong class="jv ni"><em class="nf">和</em></strong><a class="ae iu" href="https://github.com/pmdbt" rel="noopener ugc nofollow" target="_blank"><strong class="jv ni"><em class="nf">Github</em></strong></a></p></div></div>    
</body>
</html>