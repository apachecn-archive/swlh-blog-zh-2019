<html>
<head>
<title>Angular validation errors made easy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">角度验证错误变得简单</h1>
<blockquote>原文：<a href="https://medium.com/swlh/angular-validation-errors-made-easy-3bc1a837c6e7?source=collection_archive---------2-----------------------#2019-05-21">https://medium.com/swlh/angular-validation-errors-made-easy-3bc1a837c6e7?source=collection_archive---------2-----------------------#2019-05-21</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="de15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">角度<strong class="ih jd">反应形式</strong>很棒。动态性、验证和绑定使我——以及我所在社区的一部分——更喜欢它们而不是模板驱动的。然而，不管是被动的还是模板驱动的，<br/>表单应该让应用程序从用户那里收集数据，并向他们提供关于数据验证的反馈。</p><p id="7369" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">我们认为这两种策略都存在向用户显示错误消息的方式不佳的问题。在本文中，我将讲述我们如何在<a class="ae je" href="https://xtreamers.io" rel="noopener ugc nofollow" target="_blank"> <strong class="ih jd"> xtream </strong> </a> <strong class="ih jd">中尝试解决这个问题。</strong></p><h2 id="dfba" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">验证错误详细程度</h2><p id="99cb" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">我们如何显示输入的验证错误？正如《圣经》(也叫Angular documentation)所建议的，我们必须这样写</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx"><a class="ae je" href="https://angular.io/guide/form-validation#built-in-validators" rel="noopener ugc nofollow" target="_blank">https://angular.io/guide/form-validation#built-in-validators</a></figcaption></figure><p id="446d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">您可以通过在组件中添加一个getter来简化该模板:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="7777" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">验证变成了:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx"><a class="ae je" href="https://angular.io/guide/form-validation#built-in-validators" rel="noopener ugc nofollow" target="_blank">https://angular.io/guide/form-validation#built-in-validators</a></figcaption></figure><p id="6834" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一个只包含一个具有四种不同验证类型的字段的表单，我们已经完成了20行代码。模板驱动的情况与此也相差不远:您必须编写一组<code class="du kq kr ks kt b">if</code>语句，至少一个字段需要一个验证，并显示特定的消息。</p><p id="a8dc" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在开发<a class="ae je" href="https://sofan.it" rel="noopener ugc nofollow" target="_blank"> sofan </a>的过程中，在八月下旬的第一个登录页面要求姓名、姓氏、电子邮件、出生日期、城市和电话号码以及一些共识之后，我们开始寻找一种<strong class="ih jd">更有效的</strong>和<strong class="ih jd">动态</strong>方式来显示表单中的验证错误消息。</p><h2 id="a453" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">要求</h2><p id="a531" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">在Utopia中，我们只需在创建<code class="du kq kr ks kt b">FormControls</code>时设置验证器，基于错误类型的<strong class="ih jd">语言特定的</strong>消息将出现在输入下方。消息应该根据字段和形式而<strong class="ih jd">不同，并且可能是参数化的，因此如果我们将验证器从<code class="du kq kr ks kt b">Validators.min(4)</code>更改为<code class="du kq kr ks kt b">Validators.min(5)</code>，消息也会相应地更改。此外，对于像<code class="du kq kr ks kt b">required</code>这样的一般性错误，我们不想到处复制和粘贴“这个字段是必需的”。相反，如果特定于表单的验证类型不存在，我们希望有一个通用验证类型的后备。</strong></p><p id="22f0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样做我们可以专注于组件内部的验证逻辑，只关心语言文件中的消息，避免那些可怕的<code class="du kq kr ks kt b">ngIf</code>子句污染模板。</p><p id="ac0d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">经过一些谷歌搜索和头脑风暴，我们创建了一个涵盖所有需求的小库。</p><h1 id="f75c" class="ku jg hi bd jh kv kw kx jl ky kz la jp lb lc ld js le lf lg jv lh li lj jy lk bi translated">@ xtream/ngx-验证-错误</h1><p id="a0cf" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">最终的解决方案是一组组件，允许我们编写看起来<strong class="ih jd">干净</strong>和<strong class="ih jd">简短</strong>的表单模板:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx">Final usage of @xtream/ngx-validation-errors</figcaption></figure><p id="2774" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">让我们看看<code class="du kq kr ks kt b">ValidationContextComponent</code>、<code class="du kq kr ks kt b">FormFieldContainerComponent</code>和<code class="du kq kr ks kt b">InputErrorsComponent</code>是如何完成我们需要的。</p><h2 id="1b49" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">InputErrorsComponent</h2><p id="79d5" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">该组件接受一组错误消息和参数，并使用<a class="ae je" href="https://github.com/ngx-translate/core" rel="noopener ugc nofollow" target="_blank"><strong class="ih jd">@ ngx-translate</strong></a>显示它们。消息只是翻译键，如“新英雄”。NAME.ERRORS.MINLENGTH”和参数是一个丰富错误信息的JavaScript对象，比如<code class="du kq kr ks kt b">{minlength: 8, actuallength: 6}</code>，所以我们可以使用<code class="du kq kr ks kt b">{{messageKey | translate:params}}</code>。我们将很快看到这个组件是如何添加到DOM中的。输入错误在输入下方显示为红色文本；使用<code class="du kq kr ks kt b">validationContext</code>的<code class="du kq kr ks kt b">innerValidationError</code>属性，你可以移动输入中的错误，例如，一个黑暗的背景。</p><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es ll"><img src="../Images/54a8b2917a3bed647e8ac466253ad238.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*fu6aadJ_qJayU6n0M2iQMg.png"/></div></figure><figure class="kf kg kh ki fd kj er es paragraph-image"><div class="er es lo"><img src="../Images/68004ceb6b0ba9a78c8cc9cf8486d48a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*culEXjRFOOb-SkFFJDVVpQ.png"/></div><figcaption class="km kn et er es ko kp bd b be z dx">Errors showed inside input with <strong class="bd lp">innerValidationError </strong>set to true</figcaption></figure><h2 id="6bce" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">ValidationContexComponent</h2><p id="bd90" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">该组件的职责是查询所有内部的<code class="du kq kr ks kt b">FormFieldContainers</code>，并在其中设置作为输入传递的验证上下文。上例中是“<em class="lq">新_英雄</em>”。这允许使用特定于每个表单错误消息。</p><h2 id="951e" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">FormFieldContainerComponent</h2><p id="a7be" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">该组件将输入包装在一个容器中，这样我们就可以动态地添加或删除它下面的错误组件。这是模板。</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx">Container component to wrap input and add errors</figcaption></figure><p id="24af" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用内容投影，我们在输入的底部添加了传递错误消息和参数的<code class="du kq kr ks kt b">InputErrorsComponent</code>。</p><p id="d6d1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">然后<code class="du kq kr ks kt b">FormFieldContainerComponent</code>开始变魔术:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="e926" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">组件使用<strong class="ih jd"> @ContentChild </strong>选择其内容中的<code class="du kq kr ks kt b">FormControlName</code> <strong class="ih jd"> </strong>。如果表单控件是无效的、脏的和被触摸过的，它使用模板创建当前错误的列表</p><p id="f2df" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kq kr ks kt b">${validationContext}.${fieldName}.ERRORS.${errorType}</code></p><p id="f3db" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从而转换<strong class="ih jd">中的字段名和错误类型。使用errors对象中的关键字以及<strong class="ih jd">消息参数</strong>来识别<strong class="ih jd">错误类型</strong>(您可以在这里直接查看内置验证器<a class="ae je" href="https://github.com/angular/angular/blob/master/packages/forms/src/validators.ts" rel="noopener ugc nofollow" target="_blank">，但是它也可以使用自定义验证器)。</a></strong></p><p id="015a" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果生成的关键字不存在于翻译中，则消息退回到可配置的默认验证上下文(如“GENERAL”)，删除字段名:“NEW_HERO”。NAME.ERRORS.MINLENGTH“变成”通用。所以你可以保留一些基本的错误。</p><p id="d7f8" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">最后，如果组件能够读取表单控件链接到的本地html元素，它还会切换类<code class="du kq kr ks kt b">is-invalid</code>，例如，您可以使用该类用红色边框标记输入。</p><h2 id="30a8" class="jf jg hi bd jh ji jj jk jl jm jn jo jp iq jq jr js iu jt ju jv iy jw jx jy jz bi translated">图书馆使用</h2><p id="4b4e" class="pw-post-body-paragraph if ig hi ih b ii ka ik il im kb io ip iq kc is it iu kd iw ix iy ke ja jb jc hb bi translated">我们知道错误显示的方式和基础验证上下文的观点。在将验证组件提取到一个可重用的库中时，我们开发了用于配置的<code class="du kq kr ks kt b">forRoot</code>静态方法。</p><p id="3d44" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">首先，使用以下命令安装它:</p><p id="a982" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kq kr ks kt b">npm i @xtream/ngx-validation-errors</code></p><p id="4fe0" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在您的<code class="du kq kr ks kt b">app.module.ts</code>中添加:</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx">Simple library import</figcaption></figure><p id="e064" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在你可以在你的模板中使用<strong class="ih jd"> validationContext </strong>和<strong class="ih jd"> formFieldContainer </strong>。</p><p id="6c96" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">自定义一般上下文和错误组件使用</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div><figcaption class="km kn et er es ko kp bd b be z dx">Customised library import</figcaption></figure><p id="4bae" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><code class="du kq kr ks kt b">errorsComponent</code>必须遵守下面的接口，以便可以用默认接口替换。</p><figure class="kf kg kh ki fd kj"><div class="bz dy l di"><div class="kk kl l"/></div></figure><p id="6c15" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">记得将其添加到<strong class="ih jd"> entryComponents </strong>列表中，否则不能使用组件工厂动态实例化。</p><p id="47dd" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">你可以在<a class="ae je" href="https://github.com/xtreamsrl/ngx-validation-errors" rel="noopener ugc nofollow" target="_blank"> <strong class="ih jd"> github repo </strong> </a>中找到带库和演示的整个Angular workspace。该库的第一个alpha版本可以在npm注册表中以名称<a class="ae je" href="https://www.npmjs.com/package/@xtream/ngx-validation-errors" rel="noopener ugc nofollow" target="_blank"><strong class="ih jd">@ xtream/ngx-validation-errors</strong></a><strong class="ih jd">获得。</strong></p><p id="3ab7" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这是一项正在进行的工作，所以如果你发现错误或你认为某些<br/>丢失了，请打开一个问题或提交一份公关。</p></div><div class="ab cl lr ls gp lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="hb hc hd he hf"><p id="d27c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">感谢您阅读这篇文章！</p><p id="504c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><em class="lq">在这里分享任何评论和提出任何问题或通过我的</em> <a class="ae je" href="https://www.linkedin.com/in/luca-micieli" rel="noopener ugc nofollow" target="_blank"> <em class="lq"> LinkedIn个人资料</em> </a> <em class="lq">取得联系。</em></p></div></div>    
</body>
</html>