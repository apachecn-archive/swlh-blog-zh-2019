<html>
<head>
<title>How to Access Data From the Beta Channel of Graph API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Graph API的Beta通道访问数据</h1>
<blockquote>原文：<a href="https://medium.com/swlh/how-to-access-data-from-the-beta-channel-of-graph-api-d22d95d3f23a?source=collection_archive---------75-----------------------#2019-07-08">https://medium.com/swlh/how-to-access-data-from-the-beta-channel-of-graph-api-d22d95d3f23a?source=collection_archive---------75-----------------------#2019-07-08</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/c3e0a57a27014ef99a2e412e19bbcdf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*shZQYDCtWiRtLyuymWU8xg.jpeg"/></div></div></figure><p id="6423" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">Microsoft Graph API的所有新功能首先在测试版中提供。通过使用测试版，您可以提前获得新功能。微软经常添加新功能，这可以在他们的GitHub changelog <a class="ae jo" href="https://github.com/microsoftgraph/microsoft-graph-docs/blob/master/concepts/changelog.md" rel="noopener ugc nofollow" target="_blank">这里</a>看到。</p><p id="3ca1" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在这篇文章中，我们将做三件事:</p><ul class=""><li id="92a4" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">创建Azure Active Directory应用程序注册</li><li id="fd70" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">通过注册的应用程序获取访问令牌</li><li id="3139" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">在测试版上调用图形API</li></ul><p id="292b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这都是通过使用Azure门户和实现代码来调用C#中的Graph API来完成的。</p><h1 id="c63a" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">向您的Azure Active Directory添加应用程序</h1><p id="867b" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">为了访问Graph API，我们需要在Azure Active Directory (AAD)中注册一个应用程序。此应用程序可用于添加权限。然后，该AAD的管理员可以同意您选择的权限。让我们一步一步来。</p><p id="eb2b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">打开Azure门户，转到要添加应用程序的AAD。现在，您可以像这样添加新的应用程序</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/5177c7faadc304e4c3b86549f2bb50eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tDEknNdyFS_U0zpo.gif"/></div></div></figure><p id="6997" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建应用程序注册后，您可以看到我们在稍后阶段需要的两个重要id。这是<strong class="is ll">应用程序(客户端)Id </strong>和<strong class="is ll">目录(租户)Id </strong>。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lm"><img src="../Images/65c75d19d86c550a7d54d6da7b13aafb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/0*9Z7NQaVG2C8Bz-7z.png"/></div></div></figure><p id="d301" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下一步是向应用程序注册添加权限。这些权限赋予应用程序访问资源的能力。在我们的例子中，这是Graph API。让我们添加<strong class="is ll">目录。Read.All </strong>允许我们读取这个AAD中的所有内容，但不能修改它。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/58d220b624392582d7ce4e3122c4899c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2LDoQTSlnJ2cQ8iH.gif"/></div></div></figure><p id="b04b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">正如您可能已经看到的，有两种类型的权限:</p><ul class=""><li id="0452" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated"><strong class="is ll">委托权限</strong> —这些权限在有登录用户时使用。通常用于具有AD认证的门户或Azure功能。</li><li id="b68f" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated"><strong class="is ll">应用权限</strong> —应该只在后台服务上使用。这些权限只能由管理员授予。</li></ul><p id="1305" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在应用注册有了我们想要的权限，还是没有授予。要授予对此广告的权限，我们需要一个管理员帐户给予同意。这可以在我们刚刚添加新权限的“API权限”页面上完成。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ln"><img src="../Images/059df2204bb9c6c2f72292a9786eee47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*MVXPLYrW1jt34ivU.png"/></div></div></figure><p id="ba78" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同意许可后，只剩下一件事要做，那就是给应用程序添加一个秘密。这基本上和给你使用应用程序的密码是一样的。只有在这种情况下，你可以有多个秘密，每个不同的到期时间。你也可以删除这些秘密。要添加密码，我们需要进入“证书和密码页”。</p><figure class="lh li lj lk fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es lg"><img src="../Images/3484c2a51f8adfe14be42aaafcf57408.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hpLOPiuqDKn3OGJ3.gif"/></div></div></figure><p id="0195" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请记住，你只能看到这个秘密一次。现在我们已经完成了这项工作，我们需要在下一步中使用以下数据:</p><p id="2997" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">租户id:' 5d 1821 a3-a004–4c 0–95 D5-cb2e 797 ceaf 1 '<br/>应用Id或客户端Id:' 42903 c50–6fc 9–40d b-a131–87f 4522 DCF 56 '<br/>应用机密或客户端机密:' fe_？' xg+VhSxe_iq4RSw9TE4AUlddktg8 '</p><p id="913e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们只为单个租户创建了一个应用程序注册，大部分是默认设置。如果你想了解更多关于多租户应用的详细信息，你可以点击这里进入微软文档<a class="ae jo" href="https://docs.microsoft.com/nl-nl/azure/active-directory/develop/quickstart-register-app" rel="noopener ugc nofollow" target="_blank">。</a></p><h1 id="6622" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">获取访问令牌</h1><p id="8b8b" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">为了访问Graph API，我们首先需要获得一个访问令牌。这个令牌可以在以后用作承载授权报头。为此我使用了微软的NuGet包<strong class="is ll">。identity . Client</strong>4.0版本。</p><pre class="lh li lj lk fd lo lp lq lr aw ls bi"><span id="e739" class="lt ke hi lp b fi lu lv l lw lx">private async Task&lt;string&gt; GetAccessToken( string tenantId, string clientId, string clientSecret) { var builder = ConfidentialClientApplicationBuilder .Create(clientId) .WithClientSecret(clientSecret) .WithTenantId(tenantId) .WithRedirectUri("http://localhost/") .Build(); var acquiredTokenResult = builder.AcquireTokenForClient( // Here we set the scope to https://graph.microsoft.com/.default new List&lt;string&gt; { "https://graph.microsoft.com/.default" }); var tokenResult = await acquiredTokenResult.ExecuteAsync(); return tokenResult.AccessToken; }</span></pre><h1 id="f2d6" class="kd ke hi bd kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la bi translated">调用图形API</h1><p id="d300" class="pw-post-body-paragraph iq ir hi is b it lb iv iw ix lc iz ja jb ld jd je jf le jh ji jj lf jl jm jn hb bi translated">通常你只需要使用微软的图形API客户端SDK。图但是即使是预览版也没有所有可用的调用。因此，我不使用这个NuGet。相反，通过使用一个简单的HttpClient，我们可以达到同样的效果。</p><p id="d1fc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">下面的代码将执行以下操作:</p><ul class=""><li id="ca4d" class="jp jq hi is b it iu ix iy jb jr jf js jj jt jn ju jv jw jx bi translated">检索访问令牌</li><li id="8bab" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">将版本设置为beta</li><li id="e627" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">设置端点和我们想要执行的操作</li><li id="8ef6" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">创建HTTP客户端</li><li id="a97e" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">设置包括授权承载报头的报头</li><li id="9ec1" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">发送实际上是HTTP get的请求</li><li id="a96b" class="jp jq hi is b it jy ix jz jb ka jf kb jj kc jn ju jv jw jx bi translated">将结果作为字符串读取，因为响应将采用JSON格式</li></ul><pre class="lh li lj lk fd lo lp lq lr aw ls bi"><span id="6c70" class="lt ke hi lp b fi lu lv l lw lx">private async Task CallGraphApiBetaChannel() { // Retrieve the access token var accessToken = await GetAccessToken( "5d1821a3-a004-4cc0-95d5-cb2e797ceaf1", "42903c50-6fc9-40db-a131-87f4522dcf56", "fe_?xg+VhSxe_iq4RSw9TE4AUlddktg8"); // Set the version to beta var graphApiVersion = "beta"; // 'beta' or 'v1.0' // Set the endpoint and the action we want to execute var endpoint = $"https://graph.microsoft.com/{graphApiVersion}"; var action = "/applications"; // Create the http client using (var client = new HttpClient()) using (var request = new HttpRequestMessage(HttpMethod.Get, endpoint + action)) { // Set the headers including the authorization bearer header request.Headers.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json")); request.Headers.Authorization = new AuthenticationHeaderValue("Bearer", accessToken); // Sending the request which actually is a http get using (var response = await client.SendAsync(request)) { if (response.IsSuccessStatusCode) { // Read the result as string, since the response will be json var result = await response.Content.ReadAsStringAsync(); // Do something with the result } } } }</span></pre><p id="bef3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">得到结果后，您可以按照自己的方式解析响应。请记住，如果您从JSON生成了一个类模型，它可能会在任何时候被破坏，因为他们会定期更新测试版。</p><p id="174c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果一切顺利，你应该能够在Azure Active Directory中检索到所有可用的应用程序。在我看来，这非常容易使用，你可以将action变量更改为你在beta参考文档<a class="ae jo" href="https://docs.microsoft.com/en-us/graph/api/overview?view=graph-rest-beta" rel="noopener ugc nofollow" target="_blank">中找到的任何方法。同样，通过使用这个，您可以控制如何解析响应。</a></p><p id="a12a" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">源代码可以在我的GitHub <a class="ae jo" href="https://github.com/foppenm/Microsoft-Graph-API-Beta" rel="noopener ugc nofollow" target="_blank">这里</a>找到</p><p id="432b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢阅读！</p></div><div class="ab cl ly lz gp ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="hb hc hd he hf"><p id="4da5" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><em class="mf">原载于2019年7月8日https://www.re-mark-able.net</em><a class="ae jo" href="https://www.re-mark-able.net/how-to-access-data-from-the-beta-channel-of-graph-api/" rel="noopener ugc nofollow" target="_blank"><em class="mf"/></a><em class="mf">。</em></p></div></div>    
</body>
</html>