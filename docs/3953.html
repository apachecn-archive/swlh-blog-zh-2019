<html>
<head>
<title>Aion4j Tips — Testing Contract to Contract call with Embedded AVM</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Aion4j提示—使用嵌入式AVM测试合同对合同呼叫</h1>
<blockquote>原文：<a href="https://medium.com/swlh/aion4j-tips-testing-contract-to-contract-call-with-embedded-avm-3f7acbbca8e5?source=collection_archive---------38-----------------------#2019-05-26">https://medium.com/swlh/aion4j-tips-testing-contract-to-contract-call-with-embedded-avm-3f7acbbca8e5?source=collection_archive---------38-----------------------#2019-05-26</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><p id="1f88" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在这篇文章中，我将解释如何使用嵌入式AVM和BloxBean的Aion4j工具测试契约到契约的交互。</p><p id="bed4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果你是第一次在这里听说AVM和Aion4j，你可以查看“背景”部分的简要概述。否则，可以直接跳转到“<strong class="ih jd">合同到合同调用</strong>部分。</p><h1 id="679f" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">背景</h1><p id="bee9" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated"><strong class="ih jd"> AVM (Aion虚拟机)</strong>——简而言之，<strong class="ih jd"> AVM </strong>在区块链上运行Java字节码，使开发者能够用Java构建基于区块链的智能合约。永恒之塔区块链使用AVM来支持用Java语言编写的智能合同。</p><p id="9085" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih jd"> Aion4j </strong> —一套使用AVM进行智能合约开发的开发工具。目前，它由以下两个工具组成:</p><blockquote class="kh ki kj"><p id="4528" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated"><strong class="ih jd"> Aion4j maven插件</strong> —一个Maven插件，使用Maven构建工具为Java中的智能契约开发提供端到端工具支持。</p><p id="c377" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated"><strong class="ih jd"> Aion4j IDEA (IntelliJ)插件</strong> —一个IntelliJ IDE插件，支持在IntelliJ IDE中进行基于AVM的智能合同开发。</p></blockquote><p id="25a4" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这两种工具都支持智能合约部署和测试，适用于:</p><ul class=""><li id="1731" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">Aion内核</li><li id="d567" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">嵌入式AVM</li></ul><p id="b2c3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">Aion4j工具支持从Intellij IDE和命令行在远程<strong class="ih jd"> Aion内核</strong>或<strong class="ih jd"> Aion区块链</strong>上部署和测试Java智能合约。它支持部署、契约方法调用、契约事务、转移等功能。</p><p id="5c7e" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">使用一个<strong class="ih jd">嵌入式</strong> <strong class="ih jd"> AVM </strong>是开发和测试智能契约的最快和最简单的方法。有了嵌入式AVM，开发人员在开发过程中不需要实际的区块链。Aion4j自动创建一个嵌入式内核，该内核封装了AVM执行引擎，并直接在ide内部提供了一个智能契约执行环境。内核的状态存储在开发者机器的本地文件系统中。这种方法的几个好处是:</p><ul class=""><li id="bbbc" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">它提供了一个轻量级的智能契约执行环境</li><li id="9edb" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">开发人员可以根据测试场景控制或重置内核的状态。(创建新帐户、向帐户分配令牌、重置嵌入式内核存储等。)</li><li id="8ecb" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">运行单元测试</li><li id="f8a9" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">由于没有挖掘的概念，所以在执行智能合约后，状态变化会立即反映出来。</li></ul><p id="4b51" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">默认情况下，嵌入式内核的状态存储在项目目标文件夹下的一个名为“<strong class="ih jd">storage”</strong>的文件夹中。</p><h1 id="2701" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">合同对合同呼叫</h1><blockquote class="kh ki kj"><p id="f082" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated">以下链接解释了如何使用IntelliJ IDE创建新的基于Avm的智能合约项目。</p><p id="c79b" class="if ig kk ih b ii ij ik il im in io ip kl ir is it km iv iw ix kn iz ja jb jc hb bi translated"><a class="ae lc" href="https://docs.aion.network/docs/project-setup" rel="noopener ugc nofollow" target="_blank">https://docs . aion . network/docs/project-setup</a></p></blockquote><p id="bc8d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如前所述，默认情况下，嵌入式AVM的存储文件夹是在项目的目标文件夹下创建的。它会在每个构建和部署周期中被清理，这在单个项目中测试智能合约时非常有用。</p><p id="1c90" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">但是，假设您有多个智能合约项目，并且存在合约间调用。例如:智能合同A正在智能合同B中调用方法。由于智能合同A的项目和智能合同B的项目将有自己的存储文件夹，使用默认配置，您无法在嵌入式AVM内核中测试合同对合同的调用。</p><p id="ee1f" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">因此，如果您希望嵌入式内核的状态(在存储文件夹中)在项目间共享，那么您需要在项目文件夹之外的某个地方配置存储文件夹路径。由于共享存储文件夹不在目标文件夹中，因此它也可以跨多个构建周期存在。</p><h1 id="3a94" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated">那么如何配置存储文件夹呢？</h1><p id="2093" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">如果您使用的是Aion4j Intellij IDEA插件，您可以在AVM的配置屏幕中提供一个自定义的存储文件夹路径。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ld"><img src="../Images/04153824714b67ef5548ce7a7c965104.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BMlnHCboQosM373ocEYFNg.png"/></div></div></figure><p id="3d7c" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这样，下次从IDE中构建和部署项目时，将在指定的自定义存储文件夹下创建嵌入式AVM的存储文件夹，并且在构建过程中不会删除该文件夹。</p><p id="6afa" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">如果您从命令行maven命令使用Aion4j maven插件，您可以通过以下任一方式提供自定义存储路径</p><ul class=""><li id="e461" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc kt ku kv kw bi translated">在maven命令行中提供-Dstorage-path= <path>或者，</path></li><li id="5c04" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc kt ku kv kw bi translated">在aion4j-maven-plugin配置中设置<strong class="ih jd"> storagePath </strong>属性。</li></ul><h1 id="acdb" class="je jf hi bd jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka kb bi translated"><strong class="ak">代码示例</strong></h1><p id="3fe7" class="pw-post-body-paragraph if ig hi ih b ii kc ik il im kd io ip iq ke is it iu kf iw ix iy kg ja jb jc hb bi translated">本文中的代码样本摘自Aion的文档页面(<a class="ae lc" href="https://docs.aion.network/docs/contract-to-contract" rel="noopener ugc nofollow" target="_blank">https://docs . Aion . network/docs/contract-to-contract</a>)。你可以在本页找到其他有用的合同样本。</p><p id="7efb" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih jd">返还人或被叫合同</strong></p><p id="76b3" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">从另一个智能协定(调用方)调用此智能协定的方法。</p><p id="fe06" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">创建一个智能协定项目并移除所有生成的方法。将以下方法复制到智能协定的类中。</p><pre class="le lf lg lh fd lp lq lr ls aw lt bi"><span id="01ab" class="lu jf hi lq b fi lv lw l lx ly">@Callable     <br/>public static String getString(int index) {<br/>     String[] myStr = { "Hello AVM!", "AVM is great - From Callee" };          <br/>     return myStr[index]        <br/> }</span></pre><p id="08a2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">这个方法只是从数组的特定索引返回一个字符串。为了调用这个方法，调用方契约需要在契约方法调用期间传递一个<strong class="ih jd">索引</strong>值<strong class="ih jd"> </strong>作为参数。</p><p id="a8f2" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">现在，从IDE部署此协定，并复制已部署协定的地址。这个地址将在下一节中用于从另一个契约中调用契约方法。协定状态现在存储在自定义存储路径位置下。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es lz"><img src="../Images/2aba787fe0850000ae9002e814b57ba3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o8kknwEKlnOiIbDPGzCJMA.png"/></div></div></figure><p id="5409" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih jd">来电合同</strong></p><p id="baec" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">调用方智能协定调用另一个智能协定的方法。这里有一个调用方契约的示例代码。</p><pre class="le lf lg lh fd lp lq lr ls aw lt bi"><span id="875b" class="lu jf hi lq b fi lv lw l lx ly">    private static Address calleeContractAddress;<br/>    <br/>    static {<br/>        ABIDecoder decoder = new ABIDecoder(Blockchain.getData());<br/>        calleeContractAddress = decoder.decodeOneAddress();<br/>    }<br/><br/>    @Callable<br/>    public static String getStringInAnotherContract(int index) {<br/>        ABIStreamingEncoder encoder = new ABIStreamingEncoder();<br/>        byte[] data = encoder.encodeOneString("getString")<br/>                .encodeOneInteger(index)<br/>                .toBytes();<br/>        Result getString = Blockchain.call(calleeContractAddress, BigInteger.valueOf(0), data, Blockchain.getRemainingEnergy());<br/>        ABIDecoder decoder = new ABIDecoder(getString.getReturnData());<br/>        String myString = decoder.decodeOneString();<br/>        return myString;<br/>    }</span></pre><p id="cfbf" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在部署调用方协定时，最好不要硬编码被调用方协定的地址，而是将被调用方的地址作为部署参数传递。您可以参考<em class="kk">静态</em>块来查看如何检索部署参数并将其存储在变量中。</p><p id="3ea1" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署参数可以通过Intellij IDE中的<em class="kk"> Aion虚拟机- &gt;配置部署参数</em>选项进行设置。</p><figure class="le lf lg lh fd li er es paragraph-image"><div role="button" tabindex="0" class="lj lk di ll bf lm"><div class="er es ma"><img src="../Images/f878e2286a15e1c9cca6a9e997df0a8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BpX20niAETZl3hVGpDfhbw.png"/></div></div></figure><p id="d106" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">或者，如果您使用的是maven命令行，您可以将部署参数传递为-Dargs = "-A 0b 425374 b 193 C5 aa 9 EC 9 e 775 aa 34 c 6 DD 357 fac BD 45 e 9d 603 A 12 b 41 f 36d 9 FB 59 b "</p><p id="790d" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">在此示例中，“<code class="du mb mc md lq b">getStringInAnotherContract"</code>是调用被调用者的协定的方法。此方法将一个索引值传递给被调用方协定的方法，并获取返回的字符串。</p><p id="8455" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">部署调用方协定后，您现在可以从IDE的编辑器中调用“getStringInAnotherContract”方法来启动对被调用方的协定调用并获取结果。</p><p id="5888" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated"><strong class="ih jd">视频</strong> -使用Aion4j在IntelliJ中进行合同对合同测试。</p><figure class="le lf lg lh fd li"><div class="bz dy l di"><div class="me mf l"/></div></figure><p id="b374" class="pw-post-body-paragraph if ig hi ih b ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc hb bi translated">资源:</p><ol class=""><li id="db4c" class="ko kp hi ih b ii ij im in iq kq iu kr iy ks jc mg ku kv kw bi translated"><a class="ae lc" href="https://aion.network/" rel="noopener ugc nofollow" target="_blank">https://Aion . network/</a>—Aion网站</li><li id="e983" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mg ku kv kw bi translated"><a class="ae lc" href="https://docs.aion.network/docs/intellij-plugin" rel="noopener ugc nofollow" target="_blank">https://docs . aion . network/docs/Intellij-Plugin</a>—aion 4j Intellij Plugin Doc</li><li id="3ef9" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mg ku kv kw bi translated"><a class="ae lc" href="https://docs.aion.network/docs/maven-and-aion4j" rel="noopener ugc nofollow" target="_blank">https://docs . aion . network/docs/Maven-and-aion 4j</a>—aion 4j Maven插件文档</li><li id="816e" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mg ku kv kw bi translated"><a class="ae lc" href="https://github.com/aionnetwork/avm" rel="noopener ugc nofollow" target="_blank">https://github.com/aionnetwork/avm</a>—AVM GitHub</li><li id="8fda" class="ko kp hi ih b ii kx im ky iq kz iu la iy lb jc mg ku kv kw bi translated"><a class="ae lc" href="https://www.bloxbean.com" rel="noopener ugc nofollow" target="_blank">https://www.bloxbean.com</a>—豆花</li></ol></div></div>    
</body>
</html>