<html>
<head>
<title>A Study on How Cisco Umbrella Roaming Client Works</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">思科伞形漫游客户端工作原理研究</h1>
<blockquote>原文：<a href="https://medium.com/swlh/a-study-on-how-cisco-umbrella-roaming-client-works-f3cd552c7112#2019-01-29">https://medium.com/swlh/a-study-on-how-cisco-umbrella-roaming-client-works-f3cd552c7112#2019-01-29</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><h1 id="b554" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">。/intro/article </strong></h1><p id="d9ed" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">没有比必要性更好的老师了，我花时间研究了思科的伞漫游客户端是如何工作的。</p><p id="94b3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">下面的发现和信息是我通过阅读和验证发现的，没有机密信息被共享。</p><h1 id="aa59" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">。/intro/subject </strong></h1><p id="4917" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">如果你还不知道，思科保护伞公司是相当可怕的！</p><p id="9e35" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">思科100%基于云的DNS解析器利用:</p><p id="2e85" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">机器学习，</p><p id="7e30" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">云仪表板，</p><p id="8d39" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">与第三方解决方案的定制集成，</p><p id="93c5" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">用于实时文件分析的高级恶意软件防护(Cisco AMP)集成，甚至</p><p id="fbb9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">不可靠的基于SSL的网站的基于云的代理，</p><p id="75fd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">适用于多种操作系统的网上和网外解决方案。</p><p id="c88c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">所有这些都是为了确保您的DNS响应您想要的策略(和安全域)。</p><p id="e3de" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">更不用说它在过去一年中的许多其他添加和增强了。</p><h1 id="7eca" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">。/intro/动机</strong></h1><p id="53a4" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">但是，当我站在聚光灯下，介绍思科保护伞公司的奇迹及其网上/网下能力时，我经常会被问到:</p><blockquote class="kg kh ki"><p id="6f0d" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">"漫游客户端是如何工作的？"</p></blockquote><p id="e22c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您可以看到，Cisco Umbrella的离网安全的核心组件是轻量级连接器，它被部署为专用连接器(称为“漫游客户端”，从现在起也称为“RC”)或Anyconnect中的模块(称为“漫游安全模块”)—这就是所有离网保护和内容安全强制实施魔法发生的地方。</p><p id="acc9" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这篇简短的文章旨在回答这个问题。</p><h1 id="2347" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">。/答案/方法论</strong></h1><p id="b955" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">为了回答这一个问题，我们需要理解:</p><ol class=""><li id="7875" class="kn ko hi jf b jg kb jk kc jo kp js kq jw kr ka ks kt ku kv bi translated">工作时，客户端在操作系统中做什么，它如何影响用户的操作系统对DNS解析的决策</li><li id="ab77" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">客户端在受保护伞保护的网络(网络上)中如何操作</li><li id="3b8a" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">客户端在离网时如何操作(指在不受伞式网络保护的访客处)</li></ol><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es lb"><img src="../Images/32a7f9138dfc80827a49be080955c3cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*Qos2fDPxkTqAKX-aXTh58w.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 1: RC through the VPN — <a class="ae ln" href="https://docs.umbrella.com/deployment-umbrella/docs/anyconnect-umbrella-roaming-security-client-administrator-guide" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es lo"><img src="../Images/db1f7314e3f283b8f667b9a2b2471bf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/format:webp/1*8TzS2-tqKems_jMCkRD-kQ.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 2: RC Off the VPN — Modified version from <a class="ae ln" href="https://docs.umbrella.com/deployment-umbrella/docs/anyconnect-umbrella-roaming-security-client-administrator-guide" rel="noopener ugc nofollow" target="_blank">Source</a></figcaption></figure><h1 id="7932" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated"><strong class="ak">。/answer/RoamingClient </strong></h1><p id="2417" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">让我们开始吧，我想介绍一下RC是如何工作的。</p><p id="9a5f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">一旦安装在其主机(Mac/Win)中，客户端就会通过以下方式将其自身绑定到所有网卡:</p><ul class=""><li id="231c" class="kn ko hi jf b jg kb jk kc jo kp js kq jw kr ka lp kt ku kv bi translated">将旧的DNS值替换为127 . 0 . 0 . 1；</li><li id="113c" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">将设备的DNS设置更改为Localhost (127.0.0.1)，并且；</li><li id="9c11" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">将每个NIC的旧DNS配置存储在文本文件中</li><li id="ebfd" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">然后，可执行文件会一直监听Localhost:53</li><li id="d0a9" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">创建PPP适配器</li><li id="4cd9" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">从云中下载“内部域”列表</li></ul><p id="c793" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我在下面详细说明了执行这些操作的原因:</p><p id="ec4b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">将自身绑定到所有网卡</strong>:这一点至关重要，以免在离线时被绕过。</p><p id="ef90" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">将旧的DNS值替换为127.0.0.1，</strong>我的windows主机示例:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lr"><img src="../Images/32ca0fa7b79cc6a11da5e580c8fca174.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gBNqiM7gMavoR0Z-2ujt8A.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 3: NIC after RC installation</figcaption></figure><p id="4edb" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">在文本文件中存储每个网卡的旧DNS配置</strong></p><p id="db13" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这一点可以在RC的安装路径中验证:“C:\ProgramData\OpenDNS\ERC”</p><p id="0c1b" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">对于每个工作的适配器，RC创建一个不同的引用文件。</p><p id="2ae2" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">对于我的Wi-fi适配器，请参见以下内容:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lw"><img src="../Images/8c86a0860b8e0b8e61f8b6fd27f61d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YC-ToCPrrI6NzTvu6o_13g.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 4: RC’s Archive of old DNS setting, before RC installation</figcaption></figure><p id="b5cf" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">然后可执行文件一直监听Localhost:53</strong></p><p id="78b8" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">有了这些，本地主机现在负责DNS解析，这意味着所有的DNS查询都将由操作系统处理。</p><p id="4873" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">最终，这使得RC的流程能够拦截DNS查询并对其做出响应。</p><p id="85f3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">一旦安装了客户端，它唯一的工作就是主动侦听主机上TCP/IP堆栈的端口53 (DNS ),同时允许通过内部域功能解析本地域。</p><p id="768a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我们可以使用命令:"<em class="kj"> netstat -a -b </em>"来验证RC进程正在这样做(在Windows中)，该命令列出了侦听主机中TCP/IP端口的所有进程。请参见下面的输出:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es lx"><img src="../Images/6b7fab857023f4dfa90ea2ffd23e6662.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*N_8Cyy05p4ZLhWNyiSTWLg.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 5: RC process listening to Localhost IPv4, port 53</figcaption></figure><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es ly"><img src="../Images/0eb7d5d2fe7dd006b23209662c8d497e.png" data-original-src="https://miro.medium.com/v2/resize:fit:694/format:webp/1*PWOtlcXmzIn8H7dJ8oShGg.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 6: RC process listening to Localhost IPv6, port 53</figcaption></figure><p id="6713" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">创建一个PPP适配器</strong></p><p id="1c8d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这可以通过发出命令:"<em class="kj"> ipconfig </em>"在RC运行时(离网)进行验证</p><p id="9f2d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">PPP适配器负责将加密的DNS查询发送到伞式服务器进行解析。</p><figure class="lc ld le lf fd lg er es paragraph-image"><div class="er es lz"><img src="../Images/73edec7cac4d5c5ed545b279f13f4633.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*FDpqPaCEpeK_OpwxvhdBNg.png"/></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 7: PPP adapter that RC creates when working</figcaption></figure><p id="6547" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated"><strong class="jf lq">从云端下载“内部域”列表</strong></p><p id="a85d" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">也在RC的安装路径中验证:“C:\ProgramData\OpenDNS\ERC”</p><p id="3e08" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">如果在云控制面板中没有修改任何内容，则使用默认值创建这些内容。</p><p id="f3f1" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">图8显示了下载的潜在白名单文件:</p><figure class="lc ld le lf fd lg er es paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="er es ma"><img src="../Images/9a31aa484a60f61c497fbc0bd12f7b5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F8FPjycz3arFhtNfezGE4A.png"/></div></div><figcaption class="lj lk et er es ll lm bd b be z dx">Figure 8: whitelists files for internal Domains</figcaption></figure><p id="6762" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">让我们比较一下安装了漫游客户端的漫游设备在两种不同情况下解析类似网站时的表现:</p><ol class=""><li id="af05" class="kn ko hi jf b jg kb jk kc jo kp js kq jw kr ka ks kt ku kv bi translated">客户端在受保护伞保护的网络(网络上)中如何操作</li><li id="38fb" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">客户端在离网时如何操作(指在不受伞式网络保护的访客处)</li></ol><h2 id="5156" class="mb ig hi bd ih mc md me il mf mg mh ip jo mi mj it js mk ml ix jw mm mn jb mo bi translated"><strong class="ak">。/answer/scenario1(内网/VPN): </strong></h2><blockquote class="kg kh ki"><p id="27a8" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">"在建立到VPN服务器的连接时，伞漫游客户端在系统中检测新的网络连接，并更改连接的DNS设置以指向伞漫游客户端。保护伞漫游客户端依赖于能够对保护伞的任播DNS IP地址(208.67.222.222/208.67.220.220)执行DNS查找。</p><p id="4bb6" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">如果您正在连接到VPN，与VPN关联的防火墙应该允许访问Umbrella。"</p></blockquote><p id="4c99" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从<a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230561147-Umbrella-Roaming-Client-VPNs-and-Software-Compatibility" rel="noopener ugc nofollow" target="_blank">这个</a>文件</p><p id="52dc" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">您一定注意到我的网卡是如何将它们的DNS设置更改为RC不工作时的设置的(使用存储在文本文件中的旧DNS信息，如上所述)。</p><p id="509c" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">让我们首先使用<em class="kj"> IPCONFIG /ALL </em>命令确定网卡中有哪些活动设置(在相关信息中以粗体突出显示):</p><blockquote class="kg kh ki"><p id="8fcb" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">Windows IP配置<br/>主机名。。。。。。。。。。。。:&lt; &lt;省略&gt; &gt; <br/>主Dns后缀。。。。。。。:&lt; &lt; DNS后缀X &gt; &gt;</p><p id="3f86" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">节点类型。。。。。。。。。。。。:混合<br/> IP路由启用。。。。。。。。:未启用<br/> WINS代理。。。。。。。。:没有<br/> DNS后缀搜索列表。。。。。。:&lt; &lt; DNS后缀X &gt; &gt; <br/> &lt; &lt; DNS后缀Y &gt; &gt; <br/> &lt; &lt; DNS后缀&gt; &gt;</p><p id="8b56" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">以太网适配器本地连接* 1: <br/>特定于连接的DNS后缀。:&lt; &lt; DNS后缀X &gt; &gt; <br/>描述。。。。。。。。。。。:&lt; &lt; VPN提供商&gt; &gt; <br/>物理地址。。。。。。。。。:&lt; &lt; VPN提供商的MAC &gt; &gt; <br/> DHCP已启用。。。。。。。。。。。:是<br/>自动配置已启用。。。。:是<br/> IPv4地址。。。。。。。。。。。:&lt; &lt; IPv4 &gt; &gt;(首选)<br/>子网掩码。。。。。。。。。。。:255.255.255.192 <br/>获得租约。。。。。。。。。。:2019年1月25日星期五上午7:59:01<br/>租约到期。。。。。。。。。。:2019年2月1日星期五上午7:58:59<br/>默认网关。。。。。。。。。:0 . 0 . 0 . 0<br/>DHCP服务器。。。。。。。。。。。:&lt; &lt; VPN提供内部IPv4 &gt; &gt; </p><p id="bcf6" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated"><strong class="jf lq"> DNS服务器。。。。。。。。。。。:&lt; &lt; VPN提供内部IPv4 1 &gt; &gt; </strong></p><p id="e398" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated"><strong class="jf lq"> &lt; &lt; VPN提供内部IPv4 2 &gt; &gt; </strong></p><p id="5fa6" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">Tcpip上的NetBIOS。。。。。。。。:已启用</p><p id="5310" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">无线局域网适配器Wi-Fi: <br/>特定于连接的DNS后缀。:<br/>描述。。。。。。。。。。。:英特尔双频无线AC 8265 <br/>物理地址。。。。。。。。。:D4-6D-6D-3B-欧共体-E1 <br/> DHCP已启用。。。。。。。。。。。:是<br/>自动配置已启用。。。。:是<br/>链接本地IPv6地址。。。。。:fe80::4c82:1ee7:21b:dc1e%12(首选)<br/> IPv4地址。。。。。。。。。。。:192.168.100.11(首选)<br/>子网掩码。。。。。。。。。。。:255.255.255.0 <br/>获得租约。。。。。。。。。。:2019年1月25日星期五上午7:35:55<br/>租约到期。。。。。。。。。。:2019年1月26日星期六上午7:35:53<br/>默认网关。。。。。。。。。:<br/> DHCP服务器。。。。。。。。。。。:192.168.100.1 <br/> DHCPv6 IAID。。。。。。。。。。。:81030509 <br/> DHCPv6客户端DUID。。。。。。。。:00–01–00–01–23–7 b-B0-BD-8C-16–45–3E-DF-9F<br/><strong class="jf lq">DNS服务器。。。。。。。。。。。:192 . 168 . 100 . 1</strong><br/>Tcpip上的NetBIOS。。。。。。。。:已启用</p></blockquote><p id="1e42" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">*请注意，没有带伞状连接的PPP适配器</p><p id="b183" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">然后，发出命令NETSTAT -RN，确认设备连接到VPN时所有接口都正常工作:</p><blockquote class="kg kh ki"><p id="7bcb" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =接口列表<br/> 2… &lt; &lt; VPN提供商的MAC &gt; &gt; …… &lt; &lt; VPN提供商&gt;&gt;<br/>7…8c 16 45 3e df 9f……Intel(R)以太网连接(4) I219-V <br/> 14…54 8c 58 ab 08 01 …用于端点VPN客户端的检查点虚拟网络适配器<br/> 17…d4 6d 6d 3b ec e2 …微软Wi-Fi直连虚拟适配器<br/> 11…d6 6d 6d 3b ec e1 …微软Wi-Fi直连虚拟适配器#2 <br/> 5…00 50 56 c0 00 01 …用于VMnet1的VMware虚拟以太网适配器<br/> 19…00 50 56 c0 00 08 …</p><p id="1fee" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">IPv4路由表<br/>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =主动路由:<br/>网络目的网络掩码网关接口度量<br/><strong class="jf lq">0 . 0 . 0 . 0 . 0 . 0 On-link&lt;&lt;VPN IP v4&gt;&gt;1</strong></p><p id="6c9a" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">//省略</p></blockquote><p id="fc15" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这些是从漫游客户端的主机到网站的NSLOOKUP w/ default DNS解析结果，<strong class="jf lq">确认我们正在使用VPN的DNS服务器:</strong></p><blockquote class="kg kh ki"><p id="6934" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">结果为:nslookup.exe uol.com.br。<br/> stdout: <br/> <strong class="jf lq">服务器:未知<br/>地址:&lt; &lt; VPN内部IPv4 &gt; &gt; </strong></p><p id="7f60" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">姓名:uol.com.br地址:2804:49c:3101:401:ffff:ffff:ffff:45<br/>200.221.2.45</p><p id="3b99" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">stderr: <br/>非权威回答:</p></blockquote><h2 id="ac61" class="mb ig hi bd ih mc md me il mf mg mh ip jo mi mj it js mk ml ix jw mm mn jb mo bi translated"><strong class="ak">。/答案/场景2(离网):</strong></h2><p id="b7f6" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">当在网络外工作时，也就是说不在VPN隧道中，不在没有保护伞公司保护的访客网络上工作，客户端的规则开始生效并开始工作。</p><p id="356a" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">让我们首先用一个<em class="kj"> IPCONFIG /ALL </em>命令来确定网络接口卡中有什么:</p><blockquote class="kg kh ki"><p id="619b" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">Windows IP配置</p><p id="f506" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">主机名。。。。。。。。。。。。:&lt;<omitted> &gt; <br/>主Dns后缀。。。。。。。:&lt;T54】DNS后缀X&gt;T56】</omitted></p><p id="1f08" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">节点类型。。。。。。。。。。。。:混合<br/> IP路由启用。。。。。。。。:没有<br/> WINS代理被启用。。。。。。。。:没有<br/> DNS后缀搜索列表。。。。。。:&lt; &lt; DNS后缀X &gt; &gt; <br/> &lt; &lt; DNS后缀Y &gt; &gt; <br/> &lt; &lt; DNS后缀&gt; &gt;</p><p id="0a88" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">无线局域网适配器Wi-Fi: <br/>特定于连接的DNS后缀。:<br/>描述。。。。。。。。。。。:英特尔双频无线AC 8265 <br/>物理地址。。。。。。。。。:D4-6D-6D-3B-欧共体-E1 <br/> DHCP已启用。。。。。。。。。。。:是<br/>自动配置已启用。。。。:是<br/>链接本地IPv6地址。。。。。:fe80::4c82:1ee7:21b:dc1e%12(首选)<br/> IPv4地址。。。。。。。。。。。:192.168.100.11(首选)<br/>子网掩码。。。。。。。。。。。:255.255.255.0 <br/>获得租赁。。。。。。。。。。:2019年1月25日星期五上午7:35:56<br/>租约到期。。。。。。。。。。:2019年1月26日星期六上午7:35:55<br/>默认网关。。。。。。。。。:192.168.100.1 <br/> DHCP服务器。。。。。。。。。。。:192.168.100.1 <br/> DHCPv6 IAID。。。。。。。。。。。:81030509 <br/> DHCPv6客户端DUID。。。。。。。。:00–01–00–01–23–7 b-B0-BD-8C-16–45–3E-DF-9F<br/>DNS服务器。。。。。。。。。。。:<strong class="jf lq">127 . 0 . 0 . 1</strong>T17】NetBIOS over Tcpip。。。。。。。。:已启用</p><p id="0181" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated"><strong class="jf lq"> PPP适配器伞:</strong> <br/>连接特定的DNS后缀。<br/>描述。。。。。。。。。。。:伞<br/>物理地址。。。。。。。。。:<br/> DHCP已启用。。。。。。。。。。。:没有<br/>自动配置启用。。。。:是<br/> IPv4地址。。。。。。。。。。。:100.122.137.89(首选)<br/>子网掩码。。。。。。。。。。。:255.255.255.255 <br/>默认网关。。。。。。。。。Tcpip上的NetBIOS。。。。。。。。:已禁用</p></blockquote><p id="25fa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">运行NETSTAT -RN:</p><blockquote class="kg kh ki"><p id="f9c5" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =接口列表<br/>2……&lt;&lt;VPN提供商的MAC &gt; &gt; …… &lt; &lt; VPN提供商&gt;&gt;<br/>7……8c 16 45 3e df 9f……Intel(R)以太网连接(4) I219-V <br/> 14…54 8c 58 ab 08 01 …用于端点VPN客户端的检查点虚拟网络适配器<br/> 17…d4 6d 6d 3b ec e2 …微软Wi-Fi直连虚拟适配器<br/> 11…d6 6d 6d 3b ec e1 …微软Wi-Fi直连虚拟适配器#2 <br/> 5…00 50 56 c0 00 01 …用于VMnet1的VMware虚拟以太网适配器<br/> 19…00 50 56 c0 00 双频Wireless-AC 8265<br/>1………………………………软件环回接口1<br/><strong class="jf lq">39…………………………保护伞</strong><br/>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = = IP v4路由表<br/>= = = = = = = = = = = = = = = = = = = = = = = = = = = = = = =主动路由:<br/>网络目的网掩码网关接口Metric<br/>0 . 0 . 0 . 0 . 0 . 0 . 0 . 0 .</p></blockquote><p id="8e2f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">以下是NSLOOKUP从漫游客户端的主机到网站的默认DNS解析结果:</p><blockquote class="kg kh ki"><p id="cb51" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">结果为:nslookup.exe uol.com.br。<br/> stdout: <br/> <strong class="jf lq">服务器:localhost <br/>地址:127.0.0.1 </strong>名称:uol.com.br<br/>地址:2804:49c:3101:401:ffff:ffff:ffff:45<br/>2804:49c:3102:401:ffff:ffff:36<br/>200.147.3.157</p><p id="a8f7" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">stderr: <br/>非权威回答:</p></blockquote><p id="8f8e" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">*例外情况:</p><ol class=""><li id="b5f4" class="kn ko hi jf b jg kb jk kc jo kp js kq jw kr ka ks kt ku kv bi translated">在不同的网络下使用RC，这也受到保护伞的保护(例如，访问公司客户)。</li></ol><blockquote class="kg kh ki"><p id="175f" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">在大多数情况下，当伞式漫游客户端访问另一个组织或受访客保护的网络时，漫游客户端被设置为保持活动，并将遵守其归属组织的策略。然而，有一些警告，如果漫游客户端是其归属组织默认策略的一部分(具有较低的优先级或策略号0)，则漫游客户端将使用访客组织的策略，因为它处于较高的策略中。</p></blockquote><p id="a4d4" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">摘自<a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/360000955083-Umbrella-roaming-client-behaviour-under-guest-protected-network" rel="noopener ugc nofollow" target="_blank">此处</a></p><p id="9577" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">2.在具有虚拟设备(VA)的网络中使用RC:当连接到具有虚拟设备(VA)的网络时，漫游客户端将始终被其覆盖，在连接到此类网络时禁用自身(本地或通过VPN)。</p><blockquote class="kg kh ki"><p id="1a2c" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">如果虚拟设备部署在您组织内的一个或多个位置，伞式漫游客户端将自行禁用，并且DNS设置将恢复到虚拟设备，同时以物理方式或通过VPN连接到该位置。有关使用VAs的伞式漫游客户端行为的更多信息，请阅读:附录B —虚拟设备和伞式漫游客户端。</p><p id="580c" class="jd je kj jf b jg kb ji jj jk kc jm jn kk kd jq jr kl ke ju jv km kf jy jz ka hb bi translated">如果贵组织的所有位置都在使用VAs，则只为设备(而不是设备和装置)配置内部域列表就足够了；任何时候，只要伞形漫游客户端没有连接到相关网络，它就不会使用设置为“仅限设备”的内部域，并将对您的域的任何DNS查询视为公共查询(加密)。</p></blockquote><p id="3242" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">摘自t <a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230905228-Umbrella-Roaming-Client-Deployment-Guide-Internal-Domains" rel="noopener ugc nofollow" target="_blank">他的</a>篇</p><p id="37e3" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">警告和进一步行为:</p><ul class=""><li id="939f" class="kn ko hi jf b jg kb jk kc jo kp js kq jw kr ka lp kt ku kv bi translated">可能存在VPN客户端和漫游客户端不兼容的情况，请参阅文档了解详细信息。</li><li id="eb05" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka lp kt ku kv bi translated">要在兼容的VPN下工作，RC必须能够对保护伞公司的任播地址执行DNS查找(208.67.222.222/208 . 67 . 220220)</li></ul><h1 id="5875" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">。/结论</h1><p id="77bf" class="pw-post-body-paragraph jd je hi jf b jg jh ji jj jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz ka hb bi translated">这项研究是决定性的，因为它可以验证客户端如何在Windows主机中工作。</p><p id="6b0f" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">我喜欢这个想法(良性和批准的)过程接管所有网卡的DNS设置，并不断监听来自TCP/IP堆栈的DNS端口。这确保了每个域解析都将通过客户端，而不会产生开销和对操作系统“主机”文件的错误处理。</p><p id="d4cd" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">从应用程序的角度来看，这种方法引起了我们对审查客户DNS设置的频率的关注，因为恶意行为者可以模仿类似的行为来劫持对潜在恶意服务器的一些DNS响应。</p><p id="e6aa" class="pw-post-body-paragraph jd je hi jf b jg kb ji jj jk kc jm jn jo kd jq jr js ke ju jv jw kf jy jz ka hb bi translated">这就是为什么我们必须始终确认是哪个权威签署了我们页面的数字证书。</p><h1 id="2114" class="if ig hi bd ih ii ij ik il im in io ip iq ir is it iu iv iw ix iy iz ja jb jc bi translated">。/来源</h1><ol class=""><li id="37f8" class="kn ko hi jf b jg jh jk jl jo mp js mq jw mr ka ks kt ku kv bi translated"><a class="ae ln" href="https://docs.umbrella.com/deployment-umbrella/docs/1-introduction-1" rel="noopener ugc nofollow" target="_blank">https://docs . umbrella . com/deployment-umbrella/docs/1-introduction-1</a></li><li id="ba79" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230901168-Umbrella-Roaming-Client-How-it-Works-on-Your-Company-Network" rel="noopener ugc nofollow" target="_blank">https://support . Umbrella . com/HC/en-us/articles/230901168-Umbrella-Roaming-Client-How-it-Works-on-Your-Company-Network</a></li><li id="1672" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/360000955083-Umbrella-roaming-client-behaviour-under-guest-protected-network" rel="noopener ugc nofollow" target="_blank">https://support . Umbrella . com/HC/en-us/articles/360000955083-Umbrella-roaming-client-behavior-under-guest-protected-network</a></li><li id="7e7c" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://docs.umbrella.com/deployment-umbrella/docs/anyconnect-umbrella-roaming-security-client-administrator-guide" rel="noopener ugc nofollow" target="_blank">https://docs . umbrella . com/deployment-umbrella/docs/any connect-umbrella-roaming-security-client-administrator-guide</a></li><li id="c746" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://www.cisco.com/c/dam/en/us/products/collateral/security/firewalls/umbrella-roaming-customer-facing.pdf" rel="noopener ugc nofollow" target="_blank">https://www . Cisco . com/c/dam/en/us/products/parallels/security/firewalls/umbrella-roaming-customer-facing . pdf</a></li><li id="997f" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230905228-Umbrella-Roaming-Client-Deployment-Guide-Internal-Domains" rel="noopener ugc nofollow" target="_blank">https://support . Umbrella . com/HC/en-us/articles/230905228-Umbrella-Roaming-Client-Deployment-Guide-Internal-domain</a></li><li id="d9b6" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated"><a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230561147-Umbrella-Roaming-Client-VPNs-and-Software-Compatibility" rel="noopener ugc nofollow" target="_blank">https://support . Umbrella . com/HC/en-us/articles/230561147-Umbrella-Roaming-Client-VPN-and-Software-Compatibility</a></li><li id="7238" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">nslookup<a class="ae ln" href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/nslookup" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/windows-server/administration/windows-commands/nslookup</a></li><li id="e657" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">nslookup 2<a class="ae ln" href="https://www.a2hosting.com/kb/getting-started-guide/internet-and-networking/troubleshooting-dns-with-dig-and-nslookup" rel="noopener ugc nofollow" target="_blank">https://www . a2 hosting . com/kb/getting-started-guide/internet-and-networking/trouble shooting-DNS-with-dig-and-nslookup</a></li><li id="6ef8" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">PPP定义<a class="ae ln" href="https://searchnetworking.techtarget.com/definition/PPP" rel="noopener ugc nofollow" target="_blank">https://searchnetworking.techtarget.com/definition/PPP</a></li><li id="ca58" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">VA下的漫游客户端<a class="ae ln" href="https://support.umbrella.com/hc/en-us/articles/230905288-Umbrella-Roaming-Client-Deployment-Guide-Appendix-B-Virtual-Appliances-and-the-Umbrella-Roaming-Client" rel="noopener ugc nofollow" target="_blank">https://support . Umbrella . com/HC/en-us/articles/230905288-Umbrella-Roaming-Client-Deployment-Guide-Appendix-B-Virtual-Appliances-and-the-Umbrella-Roaming-Client</a></li><li id="1802" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">windows如何将名称解析为IP:<a class="ae ln" href="https://support.microsoft.com/en-nz/help/172218/microsoft-tcp-ip-host-name-resolution-order" rel="noopener ugc nofollow" target="_blank">https://support . Microsoft . com/en-NZ/help/172218/Microsoft-TCP-IP-host-Name-resolution-order</a></li><li id="c18f" class="kn ko hi jf b jg kw jk kx jo ky js kz jw la ka ks kt ku kv bi translated">验证Windows上的监听进程:<a class="ae ln" href="https://security.stackexchange.com/questions/185228/why-is-my-windows-desktop-using-a-dns-server-on-localhost" rel="noopener ugc nofollow" target="_blank">https://security . stack exchange . com/questions/185228/why-is-my-Windows-desktop-using-a-DNS-server-on-localhost</a></li></ol></div></div>    
</body>
</html>