<html>
<head>
<title>Google Authentication for Node js Application using Passport</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Passport对节点js应用程序进行Google身份验证</h1>
<blockquote>原文：<a href="https://medium.com/swlh/google-authentication-for-node-js-application-using-passport-678c8c068dd8?source=collection_archive---------2-----------------------#2019-05-09">https://medium.com/swlh/google-authentication-for-node-js-application-using-passport-678c8c068dd8?source=collection_archive---------2-----------------------#2019-05-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/16b09345c143d852c0b52d8c4c90a47e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ck1OUfu2TTeYB4B55gDWCQ.png"/></div></div></figure><p id="d4da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">本文将带您了解如何在Node js应用程序中实现Google认证。为此，您必须遵循下面提到的步骤。</p><ol class=""><li id="d1c5" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用npm init创建一个节点js项目。</li><li id="47d9" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用npm安装passport和passport-google-oauth20。</li><li id="6f7a" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">使用您的Google帐户登录Google云平台控制台。</li><li id="3dff" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在Google云平台控制台中创建一个新项目并设置它</li><li id="0adf" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">在Node js项目中通过Passport实现Google策略。</li><li id="9d65" class="jo jp hi is b it jx ix jy jb jz jf ka jj kb jn jt ju jv jw bi translated">测试Google身份验证是否适用于您的应用程序。</li></ol><p id="d278" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们开始吧</p><ol class=""><li id="0a11" class="jo jp hi is b it iu ix iy jb jq jf jr jj js jn jt ju jv jw bi translated">使用npm init创建一个节点js项目。</li></ol><p id="91c6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最初，您必须创建一个文件夹，然后用Visual Studio代码打开它(作者建议的文本编辑器)</p><p id="4d3f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">之后，您必须使用npm命令启动一个新项目，如下所示。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="ac57" class="km kn hi ki b fi ko kp l kq kr">npm init</span></pre><p id="76c4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">将包名填写为“test google ”,并一直按enter键，直到出现问题“这可以吗?”?(是)”。在那里键入yes，然后按enter键。当您这样做时，将在您的文件夹中创建一个package.json文件(寻找它)</p><p id="fcd8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is kc"> 2。使用npm安装passport和passport-google-oauth20。</strong></p><p id="0646" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为了实现谷歌认证，我们必须创建一个谷歌认证策略。为此，您必须使用两个npm模块，即passport和passport-google-oauth20。要安装它们，请转到您的控制台(在vs代码中为Ctrl +`键),并在您的控制台上键入下面一行。此外，安装express，我们稍后将使用它来构建我们的API。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="77e6" class="km kn hi ki b fi ko kp l kq kr">npm i passport <!-- -->passport-google-oauth20<br/>npm i express</span></pre><p id="ad99" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">安装完成后，转到package.json文件，检查passport和passport-google-oauth20是否列在dependencies下。</p><p id="d8e4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is kc"> 3。使用您的Google帐户登录Google云平台控制台。</strong></p><p id="559d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">要开始下一部分，请前往<a class="ae ks" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a>并登录您的谷歌云控制台。</p><p id="4b08" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is kc"> 4。在谷歌云平台控制台中创建一个新项目并设置它</strong></p><p id="3978" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">点击谷歌云平台标志旁边的<strong class="is kc">选择项目</strong>。当您单击时，将出现一个名为“选择项目”的弹出窗口。点击弹出窗口右上方的<strong class="is kc">新建项目</strong>。</p><p id="96da" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">填写新的项目表单(将项目名称填写为“test google”)，然后按下create按钮。</p><p id="8411" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">创建项目后，您必须返回到<strong class="is kc">主页</strong>并点击<strong class="is kc">选择项目</strong> t，此时您点击项目名称，您将进入项目的仪表板。</p><p id="fbfd" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在API下的仪表板中，选择<strong class="is kc"> API概述</strong>进入API和服务部分。现在点击侧面导航栏中的<strong class="is kc">凭证</strong>。点击<strong class="is kc">下的OAuth同意屏幕</strong>并填写显示的表格。您必须填写的强制属性是应用程序名称(如“test google”)和授权域(如[YOUR_PROJECT ID].appspot.com)。填写完毕后，点击保存按钮。</p><p id="4b30" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成上述操作后，单击“创建凭据”= &gt;“OAuth客户端Id”。在下一部分中，单击“web application”，填写名称(如“test google”)并授权重定向为<a class="ae ks" href="http://localhost:3000/callback" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/callback(</a>如果google身份验证成功，这将触发回调)，然后单击create。点击后，将出现一个弹出窗口，显示Web客户端id和客户端密码，复制它们并在您的文件夹中创建config.js文件，并将复制的信息放在下面的格式中。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="c562" class="km kn hi ki b fi ko kp l kq kr">module.exports={<br/>         clientId: “[your web client Id]”,<br/>         secret: “[your client secret]”<br/>         callback: ‘http://localhost:3000/callback'<br/>}</span></pre><p id="49b6" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is kc"> 5。在你创建的Node js项目中通过Passport实现Google战略</strong></p><p id="1732" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在文件夹中创建一个名为googleStrategy.js的文件。创建该文件是为了实现google身份验证的策略和配置。将下面的代码部分复制并粘贴到googleStrategy.js文件中，然后保存</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="e7d4" class="km kn hi ki b fi ko kp l kq kr">const passport = require(‘passport’);<br/>const GoogleStrategy = require(‘passport-google-oauth20’).Strategy;<br/>const config = require(‘./config’)</span><span id="9bd8" class="km kn hi ki b fi kt kp l kq kr">function extractProfile(profile) {<br/>let imageUrl = ‘’;</span><span id="6925" class="km kn hi ki b fi kt kp l kq kr">if (profile.photos &amp;&amp; profile.photos.length) {<br/>imageUrl = profile.photos[0].value;<br/>}</span><span id="cd0b" class="km kn hi ki b fi kt kp l kq kr">return {</span><span id="f361" class="km kn hi ki b fi kt kp l kq kr">id: profile.id,<br/>displayName: profile.displayName,<br/>image: imageUrl,<br/>};<br/>}</span><span id="f8a3" class="km kn hi ki b fi kt kp l kq kr">passport.use(new GoogleStrategy({</span><span id="8780" class="km kn hi ki b fi kt kp l kq kr">clientID: config.clientId,<br/>clientSecret: config.secret,<br/>callbackURL: config.callback,<br/>accessType: ‘offline’,<br/>userProfileURL: ‘https://www.googleapis.com/oauth2/v3/userinfo',<br/>},<br/>(accessToken, refreshToken, profile, cb) =&gt; {<br/>       cb(null, extractProfile(profile));<br/>}));</span><span id="0c72" class="km kn hi ki b fi kt kp l kq kr">passport.serializeUser((user, cb) =&gt; {<br/>          cb(null, user);<br/>});</span><span id="3c09" class="km kn hi ki b fi kt kp l kq kr">passport.deserializeUser((obj, cb) =&gt; {<br/>          cb(null, obj);<br/>});</span></pre><p id="469b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">上一节中的代码用它的配置创建了一个新的Google策略，让passport在应用程序中使用它，方法是在passport.use()中指定它。</p><p id="b781" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">现在，我们必须创建API来开始对实现的google认证进行测试。创建一个名为<strong class="is kc"> server.js </strong>的文件，并将代码包含在下面的部分中。</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="f3c1" class="km kn hi ki b fi ko kp l kq kr">const passport = require(‘passport’);<br/>const express = require(‘express’)<br/>const googleStratergy = require(‘./googleStrategy’)</span><span id="f7d8" class="km kn hi ki b fi kt kp l kq kr">const app = express();</span><span id="727f" class="km kn hi ki b fi kt kp l kq kr">// app.use(googleStratergy);<br/>app.use(passport.initialize())</span><span id="d286" class="km kn hi ki b fi kt kp l kq kr">// Api call for google authenticationapp.get(<br/>    ‘/’,<br/>    passport.authenticate(‘google’, {scope:[‘email’, ‘profile’]}),            (req,res)=&gt;{<br/>});</span><span id="66df" class="km kn hi ki b fi kt kp l kq kr">// Api call back function<br/>app.get(‘/callback’<br/>          ,passport.authenticate(‘google’, {scope: [‘email’, ‘profile’]}),<br/>       (req,res)=&gt;{<br/>             return res.send(“Congrats”);<br/>});</span><span id="50ba" class="km kn hi ki b fi kt kp l kq kr">app.listen(3000,() =&gt; console.log(‘app listening on port 3000!’));</span></pre><p id="2e12" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在上面的代码部分中，两个API调用是使用express实现的</p><p id="a48f" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><strong class="is kc"> 6。测试Google身份验证是否适用于您的应用程序。</strong></p><p id="7b8d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">完成上述所有步骤后，您必须测试它是否工作，为此，我们已经运行了<strong class="is kc"> server.js </strong>文件，因为它由API组成。</p><p id="7bff" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果您在Visual Studio代码中，请按Ctrl +`打开终端并键入</p><pre class="kd ke kf kg fd kh ki kj kk aw kl bi"><span id="704a" class="km kn hi ki b fi ko kp l kq kr">node server.js</span></pre><p id="ec38" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">“app监听端口3000！”以确认您的服务器正在本地主机端口3000上运行。</p><p id="3f39" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">最后，你打开浏览器，输入<a class="ae ks" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank"><strong class="is kc">http://localhost:3000/</strong></a><strong class="is kc"/>，然后回车。它会将你重定向到谷歌登录屏幕。输入您的凭据并登录。如果凭证有效，它将重定向到您的回电，并在屏幕上显示“祝贺”。</p></div></div>    
</body>
</html>