<html>
<head>
<title>Beginner’s Guide to Load Testing with k6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">k6负载测试初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/swlh/beginners-guide-to-load-testing-with-k6-85ec614d2f0d#2019-06-17">https://medium.com/swlh/beginners-guide-to-load-testing-with-k6-85ec614d2f0d#2019-06-17</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="0d1d" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">第一部分—前奏</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/2edb3084ae118a6920222d0937328e1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pOH0TCmxUt-jpDOpGPHL8A.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd jn">Credits</strong>: <a class="ae jo" href="https://grafana.com/dashboards/2587" rel="noopener ugc nofollow" target="_blank">https://grafana.com/dashboards/2587</a></figcaption></figure><p id="4947" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">更新:本文是负载测试系列的一部分。我会尽量定期发布这个系列的相关话题。我不会在每篇文章上重复这个目录，所以请检查第一篇文章以获得新的更新。此外，我会尝试将文章链接在一起，这样你就可以很容易地了解这个系列的下一篇文章。于是乎，这些陆续发布:</p><blockquote class="km kn ko"><p id="4a65" class="jp jq kl jr b js jt ij ju jv jw im jx kp jz ka kb kq kd ke kf kr kh ki kj kk hb bi translated"><a class="ae jo" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-85ec614d2f0d">第一部——前奏</a></p><p id="4a95" class="jp jq kl jr b js jt ij ju jv jw im jx kp jz ka kb kq kd ke kf kr kh ki kj kk hb bi translated"><a class="ae jo" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-73d55ee23723">第2部分—绩效目标和k6指标</a></p><p id="ab3b" class="jp jq kl jr b js jt ij ju jv jw im jx kp jz ka kb kq kd ke kf kr kh ki kj kk hb bi translated"><a class="ae jo" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-ff155885b6db">第3部分——如何编写&amp;使用k6 </a>运行负载测试</p></blockquote><p id="935a" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">让我们从一些问题开始:</p><ul class=""><li id="917f" class="ks kt hi jr b js jt jv jw jy ku kc kv kg kw kk kx ky kz la bi translated">您是否考虑过如何发现您的基础架构设置是否能够承受高用户负载？</li><li id="63b5" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated">您曾经能够在不处理当前测试工具的如此多的配置和陡峭的学习曲线的情况下运行负载测试吗？</li><li id="3b70" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated">您是否考虑过通过测试编写脚本的方法，无论是针对负载/性能还是其他方面？</li><li id="1159" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated">您是否想过性能测试可以简化，并作为CI/CD流程的一部分？</li></ul><p id="77e5" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">你并不孤单。我记得我是一个团队的首席开发人员，致力于开发一个API，为我们不断增长的应用程序集提供许多微服务，如内容和用户管理、计费、分析等。那时，我们在源代码控制和CI/CD过程中使用软件工程中最新的最佳实践。我们已经使用docker和托管GitLab建立了CI/CD流程，并使用GitLab CI处理CI流程。经过一段时间的测试和代码推送，我们决定采用alpha-stage API，它可以满足我们开发新应用的需求。</p><p id="0664" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">经过一段时间的开发、测试和改进，我们决定在负载下测试我们的API，看看它是否能兑现承诺。因为我们已经看到，在200，000个用户订阅并且其中60，000个用户使用我们的其他应用程序之后，对其他API的请求/响应流会变慢，而其他API的设置大致相同。</p><p id="13c2" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">因此，为了不错过在客户到来之前进行(负载)测试的机会，我们决定研究负载测试我们的API的方法。在我们调查了Locust、Apache JMeter等之后，我们决定使用Apache JMeter，它曾经是(现在仍然是)这个行业的工具。我们认为这是一个很好的选择。我们花了将近三天的时间才学会使用GUI版本执行简单的负载测试。我们能够从一台服务器产生负载测试并分析结果。结果很好，因为它让我们更深入地了解了在并发用户数量和API在负载下的响应时间方面，我们应该从API中得到什么。</p><p id="eab0" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">但后来我们没有使用该工具，因为当时没有明确的方法将其集成到我们的CI/CD流程中，我们也没有足够的时间来学习和使用它。我们想要一些对开发者更友好，更能融入我们的工作流程，更容易学习的东西。现在，它已经有了很大的改进，并且很容易与CI/CD管道集成。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="c76d" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">现在，我在一家公司工作，<a class="ae jo" href="https://loadimpact.com/" rel="noopener ugc nofollow" target="_blank"> Load Impact </a>，以负载和性能测试为核心业务。他们有一个自由/开源、易于脚本化的工具(JavaScript)，叫做<a class="ae jo" href="https://k6.io/" rel="noopener ugc nofollow" target="_blank"> k6 </a>，可以用于负载测试。他们还在<em class="kl">的基础上提供了一个云服务，同样的工具</em>，用于供应和运行来自世界不同地区的测试(<a class="ae jo" href="https://loadimpact.com/cloud-execution/" rel="noopener ugc nofollow" target="_blank">云执行</a>)，它最终会给你一个漂亮的仪表板(<a class="ae jo" href="https://loadimpact.com/insights/" rel="noopener ugc nofollow" target="_blank"> Insights </a>)，上面有闪亮的图表显示测试的分析结果。它还与CI/CD工具和平台有很好的集成。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ln"><img src="../Images/fb6544c358e23f668de6726bb7b6f49b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DgpDE9wBwxVKtmTk_BLnzA.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx"><strong class="bd jn">Left</strong>: load test script written in JavaScript, <strong class="bd jn">Right</strong>: Cloud service of Load Impact (Insights), <strong class="bd jn">Credits</strong>: <a class="ae jo" href="https://loadimpact.com/" rel="noopener ugc nofollow" target="_blank">https://loadimpact.com/</a></figcaption></figure><p id="48c9" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">说够了！让我们深入了解什么是负载测试，以及我们如何使用k6在我们的基础设施上进行负载测试。我以后也会试着写更多关于云服务的东西。</p><h2 id="013f" class="lo lp hi bd lq lr ls lt lu lv lw lx ly jy lz ma mb kc mc md me kg mf mg mh mi bi translated">什么是负载/性能测试？</h2><p id="479d" class="pw-post-body-paragraph jp jq hi jr b js mj ij ju jv mk im jx jy ml ka kb kc mm ke kf kg mn ki kj kk hb bi translated">性能测试是计算机科学实践中性能工程的一个子集，它通过手动或自动对软件施加压力和工作负载来处理软件的质量保证，以观察软件的行为并确保它在该负载下足够响应和稳定。这都是关于期望。例如，您希望您的API或网站同时为10K用户服务，但是当您对其施加压力时，很快就会发现您的计算与现实不符，事实证明情况正好相反。然后，您应该分析您的设计或设置中的弱点，看看如何从高负载中获益。</p><p id="0674" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">在性能测试中，有许多类型的测试满足不同的目的(来源:<a class="ae jo" href="https://en.wikipedia.org/wiki/Software_performance_testing" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Software_performance_testing</a>):</p><ul class=""><li id="497b" class="ks kt hi jr b js jt jv jw jy ku kc kv kg kw kk kx ky kz la bi translated"><strong class="jr mo">负载测试</strong>:基本上，给系统加载负载，看看它的表现如何。</li><li id="7b1e" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">压力测试</strong>:负载测试，找出系统能够处理的最大负载量。</li><li id="8e1a" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">浸泡测试</strong>:持续对系统进行负载测试，监控内存泄漏和系统行为。</li><li id="2663" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">尖峰测试</strong>:负载突然增加或减少的负载测试。</li><li id="ee92" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">断点测试</strong>:类似于压力测试，但随着时间的推移，会对系统施加递增的负载，以观察它的表现。</li><li id="b112" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">配置测试</strong>:改变配置，观察系统在不同配置、负载下的表现。</li><li id="543b" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">隔离测试</strong>:隔离故障域，重复测试确认故障。</li><li id="451b" class="ks kt hi jr b js lb jv lc jy ld kc le kg lf kk kx ky kz la bi translated"><strong class="jr mo">互联网测试</strong>:大公司的全球负载测试，看看不同地区的系统表现如何。</li></ul><p id="980c" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">性能测试最常见的目的是找出系统的可靠性、稳定性、性能和响应能力。像吞吐量和响应时间这样的指标是这种系统的一个很好的度量。</p><h2 id="58e7" class="lo lp hi bd lq lr ls lt lu lv lw lx ly jy lz ma mb kc mc md me kg mf mg mh mi bi translated">k6:编写脚本和运行负载测试并解释结果</h2><p id="8cc0" class="pw-post-body-paragraph jp jq hi jr b js mj ij ju jv mk im jx jy ml ka kb kc mm ke kf kg mn ki kj kk hb bi translated">k6是一个用Go编写的免费/开源工具，它可以接收用JavaScript (ES5.1+)编写的测试，并将其转化为对网站或API进行负载测试的请求。</p><p id="6dd5" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">使用k6最简单的方法是使用官方预建的二进制版本将其安装在你的机器上。k6通过<em class="kl"> MSI </em>安装程序支持微软Windows，通过<em class="kl"> APT </em>库支持GNU/Linux，通过<em class="kl"> brew </em>支持苹果macOS。</p><p id="32e9" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">还有一个官方码头工人形象。不建议初学者从源代码开始构建，但是您总是可以选择这样做。</p><p id="ebaa" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">然后，您可以使用以下脚本运行您安装的k6命令:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mp mq l"/></div><figcaption class="jj jk et er es jl jm bd b be z dx">A sample test script for k6</figcaption></figure><p id="b0a8" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">一旦您将这个脚本保存到k6可以访问的地方，将其命名为<code class="du mr ms mt mu b">script.js</code>或您自己想要的文件名，您就可以用10个<em class="kl">虚拟用户</em> (VU)运行它，时间为30秒，如下所示:</p><pre class="iy iz ja jb fd mv mu mw mx aw my bi"><span id="5498" class="lo lp hi mu b fi mz na l nb nc">k6 run -u 10 -d 30s script.js</span></pre><p id="e9a3" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">它在30秒内使用10个虚拟用户在您的机器上运行k6，并检查测试URL在所有测试中是否返回<em class="kl"> 200 (OK) </em>。</p><p id="a16f" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">运行该命令的输出如下所示。我建议您看一看它，以便更好地理解不同的度量、检查和其他键值。这个输出将在下一篇文章中详细解释。</p><p id="5f66" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">通过解释当前的输出，您可以看到脚本在本地执行了30秒的<em class="kl">并产生了<em class="kl"> 10个单独的虚拟用户(vu)</em>来测试URL。您还可以看到突出显示的绿色已检查项目，“<em class="kl">是状态200 </em>”，这表示我们的<em class="kl">检查已通过100%的案例</em>，即所有案例。</em></p><p id="9d8c" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">还显示了2775个请求中发送和接收的总数据。对于每个HTTP请求，都有一个具有5个不同值的<em class="kl"> http_req_* </em>度量(key ),每个值对应于所有请求的<em class="kl">平均值、最小值、中值、最大值、第90个百分点和第95个百分点</em>。</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es nd"><img src="../Images/066764ff5e6d4dd3fb2dd40c59c5609b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aSlAqLfzEWVTy4j49n5QYg.png"/></div></div><figcaption class="jj jk et er es jl jm bd b be z dx">Terminal output of the sample test script for k6</figcaption></figure><p id="3a2d" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">这是对性能/负载测试和k6工具的简短介绍。我会试着写一些更高级的负载测试文章，向你展示如何对你的网站和/或API进行负载测试。</p><p id="9b7b" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">本系列将继续提供更深入的性能/负载测试文章，假设读者以前没有这方面的经验。</p><p id="1472" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated"><a class="ae jo" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-73d55ee23723">在本系列的下一篇文章</a>中，我将尝试谈论性能目标和k6度量，它们是负载测试的构建块。</p><p id="8ad1" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated">一如既往，我真的很感谢你的建议，意见和投入。我要感谢Pepe Cano和Robin Gustafsson对本文和系列文章提出的宝贵意见和建议。</p></div><div class="ab cl lg lh gp li" role="separator"><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll lm"/><span class="lj bw bk lk ll"/></div><div class="hb hc hd he hf"><p id="f632" class="pw-post-body-paragraph jp jq hi jr b js jt ij ju jv jw im jx jy jz ka kb kc kd ke kf kg kh ki kj kk hb bi translated"><strong class="jr mo">穆斯塔法·莫拉迪安</strong> <br/> Sr. SWE @ <a class="ne nf ge" href="https://medium.com/u/7df2fe2c0bfd?source=post_page-----85ec614d2f0d--------------------------------" rel="noopener" target="_blank">负载冲击</a><br/><a class="ae jo" href="http://github.com/mostafa" rel="noopener ugc nofollow" target="_blank">GitHub</a>|<a class="ae jo" href="https://www.linkedin.com/in/mostafa-moradian/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae jo" href="https://twitter.com/MosiMoradian" rel="noopener ugc nofollow" target="_blank">Twitter</a></p></div></div>    
</body>
</html>