<html>
<head>
<title>Beginner’s Guide to Load Testing with k6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">k6负载测试初学者指南</h1>
<blockquote>原文：<a href="https://medium.com/swlh/beginners-guide-to-load-testing-with-k6-ff155885b6db?source=collection_archive---------4-----------------------#2019-07-09">https://medium.com/swlh/beginners-guide-to-load-testing-with-k6-ff155885b6db?source=collection_archive---------4-----------------------#2019-07-09</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><div class=""><h2 id="12f6" class="pw-subtitle-paragraph if hh hi bd b ig ih ii ij ik il im in io ip iq ir is it iu iv iw dx translated">第3部分——如何使用k6编写和运行一个基本的负载测试</h2></div><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8e1860c9385a7f51d737ecee9015dfc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yY9iJKP_KEcuweo78xfXfA.png"/></div></div></figure><p id="506b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">既然您已经了解了<a class="ae kf" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-85ec614d2f0d">基础知识</a>并定义了您的<a class="ae kf" rel="noopener" href="/swlh/beginners-guide-to-load-testing-with-k6-73d55ee23723">性能目标</a>，现在是时候编写您的负载测试脚本并使用k6运行它了。因为k6脚本可以用JavaScript编写，所以如果您对这种编程语言有一点了解，就可以很容易地编写它们。</p><h2 id="de9f" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">k6测试生命周期</h2><p id="e8e3" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">每个测试脚本都有三个部分(实际上有更多)，如下面的截图所示:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es lg"><img src="../Images/94529ee43b5de281092ac59620f59ae3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KHnZgPqBbs0HYg_PWeNITA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Different parts of the k6 script</figcaption></figure><ol class=""><li id="0835" class="ll lm hi jl b jm jn jp jq js ln jw lo ka lp ke lq lr ls lt bi translated"><strong class="jl lu"> <em class="lv">导入</em> </strong>:这显然是你可以导入<a class="ae kf" href="https://docs.k6.io/docs/init-context" rel="noopener ugc nofollow" target="_blank"> k6脚本API </a>，以及你想要使用的其他<a class="ae kf" href="https://docs.k6.io/docs/modules" rel="noopener ugc nofollow" target="_blank"> JavaScript模块</a>(库)的地方。这些模块可以使用各种方法加载:<a class="ae kf" href="https://docs.k6.io/docs/modules#section-npm-modules" rel="noopener ugc nofollow" target="_blank">本地机器上的捆绑NPM模块</a>(已通过浏览器验证，但不支持浏览器API)和<a class="ae kf" href="https://docs.k6.io/docs/modules#section-remote-modules" rel="noopener ugc nofollow" target="_blank">远程模块</a>(从URL，甚至CDNJS和GitHub)。<em class="lv">提示</em>:确保通过挂载的卷使库对<a class="ae kf" href="https://hub.docker.com/r/loadimpact/k6" rel="noopener ugc nofollow" target="_blank">dockered版本的k6 </a>可用，否则你的脚本找不到导入。</li><li id="af5c" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke lq lr ls lt bi translated"><strong class="jl lu"> <em class="lv"> Init代码</em> </strong>:这是脚本的一部分，在导出的<em class="lv">默认</em>函数之外。它通常用于为整个测试提供选项，如何运行测试，如何在云上分发测试，等等。显然，它用于整个测试本身的初始化。</li><li id="d50b" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke lq lr ls lt bi translated"><strong class="jl lu"> <em class="lv"> VU代号</em> </strong> : k6支持一个叫虚拟用户的特性。这意味着你可以使用<em class="lv">单独的</em>“智能”虚拟用户来测试你的系统。这个部分中的代码位于导出的“<em class="lv">默认</em>”函数中，在每个VU中反复运行，所有这些vu的汇总结果由k6处理和报告。这是您定义测试场景的地方，这将在本文中详细解释。</li></ol><p id="e04c" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在k6测试的生命周期<a class="ae kf" href="https://docs.k6.io/docs/test-life-cycle" rel="noopener ugc nofollow" target="_blank">中还有其他阶段，包括<em class="lv">设置</em>和<em class="lv">拆除</em>，很明显，它们与初始化和VU代码是分开的。</a></p><h2 id="3f2f" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">k6怎么跑？</h2><p id="65e9" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">k6的运行方法有很多种。由于k6分布在<a class="ae kf" href="https://github.com/loadimpact/k6" rel="noopener ugc nofollow" target="_blank">源代码</a>和<a class="ae kf" href="https://github.com/loadimpact/k6/releases" rel="noopener ugc nofollow" target="_blank">二进制</a>中，你可以很容易地在你的机器上抓取并安装一个二进制版本并运行它。支持的操作系统包括GNU/Linux、微软Windows和苹果macOS。还有一个<a class="ae kf" href="https://hub.docker.com/r/loadimpact/k6" rel="noopener ugc nofollow" target="_blank">docker化版本</a>，你可以在你的docker设置上运行。</p><p id="ee8b" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">无论您在哪里运行k6，它都会为您提供相同的体验。下面是k6命令的帮助:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es mb"><img src="../Images/3ddff87130b0a121ab2780068775a2c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VnQokWG3VNbPH_0Xj2YyBA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">k6 help</figcaption></figure><p id="335e" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">运行k6的格式就像“k6 [command]”，然后你可以传递你想要的命令，让它由k6运行。从版本0.25.1开始，可用的基本命令如下。此外，您可以通过以下组合获得每个命令的帮助:</p><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="fe10" class="kg kh hi md b fi mh mi l mj mk">k6 &lt;command&gt; --help</span></pre><ul class=""><li id="7aaa" class="ll lm hi jl b jm jn jp jq js ln jw lo ka lp ke ml lr ls lt bi translated"><strong class="jl lu">帮助</strong>:显示上面的帮助，嗯，很明显。</li><li id="aaac" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">暂停</strong>:暂停正在运行的测试。</li><li id="6cbb" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">恢复</strong>:恢复暂停的测试。</li><li id="3a05" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">运行</strong>:使用各种标志运行测试，例如- <em class="lv">暂停</em>在暂停模式下运行脚本。</li><li id="d49b" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu"> stats </strong>:显示当前运行或暂停的测试中vu数量的统计数据。</li><li id="7440" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">状态</strong>:显示当前k6实例的状态，运行、暂停、感染和vu数量。</li><li id="b954" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">版本</strong>:猜猜看？</li></ul><p id="65d7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">这些是更高级的命令，我将在接下来的文章中介绍:</p><ul class=""><li id="77e8" class="ll lm hi jl b jm jn jp jq js ln jw lo ka lp ke ml lr ls lt bi translated"><strong class="jl lu">存档</strong>:创建一个你的脚本的捆绑<em class="lv"> tar </em>文件以及所有的依赖项，你可以在以后使用“k6 run”。</li><li id="6642" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">登录</strong>:使用<a class="ae kf" href="https://loadimpact.com/insights/" rel="noopener ugc nofollow" target="_blank">负载影响洞察</a>云服务进行认证，并提供一个认证令牌供k6使用。</li><li id="97ee" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu"> cloud </strong>:在k6云服务上运行您的认证测试。</li><li id="b8df" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">转换</strong>:浏览器可以将请求/响应记录为HAR (HTTP Archive)文件，然后您可以使用k6将它转换为HAR文件。k6从HAR文件创建一个脚本，您可以在本地或云端编辑并运行它。</li><li id="5707" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu">检查</strong>:基本输出该脚本的合并脚本选项或。焦油包。</li><li id="8884" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke ml lr ls lt bi translated"><strong class="jl lu"> scale </strong>:用新数量的虚拟用户(vu)来扩展暂停/运行的测试。它可以为本地或云执行实现这一点。</li></ul><p id="fd51" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">为了控制k6的行为，每个命令都有一组丰富的选项/标志要传递。我强烈建议你看看它们，因为有时你会在里面发现宝石。</p><h2 id="095f" class="kg kh hi bd ki kj kk kl km kn ko kp kq js kr ks kt jw ku kv kw ka kx ky kz la bi translated">测试场景和结果解释</h2><p id="8275" class="pw-post-body-paragraph jj jk hi jl b jm lb ij jo jp lc im jr js ld ju jv jw le jy jz ka lf kc kd ke hb bi translated">测试场景是每个测试不可分割的一部分。如果你想测试你的API或者网站，你得有一个场景，最终把它变成一个脚本，然后传给k6运行。</p><p id="94e3" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">让我们举个例子:</p><ol class=""><li id="994d" class="ll lm hi jl b jm jn jp jq js ln jw lo ka lp ke lq lr ls lt bi translated">用户检查API是否启动，因此检查我们的API的心跳，然后尝试发送进一步的消息。</li><li id="ac12" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke lq lr ls lt bi translated">然后他们试图创建一个令牌来访问我们API的其他部分或私有区域。</li><li id="deff" class="ll lm hi jl b jm lw jp lx js ly jw lz ka ma ke lq lr ls lt bi translated">最后，他们试图访问我们API的一个端点。</li></ol><pre class="iy iz ja jb fd mc md me mf aw mg bi"><span id="a5ad" class="kg kh hi md b fi mh mi l mj mk">[heart-beat]-&gt;[generate-token]-&gt;[get-list-of-users]</span></pre><p id="9a76" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">您还想添加一些更多的标准和阈值，以便能够从k6中发现更有意义的结果。虽然有些信息，比如threshold，在本文中是新的，但我将在接下来的文章中尝试完整地解释它们。您希望这个场景由100个单独的用户测试，从10个用户开始，逐渐增加到100个，然后逐渐减少到0个，并将所有请求的响应时间保持在500毫秒以下。</p><p id="55fd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">脚本应该是这样的:</p><figure class="iy iz ja jb fd jc"><div class="bz dy l di"><div class="mm mn l"/></div><figcaption class="lh li et er es lj lk bd b be z dx">Example of k6 scenario script</figcaption></figure><p id="91da" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">我用httpbin.org作为厨房水槽来测试k6的这个脚本。运行测试五分钟的结果如下:</p><figure class="iy iz ja jb fd jc er es paragraph-image"><div role="button" tabindex="0" class="jd je di jf bf jg"><div class="er es ix"><img src="../Images/8e1860c9385a7f51d737ecee9015dfc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yY9iJKP_KEcuweo78xfXfA.png"/></div></div><figcaption class="lh li et er es lj lk bd b be z dx">Output of k6 scenario script</figcaption></figure><p id="9a52" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">输出从打印到屏幕上的k6徽标开始。接下来是执行方法，在我的例子中是“本地”的。输出被重定向到终端，脚本的名称是“test.js”。</p><p id="0c48" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">持续时间和迭代次数为空，因为它们是根据阶段自动计算的。(最大)vu数为100，进度条显示五分钟内完成。</p><p id="9ca4" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">“v1 API测试”和其他组名后面是一个白色的全形符号“█”,所有的检查都是绿色的，表示它们在所有情况下都通过了。</p><p id="1b54" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">测试中的所有检查都通过了，特别是33741个请求中的56213个检查。还显示了发送和接收的数据量、vu、迭代和一些其他指标。</p><p id="36cd" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">非常重要的部分是以<em class="lv"> http </em>开头的指标。它们表示每个请求或一组请求完成所用时间的平均值、最小值、最大值、p(90)和p(95)。</p><p id="a9ed" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">因为我们已经将平均阈值定义为500毫秒。由于所有请求的平均时间没有那么长，所以测试通过了。</p><p id="935a" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">屏幕上显示的结果是所有测试的汇总结果。如果您希望能够使用所有生成的数据，而不仅仅是聚合的数据，您应该使用<code class="du mo mp mq md b">-o</code>标志将输出发送到文件、软件或云服务。</p><p id="d55f" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">可以使用<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-json-output" rel="noopener ugc nofollow" target="_blank"> JSON插件</a>将原始结果写入JSON文件。还有其他插件将指标推送给<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-influxdb-output" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a>、<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-apache-kafka-output" rel="noopener ugc nofollow" target="_blank">阿帕奇卡夫卡</a>、<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-statsd-output" rel="noopener ugc nofollow" target="_blank"> StatsD </a>或<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-datadog-output" rel="noopener ugc nofollow" target="_blank"> Datadog </a>。最后(也可能是最好的)选择是使用<a class="ae kf" href="https://docs.k6.io/docs/results-output#section-load-impact-insights-output" rel="noopener ugc nofollow" target="_blank">负载影响插件</a>，它将您的测试结果传输到负载影响云平台。</p></div><div class="ab cl mr ms gp mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hb hc hd he hf"><p id="d396" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在本文中，我尽力向您展示了如何编写一个非常简单的测试场景脚本，以及如何使用k6运行负载测试。</p><p id="13c7" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">在下一篇文章中，我将尝试把我在第二篇文章中谈到的概念——性能目标和k6度量——转化为k6支持的特性，您可以使用这些特性进行成功的负载或验收测试。</p><p id="0d07" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated">一如既往，我欢迎您的反馈。请不要犹豫，在下面写下您的评论、问题和反馈。</p></div><div class="ab cl mr ms gp mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="hb hc hd he hf"><p id="baa0" class="pw-post-body-paragraph jj jk hi jl b jm jn ij jo jp jq im jr js jt ju jv jw jx jy jz ka kb kc kd ke hb bi translated"><strong class="jl lu">穆斯塔法·莫拉迪安</strong> <br/> Sr. SWE @ <a class="my mz ge" href="https://medium.com/u/7df2fe2c0bfd?source=post_page-----ff155885b6db--------------------------------" rel="noopener" target="_blank">负载冲击</a><br/><a class="ae kf" href="http://github.com/mostafa" rel="noopener ugc nofollow" target="_blank">GitHub</a>|<a class="ae kf" href="https://www.linkedin.com/in/mostafa-moradian/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>|<a class="ae kf" href="https://twitter.com/MosiMoradian" rel="noopener ugc nofollow" target="_blank">Twitter</a></p></div></div>    
</body>
</html>