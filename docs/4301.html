<html>
<head>
<title>NSX-T Security with Ansible — Pt 1. Basic Firewall Rules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">NSX-T安全与ansi ble-Pt 1。基本防火墙规则</h1>
<blockquote>原文：<a href="https://medium.com/swlh/nsx-t-security-with-ansible-pt1-basic-firewall-rules-6aa08c25e226?source=collection_archive---------12-----------------------#2019-05-30">https://medium.com/swlh/nsx-t-security-with-ansible-pt1-basic-firewall-rules-6aa08c25e226?source=collection_archive---------12-----------------------#2019-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/df559c2ff1dc7cd2f6996c2a1c6bdaab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UUU81imI6pqQL-e4JUirHg.jpeg"/></div></div><figcaption class="iq ir et er es is it bd b be z dx">The sky’s the limit with Ansible</figcaption></figure><h2 id="9853" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">放弃</h2><p id="25e7" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">这篇文章是我的观点，而不是我雇主的观点。</p><h1 id="9bc3" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">背景</h1><p id="3f68" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">NSX-T是VMware的新一代软件定义网络堆栈。虽然有图形用户界面，但如果你使用图形用户界面来驱动防火墙，那你就大错特错了。本文将介绍如何使用Ansible以一种您可以在GitOps工作流中使用的方式来驱动NSX-T防火墙。</p><p id="ab56" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">本文假设您对Ansible有基本的了解。如果没有，你可以通过你最喜欢的搜索引擎找到很多视频和文章。</p><p id="0a6d" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">使用这些Ansible模块，可以将NSX-T作为代码管道集成到基础设施中。无论您是想使用它来构建虚拟机规则、基于容器的规则还是NSX负载平衡器的防火墙，您都可以在管道中使用这些模块，基于最少的输入自动驱动NSX边缘和分布式防火墙。我们将在YAML构建防火墙规则，这些规则可以存储在Git中，然后因为Ansible模块是幂等的，这些规则可以在任何时候重新应用，如果模块检测到定义的YAML与NSX T中的配置状态不匹配，它将更新NSX T中的配置</p><h2 id="cc7c" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">旁注</h2><p id="6b4e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">NSX-T 2.4引入了更新的、更具声明性的API，它简化了驱动防火墙所需的API调用，同时引入了不适合当今所有用例的依赖性。在撰写本文时，声明式API不支持与NCP插件互操作，这意味着您不能将所有新的API特性和结构用于Kubernetes或Pivotal应用服务。下面介绍的模块集中在原始的API规范上，但是由于Ansible处理所有的boiler板，所以与新的API相比，交互模式是相同的。唯一主要的是，你有一个额外的领域为每个对象进行分类。例如，如果您有一个基于IP集的规则目的地，您已经调用了您的IP集名称，并且它是一个IP集。</p><h2 id="6d54" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">假定的知识</h2><ul class=""><li id="9c51" class="lj lk hi ju b jv jw jz ka jf ll jj lm jn ln km lo lp lq lr bi translated">基本网络交换和路由概念</li><li id="648c" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">基本的防火墙概念，如端口和协议</li><li id="4ce2" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">虚拟化概念，包括虚拟网络</li><li id="c2e3" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">基于可行的知识准备和运行行动手册</li><li id="b276" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">阅读和写作YAML</li></ul><h1 id="6696" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">NSX-T概念</h1><p id="1613" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">如果您想深入了解防火墙之外的NSX-T架构，VMware经验证的设计指南是一个很好的起点。<br/><a class="ae lx" href="https://docs.vmware.com/en/VMware-Validated-Design/5.0.1/vmware-validated-design-501-sddc-nsxt-workload-architecture-design.pdf" rel="noopener ugc nofollow" target="_blank">https://docs . VMware . com/en/VMware-Validated-Design/5 . 0 . 1/VMware-Validated-Design-501-sddc-nsxt-workload-architecture-Design . pdf</a></p><h2 id="0285" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">分布式防火墙(DFW)和微分段</h2><p id="c390" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">分布式防火墙是软件定义网络(SDN) IMO的最佳特性之一。在传统网络中，如果您想要分离2个工作负载，您需要将它们放在单独的子网/VLAN上，然后在网络之间运行防火墙。由于多种原因，这种方法无法扩展，主要是因为网络交换机上最多只能配置4094个VLANs，而且提供第3层隔离需要大量的配置开销。在虚拟化和容器化解决方案中，当使用SDN堆栈时，可以在虚拟机或容器级别实施防火墙策略。例如，对于虚拟机，NSX-T软件在虚拟机管理程序中运行，位于虚拟机连接的虚拟交换机上，虚拟交换机中的该软件可以执行防火墙策略。通过在流量退出虚拟机时实施策略，可以构建零信任和微分段类型，其中每个对象只能有绝对最少的规则，例如阻止在同一主机上运行的同一子网中的虚拟机之间的流量。</p><h2 id="041a" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">IP集</h2><p id="b750" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">顾名思义，IP集是IP地址的集合。您可以定义单个IP、范围或基于CIDR风格的子网，每个IP集最多可有4000个IP。</p><h1 id="3901" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">ansible-for-nsxt</h1><p id="2bea" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">这里使用的模块是官方VMware ansible-for-nsxt repo的一个分支。所有新功能都已通过拉取请求提交回VMware，如果模块被接受，本教程将更新以引用VMware repo。</p><p id="05d5" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">环境设置</p><ul class=""><li id="3c94" class="lj lk hi ju b jv le jz lf jf ly jj lz jn ma km lo lp lq lr bi translated">假设您已经有了一个工作的NSX-T环境，最好是2.4或2.3版本。</li><li id="93f8" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">你需要一个Ansible控制服务器，带Ansible 2.7。我用过香草Ubuntu 16.04。</li><li id="148c" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">(可选)YAML·林挺的好编辑。VSCode非常好，有很好的YAML扩展，远程SSH扩展允许您从非Linux系统远程编辑Ansible控制主机上的文件。</li><li id="07b4" class="lj lk hi ju b jv ls jz lt jf lu jj lv jn lw km lo lp lq lr bi translated">(可选)托管防火墙规则YAML的git存储库。</li></ul><p id="69b9" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">在您的Ansible Control服务器上，从合适的目录运行:</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="9c72" class="iu iv hi mg b fi mk ml l mm mn">git clone <a class="ae lx" href="https://github.com/laidbackware/ansible-for-nsxt/" rel="noopener ugc nofollow" target="_blank">https://github.com/laidbackware/ansible-for-nsxt/</a></span></pre><p id="eb10" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">这将创建'<a class="ae lx" href="https://github.com/laidbackware/ansible-for-nsxt/" rel="noopener ugc nofollow" target="_blank"> ansible-for-nsxt </a>'子文件夹。然后从当前文件夹创建一个名为config的新文件夹。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="a2ab" class="iu iv hi mg b fi mk ml l mm mn">mkdir config</span></pre><p id="d353" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">现在，模块和配置将是分开的，这意味着配置可以单独提交给git。您的文件夹应该按如下方式构建:</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="5307" class="iu iv hi mg b fi mk ml l mm mn">/<br/>- ansible-for-nsxt/<br/>- config/</span></pre><p id="6580" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">从这一点开始，我们将从配置目录开始工作。</p><h1 id="a460" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">规则答案示例</h1><p id="7346" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">在本例中，我们将设置一条规则，允许NSX域内的所有内容连接到Google DNS。</p><p id="b4d1" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">下面显示的part1_answers.yml文件应该保存在您刚刚创建的config目录中。</p><figure class="mb mc md me fd ij"><div class="bz dy l di"><div class="mo mp l"/></div></figure><h2 id="1495" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">IP集</h2><p id="b85a" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">在本例中，我们将Google DNS服务器设置为IP集，这样每个源都可以访问DNS。</p><h2 id="e634" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">防火墙规则部分</h2><p id="4e9c" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">由于我们希望在NSX-T控制的对象上启用此策略，因此我们希望插入一个分布式防火墙规则。幸运的是，这是默认类型的规则，我们将让规则适用于任何地方。如果需要限制规则的范围，可以使用applied_tos部分将规则应用于某些逻辑端口。Scope和applied_tos将在以后的教程中介绍。</p><p id="4cb8" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">在本例中，source字段已被省略，这意味着source将被设置为any。目标将是新的IP集，它将是一个IPv4规则。该服务被设置为DNS，这是内置的NSX服务类型之一。</p><h2 id="2efb" class="iu iv hi bd iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr bi translated">经理文件</h2><p id="9674" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">最后，将你的NSX-T管理器细节从配置中分离出来是一个很好的做法，所以创建一个名为manager.yml的单独的应答文件，用你的NSX-T管理器连接细节进行更新。有关如何托管或安全存储密码等机密信息，请参见Ansible文档。</p><figure class="mb mc md me fd ij"><div class="bz dy l di"><div class="mo mp l"/></div></figure><h1 id="c828" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">剧本</h1><p id="7f0e" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">应用这种变化需要一个相当简单的可行的剧本，因为所有的任务都是独立的。与答案一样，这应该保存在config文件夹中。请注意，答案文件是已定义的，它们将在运行时传入。</p><figure class="mb mc md me fd ij"><div class="bz dy l di"><div class="mo mp l"/></div></figure><h1 id="7a90" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">运行行动手册</h1><p id="a471" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">要从ansible-for-nsxt文件夹导入模块，需要两个环境变量指向library和module_utils文件夹。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="fca1" class="iu iv hi mg b fi mk ml l mm mn">export ANSIBLE_LIBRARY="../ansible-for-nsxt";<br/>export ANSIBLE_MODULE_UTILS="../ansible-for-nsxt/module_utils";</span></pre><p id="c22b" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">运行剧本时，使用extra-vars传入答案yaml文件，用@告诉Ansible打开一个文件。</p><pre class="mb mc md me fd mf mg mh mi aw mj bi"><span id="1c9d" class="iu iv hi mg b fi mk ml l mm mn">ansible-playbook firewall_ipsets.yml --extra-vars=<a class="ae lx" href="http://twitter.com/secrets" rel="noopener ugc nofollow" target="_blank">@m</a>anager.yml --extra-vars=<a class="ae lx" href="http://twitter.com/answers_firewall" rel="noopener ugc nofollow" target="_blank">@</a>part1_answers.yml -vvv;</span></pre><p id="7873" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated">如果一切顺利，应该会显示类似下面的输出。</p><figure class="mb mc md me fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es mq"><img src="../Images/b257c54b7ea9480810ad2fcbe5b6db57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hluBrvdFOTAcWcO0ghzb3w.png"/></div></div></figure><h1 id="6da7" class="kn iv hi bd iw ko kp kq ja kr ks kt je ku kv kw ji kx ky kz jm la lb lc jq ld bi translated">下次</h1><p id="c714" class="pw-post-body-paragraph js jt hi ju b jv jw jx jy jz ka kb kc jf kd ke kf jj kg kh ki jn kj kk kl km hb bi translated">本系列的下一篇文章将介绍NS组以及如何根据动态标准(如操作系统类型)进行分组。</p><p id="94a8" class="pw-post-body-paragraph js jt hi ju b jv le jx jy jz lf kb kc jf lg ke kf jj lh kh ki jn li kk kl km hb bi translated"><a class="ae lx" rel="noopener" href="/@laidbackware/nsx-t-security-with-ansible-pt-2-ns-groups-665edd8bac6">https://medium . com/@ laid backware/nsx-t-security-with-ansi ble-pt-2-ns-groups-665 edd 8 BAC 6</a></p></div></div>    
</body>
</html>