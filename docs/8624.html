<html>
<head>
<title>{Concise} All about handling Background tasks in iOS 14,13… and below</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">{简明}关于在iOS 14、13…及以下版本中处理后台任务的所有内容</h1>
<blockquote>原文：<a href="https://medium.com/swlh/handling-background-tasks-in-ios-13-67f717d94b3d?source=collection_archive---------0-----------------------#2019-07-19">https://medium.com/swlh/handling-background-tasks-in-ios-13-67f717d94b3d?source=collection_archive---------0-----------------------#2019-07-19</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/80dff52ca83157f1332015a3ea5c05a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S6y37HXI4pmdBruGavG45A.jpeg"/></div></div></figure><p id="e5a0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated"><code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">UIApplication</a></code> <a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">后台任务</a>机制让你可以防止你的app短时间暂停。虽然所涉及的API非常小，但仍然有许多事情需要注意:</p><ul class=""><li id="37c3" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn jy jz ka kb bi translated">名字<em class="kc">后台任务</em>多少有些挪用。具体来说，<code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">beginBackgroundTask(expirationHandler:)</a></code>实际上并不启动任何类型的后台任务，而是告诉系统<em class="kc">你</em>已经开始了一些正在进行的工作，即使你的应用程序在后台，你也想继续。您仍然需要编写代码来创建和管理这项工作。所以最好把后台任务API想象成提出一个“不要挂起我”的断言。</li></ul><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es kd"><img src="../Images/b577622f55b29ab7d9a163055832c23d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*RA6_8KspPmUMAOpS.jpg"/></div></div></figure><ul class=""><li id="ce35" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn jy jz ka kb bi translated">您必须结束开始的每个后台任务。不这样做将导致您的应用程序被看门狗杀死。出于这个原因，我建议你给你启动的每个后台任务起一个名字(通过调用<code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623051-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">beginBackgroundTask(withName:expirationHandler:)</a></code>而不是<code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">beginBackgroundTask(expirationHandler:)</a></code>)。当事情出错时，一个好的名字对于追踪问题是至关重要的。<br/> <strong class="is ki"> <em class="kc">警告</em> </strong>无法结束后台任务是iOS上后台任务问题的头号原因。这通常涉及簿记中一些容易忽略的错误，导致应用程序开始后台任务，而不是结束它。例如，您可能有一个存储当前后台任务标识符的属性(类型为<code class="du jo jp jq jr b">UIBackgroundTaskIdentifier</code>)。如果您不小心创建了第二个后台任务，并将其存储在该属性中，而没有对当前存储在那里的标识符调用<code class="du jo jp jq jr b">endBackgroundTask</code>，应用程序将“泄漏”一个后台任务，这将导致它被看门狗杀死。</li><li id="e110" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">后台任务可以以两种方式结束:<br/> a .当你的应用程序完成了它设定的任务。<br/> b .当系统调用任务的到期处理程序时。在这两种情况下，你的代码负责调用<code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1622970-endbackgroundtask" rel="noopener ugc nofollow" target="_blank">endBackgroundTask(_:)</a></code>。</li><li id="6c94" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">所有后台任务都必须有一个到期处理程序，系统可以用它来“调入”任务。后台任务API允许系统在任何时候这样做。</li><li id="231b" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">你的到期处理器是你清理东西的机会。在所有东西都被真正清理干净之前，它不应该返回。它必须运行得很快，也就是说，不到一秒钟左右。如果时间太长，你的app就会被看门狗杀死。</li><li id="772d" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">您的到期处理程序在主线程上调用。</li><li id="58dd" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">在任何线程上开始和结束后台任务都是合法的，但从辅助线程上这样做可能会很棘手，因为您必须用到期处理程序来协调这项工作，该处理程序总是在主线程上调用。</li><li id="b7ef" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">系统对使用后台任务防止暂停的总时间有严格的限制。iOS 13测试版将前台值减少到了30秒。在目前的系统上，你可以期待这样的值:<br/> a. 3分钟，当你的应用从前台移动到后台<br/> b. 30秒，当你的应用在后台恢复<br/> <strong class="is ki"> <em class="kc">警告</em> </strong>:我引用这些数字只是为了给你一个大概的概念。目标值在过去已经发生了变化，将来也很可能发生变化，而您实际获得的时间取决于系统的状态。这里要记住的是，只要您的后台任务有一个有效的到期处理程序，确切的值并不重要。</li><li id="bbfb" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">通过查看<code class="du jo jp jq jr b">UIApplication</code>的<code class="du jo jp jq jr b">backgroundTimeRemaining</code>属性，您可以粗略估计您可以使用的时间。<br/> <strong class="is ki">重要</strong>:由<code class="du jo jp jq jr b">backgroundTimeRemaining</code>返回的值是一个估计值，可以随时改变。无论返回值是什么，您都必须将应用程序设计为正常运行。使用此属性进行调试是合理的，但我们强烈建议您避免将用作应用程序逻辑的一部分。<br/> <strong class="is ki"> <em class="kc">警告</em> : </strong>基于<code class="du jo jp jq jr b">backgroundTimeRemaining</code>返回值的应用行为是iOS后台任务问题的第二大原因。</li><li id="8413" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">系统不保证<em class="kc">任何</em>后台任务的执行时间。您可能无法创建后台任务(尽管可能性不大，在下一点中会提到)。即使您设法创建了一个，也可以随时调用它的到期处理程序。</li><li id="9329" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated"><code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/uikit/uiapplication/1623031-beginbackgroundtask" rel="noopener ugc nofollow" target="_blank">beginBackgroundTask(expirationHandler:)</a></code>可以失败，返回<code class="du jo jp jq jr b">UIBackgroundTaskInvalid</code>，表明您系统无法创建后台任务。虽然这在后台任务首次引入时是一种真实的可能性，当时一些设备不支持多任务处理，但你不太可能在现代系统中看到这种情况。</li><li id="641f" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">后台时间“时钟”只有在后台任务生效时才开始滴答作响。例如，如果您在应用程序处于前台时启动后台任务，然后停留在前台，后台任务将保持休眠状态，直到您的应用程序移至后台。这有助于简化后台任务跟踪逻辑。</li><li id="20cf" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">你获得的后台执行时间是你的应用的属性，而不是后台任务本身的属性。例如，连续启动两个后台任务不会给你6分钟的后台执行时间。</li><li id="24d2" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">尽管有前面的观点，创建多个后台任务仍然是有意义的，只是为了帮助您的跟踪逻辑。例如，通常为应用程序正在完成的每个任务创建一个后台任务，在任务完成时结束任务。</li><li id="1362" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">不要创建太多的后台任务。多少才算多？创建几十个后台任务是绝对没问题的，但是创建几千个并不是一个好主意。<br/> <strong class="is ki">重要</strong> : iOS 11引入了一个进程可以拥有的后台任务断言数量的硬性限制(目前大概是1000个，但具体数值以后可能会变)。如果您看到异常代码为0xbada5e47的崩溃报告，那么您已经达到了这个极限。<br/> <strong class="is ki">注意</strong>:这里你最可能看到的实际限制是调用你的到期处理程序所花费的时间。watchdog对运行后台任务到期处理程序所用的总时间有严格的限制(几秒钟)。如果您有数千个处理程序，您很可能会遇到这个限制。</li><li id="1fa3" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">如果你在无法访问<code class="du jo jp jq jr b">UIApplication</code>(一个应用扩展或watchOS)的环境中工作，你可以使用<code class="du jo jp jq jr b"><a class="ae js" href="https://developer.apple.com/documentation/foundation/processinfo/1617030-performexpiringactivity" rel="noopener ugc nofollow" target="_blank">performExpiringActivity(withReason:using:)</a></code>达到类似的效果。</li><li id="c1d4" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">如果你的应用程序“泄露”了一个后台任务，它可能会被看门狗杀死。这会导致崩溃报告，异常代码为0x8badf00d(“吃了变质的食物”)。<br/> <strong class="is ki">重要:</strong>一个泄露的后台任务是<em class="kc">而不是</em>一个0x8badf00d崩溃的唯一原因。您应该查看主线程的回溯，看看主线程是否卡在您的代码中，例如，在同步网络请求中。然而，如果主线程在run循环中被愉快地阻塞，那么泄漏的后台任务应该是您的主要怀疑对象。</li><li id="524f" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">在iOS 11之前，任何未完成的后台任务的信息都会出现在最终的崩溃报告中(查找文本<code class="du jo jp jq jr b">BKProcessAssertion</code>)。iOS 11及更高版本不包含此信息，但您可以在系统日志中找到等效的信息。</li><li id="acca" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">您可以使用macOS上的控制台应用程序以交互方式监控设备的系统日志。系统日志也包含在sysdiagnose日志中，因此，如果您有只在现场显示的问题，您可以要求用户发送给您。有关系统诊断日志的更多信息，请参见<a class="ae js" href="https://developer.apple.com/bug-reporting/profiles-and-logs/" rel="noopener ugc nofollow" target="_blank"> <em class="kc">错误报告</em> &gt; <em class="kc">概要文件和日志</em> </a>页面。</li><li id="6c33" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn jy jz ka kb bi translated">系统日志非常嘈杂，所以给每个后台任务取一个容易找到的名字很重要。</li></ul><figure class="ke kf kg kh fd ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es ko"><img src="../Images/a847143c73042fe70e78506630982de9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NSE5SJwqrsEG594C"/></div></div></figure><ul class=""><li id="0dc9" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn jy jz ka kb bi translated">在后台启动的任务的时间限制要短得多。虽然确切的限制没有被记录下来——它在过去已经发生了变化，并且很可能在将来再次发生变化——但是如上所述，当前的值大约是30秒。事情是这样的:</li></ul><ol class=""><li id="eefc" class="jt ju hi is b it iu ix iy jb jv jf jw jj jx jn kp jz ka kb bi translated">系统会在后台恢复(或重新启动)您的应用程序，因为用户进入了您所在的地区。</li><li id="13a5" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn kp jz ka kb bi translated">你安排了一个3分钟的计时器，并启动了一个后台任务来防止应用程序被挂起。</li><li id="faf8" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn kp jz ka kb bi translated">30秒后，后台任务到期。此时会发生两种情况之一:<br/> a .如果你有一个到期处理程序，它将被调用。它必须结束后台任务，此时你的应用程序将暂停(A)。<br/> b .如果你没有到期处理程序，或者没有及时结束后台任务，看门狗会杀死你的app (B)。</li><li id="1398" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn kp jz ka kb bi translated">这意味着计时器将不会在3分钟后运行。要么你的应用被暂停(这将阻止计时器运行)，要么你的应用被终止。</li><li id="85e7" class="jt ju hi is b it kj ix kk jb kl jf km jj kn jn kp jz ka kb bi translated">这种状态会持续到用户离开您所在的区域。此时会发生两种情况:<br/> a .在情况A中，系统会在后台恢复你的应用程序。你的计时器早就该启动了，所以现在就启动。<br/> b .情况B，系统会在后台重新启动你的app。由于这是一个新过程，计时器不再存在。<br/> <strong class="is ki">重要提示:</strong>如果你想测试这个，确保从主屏幕而不是Xcode运行你的应用。Xcode调试器会停用看门狗，防止您的应用程序挂起，等等。</li></ol><p id="a005" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">务必阅读并分享！！</p><p id="2da3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">感谢奎因的《爱斯基摩人》来自苹果开发者关系的广泛和最新的评论。</p></div></div>    
</body>
</html>