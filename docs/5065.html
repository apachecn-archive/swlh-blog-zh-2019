<html>
<head>
<title>Add background jobs and cron to your dockerized ruby on rails app</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将后台作业和cron添加到dockerized ruby on rails应用程序中</h1>
<blockquote>原文：<a href="https://medium.com/swlh/add-background-jobs-and-cron-to-your-dockerized-ruby-on-rails-app-c7348915021d?source=collection_archive---------11-----------------------#2019-06-07">https://medium.com/swlh/add-background-jobs-and-cron-to-your-dockerized-ruby-on-rails-app-c7348915021d?source=collection_archive---------11-----------------------#2019-06-07</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><div class=""/><figure class="ev ex ig ih ii ij er es paragraph-image"><div role="button" tabindex="0" class="ik il di im bf in"><div class="er es if"><img src="../Images/85d65ef78757ebb255110182ccdddd08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mQXTy-yAA8i27Z3XkbRLkg.png"/></div></div></figure><p id="fe95" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在本教程中，我们将了解如何使用dealyed_job gem添加后台作业处理，以及如何使用whenever gem添加cron作业。</p><p id="7ea4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我们将使用上一篇教程中的代码，在这篇教程中，我展示了如何对现有的rails应用程序进行dockerize。你可以在这里查看<a class="ae jo" rel="noopener" href="/@ankitsamarthya/dockerize-existing-rails-5-api-with-docker-compose-yml-ce264fb87788">(</a><a class="ae jo" rel="noopener" href="/@ankitsamarthya/dockerize-existing-rails-5-api-with-docker-compose-yml-ce264fb87788?source=your_stories_page---------------------------">用docker-compose.yml </a>对现有的Ruby on Rails API进行docker化)。</p><p id="07a4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">让我们从在gem文件中添加<code class="du jp jq jr js b">gem ‘delayed_job_active_record’</code>和<code class="du jp jq jr js b">gem ‘whenever’, require: false</code>开始，然后运行</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="2081" class="kb kc hi js b fi kd ke l kf kg">$ docker-compose build</span></pre><p id="0cb3" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">构建完成后，运行以下生成器，它们将创建所需的文件。</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="909e" class="kb kc hi js b fi kd ke l kf kg">$ docker-compose run web <!-- -->rails generate delayed_job:active_record</span><span id="240f" class="kb kc hi js b fi kh ke l kf kg">Starting rails-docker_db_1 ... done<br/>Running via Spring preloader in process 27<br/>      create  bin/delayed_job<br/>       chmod  bin/delayed_job<br/>      create  db/migrate/20190320051210_create_delayed_jobs.rb</span><span id="c291" class="kb kc hi js b fi kh ke l kf kg">$ docker-compose run web <!-- -->wheneverize .</span><span id="d5a2" class="kb kc hi js b fi kh ke l kf kg">Starting rails-docker_db_1 ... done<br/>[add] writing `./config/schedule.rb'<br/>[done] wheneverized!</span></pre><p id="b928" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">然后运行<code class="du jp jq jr js b">docker-compose run web rails db:migrate</code>来运行挂起的迁移。</p><p id="0f92" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以我们已经成功地安装了宝石。现在我们将更改<code class="du jp jq jr js b">Dockerfile</code>和<code class="du jp jq jr js b">docker-compose.yml</code>来使用它。</p><p id="369e" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您的docker文件应该如下所示:</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="ki kj l"/></div><figcaption class="kk kl et er es km kn bd b be z dx">Dockerfile</figcaption></figure><p id="2971" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">注意，我们添加了第11、31和34行来安装和更新cron。我已经把不言自明的意见。</p><p id="8afa" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">你的docker-compose.yml应该是这样的:</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="ki kj l"/></div></figure><p id="bb22" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">这里我们增加了两个服务，即<code class="du jp jq jr js b">delayed_job</code>和<code class="du jp jq jr js b">cron_job</code></p><p id="5aa4" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对这些文件进行更改后，再次运行<code class="du jp jq jr js b">docker-compose build</code>。</p><p id="effc" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">所以所有的设置都完成了。我们现在将通过运行一些“重要的”控制台日志任务来测试我们的应用程序。首先创建一个rake任务。</p><p id="cead" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在lib/tasks文件夹中创建一个名为<code class="du jp jq jr js b">log_task.rake</code>的文件，内容如下:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="6597" class="kb kc hi js b fi kd ke l kf kg">desc 'log'<br/>task log_to_console: :environment do<br/>  puts "Logging to console...."<br/>end</span></pre><p id="389d" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在<code class="du jp jq jr js b">config/schedule.rb</code>中添加以下代码</p><figure class="jt ju jv jw fd ij"><div class="bz dy l di"><div class="ki kj l"/></div><figcaption class="kk kl et er es km kn bd b be z dx">config/schedule.rb</figcaption></figure><p id="4d8b" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">确保<code class="du jp jq jr js b">env :GEM_PATH, ‘/usr/local/bundle’</code>这一行在文件的顶部。</p><p id="d31c" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">每当我们在<code class="du jp jq jr js b">schedule.rb</code>中改变一些东西时，我们应该运行<code class="du jp jq jr js b">docker-compose build</code>来更新crontab文件。之后，运行<code class="du jp jq jr js b">docker-compose up</code>并检查cron docker容器中的cron.log。您可以通过运行以下命令来实现这一点:</p><pre class="jt ju jv jw fd jx js jy jz aw ka bi"><span id="72b1" class="kb kc hi js b fi kd ke l kf kg">$ docker ps<br/>CONTAINER ID        IMAGE                      COMMAND                  CREATED             STATUS              PORTS                    NAMES<br/>9d84d32aecc2        rails-docker_cron_job      "cron -f"                2 hours ago         Up 2 hours                                   rails-docker_cron_job_1</span><span id="e560" class="kb kc hi js b fi kh ke l kf kg">$ docker exec -it 9d84d32aecc2 bash<br/>root@9d84d32aecc2:/rails-docker# cat /var/log/cron.log<br/>Logging to console....<br/>Logging to console....</span></pre><p id="9395" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">您可以看到我们在日志文件中打印出了<code class="du jp jq jr js b">Logging to console….</code>，这意味着我们的cron正在工作。</p><p id="b034" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">同样，您可以开始创建作业，并将它们放入延迟作业队列，我们的应用程序将处理这些作业。</p></div><div class="ab cl ko kp gp kq" role="separator"><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt ku"/><span class="kr bw bk ks kt"/></div><div class="hb hc hd he hf"><p id="dff7" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">如果你有任何问题，请随时通过评论联系我。</p><p id="9c40" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">就是这样。您已经准备好运行后台进程和cron作业。你可以在这里(【https://github.com/ankitsamarthya/dockerized-rails】)找到所有的代码<a class="ae jo" href="https://github.com/ankitsamarthya/dockerized-rails" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="43c8" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我会继续贴这样的教程。接下来，我们将使用AWS ECS部署我们的应用程序。所以跟着我，不要错过任何东西。非常欢迎建议/反馈。</p><p id="92f0" class="pw-post-body-paragraph iq ir hi is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">编码快乐！再见。</p></div></div>    
</body>
</html>