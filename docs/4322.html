<html>
<head>
<title>Talk to the Internet with IP addresses</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用IP地址与互联网对话</h1>
<blockquote>原文：<a href="https://medium.com/swlh/talk-to-the-internet-with-ip-addresses-8f315ea28496?source=collection_archive---------33-----------------------#2019-05-30">https://medium.com/swlh/talk-to-the-internet-with-ip-addresses-8f315ea28496?source=collection_archive---------33-----------------------#2019-05-30</a></blockquote><div><div class="ds gw gx gy gz ha"/><div class="hb hc hd he hf"><figure class="hh hi ez fb hj hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es hg"><img src="../Images/024fdd9d2298365137d2822d93137891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*52MDRsmqaKCIgHfdkWuH1A.gif"/></div></div></figure><div class=""/><p id="67a5" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi jo translated">管理数百个IP地址——跨越服务器、负载平衡器、防火墙、DNS服务器、NAT网关和代理服务器——是一件令人头疼的事情，我会竭尽全力去避免。然而，本地系统的<em class="jx">关键</em>之一是积极使用IP地址来平衡、分散和管理进入您环境的流量。这些都是内置在你的硬件和软件的配置中的，每次你转头的时候，这些配置似乎都会翻倍？</p><p id="5f84" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当您展望云时——闪亮的新地平线，承诺简单和易于管理——重要的是要记住隐藏在阴影后面是一个常见的运营商挑战。你花了几年时间调整和完善的IP地址逻辑不会像边斗一样随着你的虚拟机移动，至少不会处于同一状态。它需要以各种方式进行改变，因此，<strong class="is jy">提前计划可能影响您的工作负载的IP地址变化</strong>，以及它们如何与内部和公共网络流量交互，这一点至关重要。换句话说，你不能简单地将你现有的IP地址和你的服务一起转移到云中。</p><figure class="ka kb kc kd fd hk er es paragraph-image"><div class="er es jz"><img src="../Images/592cb8c5fa4095de05063cb39c06136a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/0*iIPAekr3mfULj-v4"/></div></figure><p id="dc36" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">为什么不呢？云提供商和数据中心拥有有限的IP地址池，就像一个豪华的宾果乒乓球笼，根据工作负载的要求耗尽和补充地址。<strong class="is jy">症结在于，提供商通常会重复使用之前分配的IP，以便最大限度地利用它们。</strong>这意味着您的服务将获得一个动态分配的内部/外部IP地址。默认情况下，这些地址是短暂的，这意味着如果您重新启动实例，您将丢失这些IP并接收新的IP。没错，就像在伯尼家过了一整个周末才意识到有些事情非常非常不对劲。这可能会成为比您在内部开始时更令人头疼的问题。</p><h1 id="b4cf" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">常见的解决方案</h1><p id="dbbc" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">如果你发现自己处于这种痛苦的境地，基本上有两种解决方案可供你选择:</p><ul class=""><li id="428f" class="lh li ht is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">通过使用标记而不是IP地址来定义防火墙规则</li></ul><figure class="ka kb kc kd fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lq"><img src="../Images/9d21d11b7b68c97abe9fbe7c7695d71d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2Imtdr7OI_aN_drf"/></div></div></figure><ul class=""><li id="a45e" class="lh li ht is b it iu ix iy jb lj jf lk jj ll jn lm ln lo lp bi translated">通过具有静态IP的托管负载平衡器转发流量</li></ul><figure class="ka kb kc kd fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es lr"><img src="../Images/808689060472cb6c831ea40e4adb3c97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*00H6Kqk4ITv1TTTF"/></div></div></figure><p id="a6fd" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">当然，这两种方法都可行，但是它们都有一个很大的缺点:随着你的云IP的改变，你的服务对这些IP的任何依赖都将被打破。硬编码的IP通常需要网络管理员手动更改，这意味着这可能很快变成维护的噩梦，就像修补管道中的漏洞，同时不断出现新的漏洞。</p><p id="3ce6" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">假设您在云中启动了第一台后端机器，并决定在一段时间内停止运行以节省成本。突然，当您准备让它们重新启动并运行时，您注意到您丢失了那些动态分配的IP，却发现了新的IP。现在，您需要重新配置您的本地应用程序和任何防火墙规则，以指向您的云后端的新公共IP。在大型环境中，这可能会变得令人厌倦且难以操作。</p><h1 id="3bcc" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">谷歌云IPs</h1><figure class="ka kb kc kd fd hk er es paragraph-image"><div class="er es ls"><img src="../Images/2cba46e872f0d852206023894ffd4800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1184/0*hKJDoFLxRN8_p3Yq"/></div></figure><p id="619c" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">谷歌云给你一个可靠的解决方案，保留静态IP。如果您的虚拟机关闭，当您重新启动实例时，您可以保留相同的内部和外部IP。如果您从VPC网络内部或外部将转发规则、防火墙规则或应用程序指向您的云实例IP，您无需在每次关闭实例时都重新配置IP，这让您感到轻松。如果您的工作负载依赖于一个特定的IP地址，并且您厌倦了阻止您的队友使用该IP地址，这将非常方便。<em class="jx">最精彩的部分？</em>你甚至可以将以前短暂的IP提升为静态IP，帮助你在一些地方偷工减料。</p><h1 id="164c" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">使用静态IP</h1><p id="6e7c" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">对于计算引擎，您可以为每个虚拟机分配一个内部和一个外部IP地址。对于内部和外部IP地址，您可以选择临时和静态IP。使用内部IP，Google会从您的子网范围内为您的虚拟机分配一个临时IP，除非您在您的子网范围内指定了一个内部IP。但是，如果您决定需要一个静态内部IP，您可以稍后保留一个并将其分配给您的虚拟机。</p><p id="9d6d" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">对于外部IP，同样适用。除非你给你的虚拟机分配一个保留的静态外部IP，否则Google会从池中随机分配一个临时的外部IP。或者，您可以选择不分配任何公共IP，这有助于降低安全风险并防止实例暴露于公共互联网。同样，您可以稍后分配一个静态外部IP。如果您想保留内部IP，也可以创建自定义外部IP，这样可以避免重新映射依赖的应用程序。<em class="jx">只要记住，没有分配给实例的静态外部IP</em><a class="ae lt" href="https://cloud.google.com/compute/pricing#ipaddress" rel="noopener ugc nofollow" target="_blank"><em class="jx">会产生一个小成本</em> </a> <em class="jx">。</em>这有助于为需要IP的实例保留IP。</p><h1 id="9775" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">内部/外部IP设置</h1><p id="db30" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">让我们看一下内部/公共IP设置:</p><figure class="ka kb kc kd fd hk"><div class="bz dy l di"><div class="lu lv l"/></div></figure><h2 id="1b9f" class="lw kf ht bd kg lx ly lz kk ma mb mc ko jb md me ks jf mf mg kw jj mh mi la mj bi translated">使用私有IP以获得更好的性能</h2><p id="08b7" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">在上面的视频中，我提到了使用内部IPs提高网络性能的巨大优势:</p><figure class="ka kb kc kd fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mk"><img src="../Images/a45300672126a79226786f2ce7c7b5c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SrSd6G1goahjI-jN"/></div></div><figcaption class="ml mm et er es mn mo bd b be z dx">No public transport needed for VM communication within a Google VPC</figcaption></figure><p id="3b28" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">使用内部IPs时，与其他内部虚拟机通信的内部虚拟机具有最佳网络性能。否则，您的内部虚拟机的流量必须通过公共IP返回到公共互联网，这会降低速度。例如，维护同一个VPC网络上的数据库服务器和web服务器之间的内部流量，或者将<a class="ae lt" href="https://cloud.google.com/vpc/docs/private-access-options" rel="noopener ugc nofollow" target="_blank">私有Google Access </a>与Google APIs和服务一起使用。</p><p id="500a" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">另一方面，如果您需要虚拟机与公共互联网或不同VPC网络中的虚拟机通信，您的虚拟机必须有一个公共IP地址，除非您已经设置了到其他网络的代理或VPN。我进行了一项测试，以了解在相同的VPC中使用内部IP和外部IP时的性能差异。</p><figure class="ka kb kc kd fd hk er es paragraph-image"><div role="button" tabindex="0" class="hl hm di hn bf ho"><div class="er es mp"><img src="../Images/bc8ca060ae9c16144c799bb7d2d0e737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-dQ-6JM23R9lExlmcNOKug.png"/></div></div></figure><p id="b498" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">我发现，当您在各种机器类型之间使用内部IPs时，TCP吞吐量性能的变化较小，而Mbps吞吐量要高得多。</p><h1 id="2316" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">找到平衡</h1><p id="7805" class="pw-post-body-paragraph iq ir ht is b it lc iv iw ix ld iz ja jb le jd je jf lf jh ji jj lg jl jm jn hb bi translated">一旦您理解了IP地址是如何受到影响的，以及您的操作可能对您的整体架构产生的级联效应，您就会看到拥有可重新映射的IP地址是多么有用。如果您计划在云中部署前端服务器，这可以让您在以后的工作中避免巨大的麻烦。GCP为您提供了灵活的选项，例如将临时IP提升为静态IP、保留特定IP的能力以及通过移除外部IP来保护虚拟机的能力。<strong class="is jy">要考虑的事情太多了！</strong></p><p id="9915" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">在进行VPC对等和本地互连等操作时，当涉及到IP地址范围重叠时，有一些<a class="ae lt" href="https://cloud.google.com/vpc/docs/vpc-peering#restrictions" rel="noopener ugc nofollow" target="_blank">警告</a>，但我将留给您这个:<em class="jx">规划IP范围和使用是您应该明确规划的第一件事</em>，它是关于找到平衡的。创建一个更加严格和安全的IP地址拓扑结构通常意味着更少的灵活性和更多的摩擦。考虑如何创建一个具有IP范围的VPC拓扑，让您可以自由扩展，尽可能开放，同时仍然安全。考虑因素包括:生产与测试环境、对等和本地IP范围预留，以及通过使用不可路由的IP来节省您的IP空间。这是一个挑战，像谷歌这样的SDN领导者正在重新定义和<a class="ae lt" href="https://cloud.google.com/solutions/best-practices-vpc-design" rel="noopener ugc nofollow" target="_blank">使之更容易接近</a>，以便您可以尽快开始。</p><h1 id="153e" class="ke kf ht bd kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb bi translated">现在怎么办？</h1><ol class=""><li id="e640" class="lh li ht is b it lc ix ld jb mq jf mr jj ms jn mt ln lo lp bi translated">点击深入了解IP地址<a class="ae lt" href="https://cloud.google.com/compute/docs/ip-addresses" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="034d" class="lh li ht is b it mu ix mv jb mw jf mx jj my jn mt ln lo lp bi translated">订阅<a class="ae lt" href="https://www.youtube.com/user/googlecloudplatform" rel="noopener ugc nofollow" target="_blank"> GCP Youtube频道</a>并关注我的视频系列<a class="ae lt" href="https://www.youtube.com/playlist?list=PLIivdWyY5sqJ0oXcnZYqOnuNRsLF9H48u" rel="noopener ugc nofollow" target="_blank">端到端联网</a>。</li><li id="5cb8" class="lh li ht is b it mu ix mv jb mw jf mx jj my jn mt ln lo lp bi translated">想要更多内容？在<a class="ae lt" href="https://twitter.com/swongful" rel="noopener ugc nofollow" target="_blank">推特</a> @swongful上关注我。</li><li id="2f4b" class="lh li ht is b it mu ix mv jb mw jf mx jj my jn mt ln lo lp bi translated">查看您身边的<a class="ae lt" href="https://cloud.google.com/events/" rel="noopener ugc nofollow" target="_blank">谷歌云事件</a>。</li></ol><p id="753e" class="pw-post-body-paragraph iq ir ht is b it iu iv iw ix iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn hb bi translated">请继续关注本系列的更多内容，并感谢您和我一起开启这场揭开云网络神秘面纱的旅程。</p></div></div>    
</body>
</html>